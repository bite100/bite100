# 贡献奖励接口定义（草稿）

本文档定义：节点提交贡献证明的入参、链上校验签名与贡献分计算、以及是扩展 FeeDistributor 还是新增 ContributorReward。与 [Phase2-设计文档](./Phase2-设计文档.md) 第四节及 M4 对齐。

---

## 1. 链下证明格式（现有）

节点已按下列结构落盘/上报，**签名 payload** 为 `period + metrics` 的 JSON（与 [node 实现](../node/internal/metrics/proof.go) 一致）：

```json
{
  "nodeId": "12D3KooW...",
  "nodeType": "storage",
  "period": "2025-02-01_2025-02-07",
  "metrics": {
    "uptime": 0.95,
    "storageUsedGB": 10,
    "storageTotalGB": 100,
    "bytesRelayed": 0
  },
  "signature": "0x...",
  "timestamp": 1707292850
}
```

- **nodeId**：libp2p PeerID 字符串。  
- **nodeType**：`relay` | `storage` | `match`（撮合节点填 `match`，metrics 需含 `tradesMatched`、`volumeMatched`）。  
- **signature**：节点私钥对 **payload** 的签名；payload = `{"period":"...","metrics":{...}}` 的 UTF-8 序列化（与节点端 `GenerateProof` 一致）。  
- 链下收集时可直接用该 JSON 校验签名（需节点公钥，可从 nodeId 或注册表获取）。  
- 撮合节点示例：`nodeType: "match"`，`metrics` 中增加 `tradesMatched`（笔数）、`volumeMatched`（成交量最小单位）。

---

## 2. 链上提交证明的入参

链上需要「领奖地址」（EVM address），而当前节点身份是 libp2p 密钥（多为 Ed25519），不能直接 `ecrecover`。两种做法：

### 方案 A：领奖地址即签名者（推荐，无需注册）

- 节点在提交链上证明时，使用 **EVM 私钥**（与领奖地址对应）对 **同一逻辑 payload**（period + metrics）做 **ECDSA 签名**（与链下 Ed25519 证明可并存）。
- 链上入参建议：

| 参数名 | 类型 | 说明 |
|--------|------|------|
| `period` | `string` 或 `bytes32` | 周期，如 `"2025-02-01_2025-02-07"`；若 `bytes32` 则取 period 字符串的 keccak256 |
| `uptime` | `uint256` | 放大后的 uptime，如 `uptime * 1e18`，范围 [0, 1e18] |
| `storageUsedGB` | `uint256` | 存储节点：已用容量 GB（定点或整数） |
| `storageTotalGB` | `uint256` | 存储节点：总容量 GB，0 表示不参与存储分 |
| `bytesRelayed` | `uint256` | 中继节点：转发字节数 |
| `tradesMatched` | `uint256` | 撮合节点：周期内撮合成交笔数（仅 submitProofEx） |
| `volumeMatched` | `uint256` | 撮合节点：周期内撮合成交量/最小单位（仅 submitProofEx） |
| `liquidityAmount` | `uint256` | 流动性提供者：流动性数量（以稳定币计价，仅 submitLiquidityProof） |
| `nodeType` | `uint8` | 0=relay, 1=storage, 2=match（撮合）, 3=liquidity（流动性） |
| `signature` | `bytes` | ECDSA 签名：**submitProof** 对 `keccak256(abi.encodePacked(period, uptime, storageUsedGB, storageTotalGB, bytesRelayed, nodeType))`；**submitProofEx** 对 `keccak256(abi.encodePacked(..., tradesMatched, volumeMatched, nodeType))`；**submitLiquidityProof** 对 `keccak256(abi.encodePacked(period, liquidityAmount, nodeType=3))`，且 `erecover(...) == msg.sender` |

- **领奖地址**：`msg.sender`，即提交交易者必须为领奖账户（或经 EIP-2771 等委托）。
- 优点：无需链上注册 nodeId；节点只需保管一个 EVM 私钥用于领奖。  
- 节点端：链下证明仍用 libp2p 密钥（Ed25519）落盘/链下收集；链上提交时用 EVM 密钥再签一份上述 payload 并调用合约。

### 方案 B：nodeId + 注册领奖地址

- 链上维护 `nodeIdHash => claimAddress` 的注册表；节点先注册，再提交证明。
- 证明签名仍为 **Ed25519**（与现有节点一致），链上需 **Ed25519 验签**（预编译或外部库）；验证通过后，用注册的 `claimAddress` 作为领奖方。
- 优点：节点身份与链上身份解耦；缺点：需实现/接入 Ed25519 验签，Gas 与复杂度更高。

**建议**：Phase 2 采用 **方案 A**，接口简单、无需 Ed25519 链上验签；若后续强需求「一个 nodeId 对应多地址」再考虑方案 B 或混合（链下 Ed25519 证明 + 链上 ECDSA 提交绑定 claimAddress）。

---

## 3. 链上校验与贡献分计算

### 3.1 校验

1. **签名**：`ecrecover(keccak256(abi.encodePacked(period, uptime, storageUsedGB, storageTotalGB, bytesRelayed, nodeType)), signature) == msg.sender`。  
2. **周期**：只接受当前或已结束的周期（如 `periodEnd <= block.timestamp` 或由合约维护「已开放提交」的周期列表）。  
3. **防重放**：同一 `(msg.sender, period)` 仅接受一次提交（覆盖或拒绝重复）。  
4. **数值范围**：uptime ≤ 1e18，storage/bytes 在合理上界内（可由合约常量限制）。

### 3.2 贡献分公式（单周期、标量）

将 uptime、storage、bytes relayed 合并为单一 **contributionScore**（建议 1e18 精度），便于「周期内总量固定、按贡献分」分配：

- **基础式**（可配置权重，以下为示例）：  
  `score = wU * uptime + wS * min(storageUsedGB / capS, 1e18) + wR * min(bytesRelayed / capR, 1e18)`  
  - `uptime`：已为 [0, 1e18]。  
  - 存储项：`storageUsedGB` 与 `capS`（如 1000 GB）取小再归一，再乘 1e18。  
  - 中继项：`bytesRelayed` 与 `capR`（如 1e12 字节）取小再归一，再乘 1e18。  
  - `wU + wS + wR` 可等于 1e18，或各自为权重系数由合约/owner 配置。

- **按节点类型与 40/25/20/15 权重**（更新：撮合 40%、存储 25%、流动性 20%、中继 15%）：  
  - **relay**（nodeType=0）：仅 uptime + bytesRelayed，贡献分乘以权重 **15**。  
  - **storage**（nodeType=1）：uptime + storage 项，贡献分乘以权重 **25**。  
  - **match**（nodeType=2）：uptime + 撮合项（tradesMatched/volumeMatched 归一化），贡献分乘以权重 **40**；需使用 **submitProofEx** 并传入 tradesMatched、volumeMatched。
  - **liquidity**（nodeType=3）：流动性注入，贡献分乘以权重 **20**；需使用 **submitLiquidityProof** 并传入流动性数量。

- 合约内：`submitProof(...)` 在通过校验后计算 `score`，并累加：  
  `period => (totalScore += score; contributorScores[period][msg.sender] = score)`（同一 period 同一 sender 仅保留最后一次或首次，由业务定）。

---

## 3.3 奖励池与兑换规则（稳定币计价、多币种按兑换时价值兑换）

- **贡献周期与领取**（与 [Phase3 §5.2](./Phase3-设计文档.md#52-结算周期) 一致）：**贡献周期 7 天**（UTC 自然周）；**结算滞后一周**——当周产生的贡献对应**下一周**的奖励池（当周手续费收入作为下周可分配池）；节点在**周期结束后**提交证明，从该周期可分配池中按贡献分占比 **claim**；支持**多币种领取**。**领取限制**：**每次领取不超过该周期奖励池的 10%**，可多次领取直到领完应得部分。**领取截止**：Owner 可为周期设置结束时间（`setPeriodEndTimestamp(periodId, endTimestamp)`）；**周期结束超过 14 天**后链上禁止领取，未领取不再发放（`claimReward` revert，`claimable` 返回 0）；**未设置结束时间的周期不校验**（兼容旧数据，**可自由流通，随时领取**）。**上线奖励**：开发者上线奖励 5 万贡献分（周期 "launch"）未设置结束时间，可自由流通，不受时间限制。
- **按信誉分分配**（可选）：如果启用 `useReputationWeighting = true`，奖励按照（贡献分 × 信誉分数/10000）进行分配。信誉分数越高，获得的奖励份额越多。详见 [信誉机制说明](./信誉机制说明.md)。
- **结算滞后一周**：本周获得的贡献对应**上一周**的结算；奖励池价值及各币种对稳定币的价值均按**上一周**核算（贡献周期与结算/计价周期错后一周）。
- **每周奖励来源**：当周手续费收入，**价值换算成稳定币**作为当周奖励池的「价值总量」；**不做实际货币兑换**，仅用稳定币作为计价单位。
- **储备比例**：奖励池**保留一定比例的储备**（如 10%～20% 不参与当周分配），用于应对波动、协议发展或应急；仅「可分配部分」参与当周每份贡献价值的计算。合约中 `reserveBps`（如 1500=15%），可分配额 = `pool * (10000 - reserveBps) / 10000`，领取与 `claimable` 均基于可分配额计算；储备部分留在合约内不参与当周分配。
- **每份贡献价值**：**当周可分配奖励池价值（稳定币）÷ 当周各节点贡献之和** = 每单位贡献对应多少稳定币价值。
- **兑换方式**：节点用贡献兑换奖励池内的**各种货币**（如 USDC、ETH、项目代币等）。兑换时按**该币种在兑换时刻对稳定币的价值**换算：
  - 节点应得 = 自己的贡献 × 每份贡献价值（稳定币）；
  - 若选择用代币 A 领取，则领取数量 = 应得稳定币价值 ÷ 代币 A 在**兑换时**的稳定币单价。
- **价值基准与锁定**：每周的贡献价值**只能按当周各币种对稳定币的平均价格**核算；兑换时（含日后任何时刻）**只能领取价值等于该周核算额度的资产**，应得额度固定、不可超额，只能兑换「这些价值」对应的货币。
- **结算时价格的计算（避免周末单点波动）**：奖励池及各币种在周末结算时若只取某一时刻价格，可能因波动导致价值相差巨大。采用**按日去极值再周平均**：对每个自然日，先去掉该日采样价中**最高的 5%** 与**最低的 5%**，对剩余价格取算术平均得到该日「日均价」；再对当周各日的日均价取**算术平均**，作为当周「平均价格」用于结算。
- **自由流动额度**：允许**当周奖励的一定比例**（默认 10%）自由流动到以后周期；该部分可按**兑换时**的市场价值兑换货币，不受当周平均价格锁定。该比例**可通过治理投票增加或减少**（如投票决定上调至 15% 或下调至 5%）。当前合约实现中 `freeFlowBps` 已预留，可分配额与领取逻辑已按 `reserveBps` 扣减储备；自由流动「按兑换时价格」需接入预言机或链下价格服务后扩展 `claimReward`。
- **合约实现**：当前 ContributorReward 为「按周期、按代币设池」的简化版（`setPeriodReward(period, token, amount)` 每币种单独注入）。后续可扩展为：周期只记录「奖励池总价值（稳定币）」与各币种余额，领取时传入目标代币，由预言机或链上价格取**兑换时**该代币对稳定币价格，计算可领数量并扣减该币种池余额。
- **自由流动比例治理**：`freeFlowBps`（自由流动比例，如 1000 表示 10%）可通过**治理投票**调整；投票通过后由合约执行 `setFreeFlowBps(uint16)`，上限可由合约或治理约定（如 5%～30%）。
- **提案通过规则**：**最近活跃人员**（过去 2 周内有 `submitProof`，不统计投票）中，**同意超过 50%** 即通过。细则见 [概念设计文档 §4.4](./概念设计文档.md#44-治理提案规则)。

---

## 4. 扩展 FeeDistributor 还是新增 ContributorReward

| 维度 | FeeDistributor（现有） | ContributorReward（新增） |
|------|------------------------|---------------------------|
| 用途 | 手续费按 **固定比例** 分给若干账户 | **按周期、按贡献** 分配固定总量 |
| 分配依据 | owner 设置 `recipients[]` 与 `shareBps` | 每周期各节点提交证明，合约按贡献分占比分配 |
| 数据 | 只存 token、accumulated、claimed | 需存 period、每地址 contributionScore、周期总池与已发 |
| 结算时机 | 任意时刻 claim 应得份额 | 周期结束后（或 owner 触发）按该周期汇总后 claim |

**结论**：

- **不扩展 FeeDistributor**：其语义是「固定比例分手续费」，与「周期内总量固定、按贡献动态分」不一致；若强行扩展会混入两套逻辑，不利于维护。
- **新增 ContributorReward 合约**（推荐）：
  - 职责单一：接收贡献证明、按周期汇总贡献分、按 4.3 分配规则发放该周期固定总量。
  - 与 FeeDistributor 并列：手续费仍走 FeeDistributor；节点贡献奖励走 ContributorReward；未来可由同一笔资金先入某池再按比例注入两合约。

### ContributorReward 接口草案（核心）

```solidity
// 提交证明（方案 A：msg.sender 为领奖地址）
// 旧版：relay/storage 用此接口，digest 不含 tradesMatched/volumeMatched
function submitProof(
    string calldata period,
    uint256 uptime,           // e.g. [0, 1e18]
    uint256 storageUsedGB,
    uint256 storageTotalGB,
    uint256 bytesRelayed,
    uint8 nodeType,          // 0=relay, 1=storage
    bytes calldata signature
) external;

// 扩展版：撮合节点（nodeType=2）必须用此接口，传入 tradesMatched、volumeMatched
function submitProofEx(
    string calldata period,
    uint256 uptime,
    uint256 storageUsedGB,
    uint256 storageTotalGB,
    uint256 bytesRelayed,
    uint256 tradesMatched,
    uint256 volumeMatched,
    uint8 nodeType,          // 0=relay, 1=storage, 2=match
    bytes calldata signature
) external;

// 周期结束后：由 owner 注入该周期奖励池（或事先约定）
function setPeriodReward(string calldata period, address token, uint256 amount) external onlyOwner;

// 结算周期：汇总该 period 所有有效证明，计算 totalScore 与各地址 score（若未汇总则先调用 finalizePeriod）
function finalizePeriod(string calldata period) external; // 或由 submit 自动在周期结束后触发

// 领取：某周期内我的份额 = periodReward[period][token] * myScore[period] / totalScore[period]
function claimReward(string calldata period, address token) external;
function claimable(string calldata period, address token, address account) external view returns (uint256);

// 查询贡献分（可选）
function getContributionScore(string calldata period, address account) external view returns (uint256);
function getPeriodTotalScore(string calldata period) external view returns (uint256);

// 自由流动比例治理（可投票调整）
function setFreeFlowBps(uint16 _freeFlowBps) external onlyGovernance; // 如 1000=10%，范围可限 500~3000
function freeFlowBps() external view returns (uint16);
```

### 治理合约接口草案（Governance）

**任何链上可执行操作**均可提案表决（手续费、上币、流通链、合约升级等）：

```solidity
uint8 constant ACTIVE_WEEKS = 2;
uint constant VOTING_PERIOD = 7 days;
uint constant COOLDOWN_PERIOD = 7 days;  // 同一 (target, callData) 执行后一周内不可再创建

function createProposal(address target, bytes calldata callData, bytes32 merkleRoot, uint256 activeCount) external returns (uint256 proposalId);
function vote(uint256 proposalId, bool support, bytes32[] calldata proof) external;  // 仅活跃集内地址可投，需默克尔证明
function execute(uint256 proposalId) external;  // 通过条件：yesCount > activeCount/2
function isInActiveSet(uint256 proposalId, address account, bytes32[] calldata proof) external view returns (bool);
```

- 上币：目标合约为 TokenRegistry（或等价白名单），callData = addToken(tokenAddr) 等。
- 流通链：目标合约为跨链/多链配置，callData = addChain(chainId) / removeChain 等。

- **周期标识**：`period` 用字符串与链下一致（如 `"2025-02-01_2025-02-07"`），链上以 `bytes32(keccak256(abi.encodePacked(period)))` 作 key 亦可。  
- **防重放**：`submitted[period][msg.sender]` 为 true 后不再接受该 period 的重复提交（或仅允许覆盖更新该 period 的 score，以最后一次为准）。

---

## 5. 与链下的一致性

- **链下**：继续使用现有 JSON 证明（nodeId、Ed25519 签名）、落盘与链下收集；分配规则按 4.3 用「贡献值」比例计算，与链上公式一致（同一权重与 cap）。  
- **链上**：仅对「需要链上领奖」的节点要求额外 ECDSA 签名与 `submitProof` 入参；链下审计/统计仍可只认 Ed25519 证明与 nodeId。

---

## 6. 文档与实现顺序

- 本文档为 **接口定义草稿**，实现时以合约注释与最终代码为准。  
- **已实现**：  
  1. **合约**：`contracts/src/ContributorReward.sol`，含 `submitProof`（兼容 relay/storage）、`submitProofEx`（含撮合 tradesMatched/volumeMatched、nodeType=2）；贡献分按 **40/25/15** 权重（撮合/存储/中继）；`setPeriodReward`、`claimReward` / `claimable`、`getContributionScore` / `getPeriodTotalScore`；**按信誉分分配**：`setReputationWeighting`、`setReputationScore`、`setReputationThreshold` 等。部署脚本 `runContributorReward()`。  
  2. **节点端**：`node/internal/metrics` 证明含 `tradesMatched`、`volumeMatched`（撮合节点）；`node/internal/reward` 包（Digest/DigestEx、EncodeSubmitProof/EncodeSubmitProofEx、BuildSignedCalldata 自动选 submitProof 或 submitProofEx）；`node/cmd/submitproof`：读证明 JSON，用 EVM 私钥签名并发送交易。用法：`go run ./cmd/submitproof -proof <path> -contract <addr> -rpc <url> -key <hex>` 或环境变量 `REWARD_ETH_PRIVATE_KEY`。  
  3. **周期与领取**：贡献周期 7 天（UTC 自然周）、结算滞后一周、周期结束后提交证明、多币种领取与 [Phase3 §5.2](./Phase3-设计文档.md#52-结算周期) 及概念文档一致。  
  4. 部署与测试网验证后，在 [Phase2-设计文档](./Phase2-设计文档.md) 与 [API-接口说明](./API-接口说明.md) 中链到本接口并勾选 M4 对应项。
