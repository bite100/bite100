# P2P 节点部署说明

适用于 Phase 2 节点软件（存储节点 / 中继节点 / 撮合节点）的安装、配置与上线。详细用法与验收见 [node/README.md](../node/README.md)。

**重要**：**中继/撮合节点入网无任何条件**，无需白名单、无需质押、无需邀请，任何节点都可以自由加入网络。只需配置并启动即可。

---

## 1. 安装方式

### 1.1 Docker（推荐，无需安装 Go）

```bash
cd node
docker build -t p2p-node .
docker run -it --rm -p 4001:4001 p2p-node
```

- 镜像内默认工作目录含 `config.yaml` 时会被读取；需持久化数据时挂载卷，例如：  
  `-v $(pwd)/data:/app/data`（Linux/macOS）或 `-v %cd%\data:/app/data`（Windows CMD）。

### 1.2 一键脚本（自动选择 Docker 或 Go）

- **Windows**：`cd node` 后执行 `.\run.ps1`；可加 `-port 4002`、`-connect <multiaddr>` 等。
- **Linux / macOS**：`chmod +x run.sh && ./run.sh`，同样支持 `-port`、`-connect`。

### 1.3 Go 源码

- 需安装 Go 1.19+。
- 在仓库根目录或 `node` 目录执行：
  - `go mod tidy`
  - `go build -o node ./cmd/node` 或 `go run ./cmd/node`
- 可通过 `-config`、`-port`、`-connect` 等传参，见 node/README。

---

## 2. 配置

- 将 `node/config.example.yaml` 复制为 `config.yaml`（或自定义路径，通过 `-config <path>` 指定）。
- 主要项：
  - **node.type**：`storage`（存储节点）或 `relay`（中继节点）。
  - **node.data_dir**：数据与密钥目录，如 `./data`。
  - **node.listen**：监听地址，如 `/ip4/0.0.0.0/tcp/4001`。
  - **network.bootstrap**：Bootstrap 节点 multiaddr 列表（见下）。
  - **network.topics**：订阅的 GossipSub topic，为空则使用默认 topic。
  - **storage.retention_months**：仅存储节点，0=两周，>0=保留月数。
  - **metrics.proof_period_days**、**metrics.proof_output_dir**：贡献证明周期与落盘目录（M3）。

---

## 3. Bootstrap 列表

- 新节点需要至少一个可达的 Bootstrap 节点才能加入网络。
- 在 `config.yaml` 的 `network.bootstrap` 中填写 multiaddr，例如：
  ```yaml
  network:
    bootstrap:
      - /ip4/1.2.3.4/tcp/4001/p2p/12D3KooW...
  ```
- 将 `1.2.3.4` 换成公网 IP 或域名，`12D3KooW...` 换成该节点的 PeerID（启动时日志会打印）。
- 建议：项目方或社区先部署 1～2 个长期在线的节点，将其 multiaddr 写入文档或默认配置，供新节点使用。

---

## 4. 防火墙与端口

- 节点默认监听 **TCP 4001**（可在配置或 `-port` 中修改）。
- 若希望被外网连接或作为 Bootstrap，需在服务器/路由器开放对应端口（如 4001/tcp）。
- 仅作为客户端连接他人时，可不开放端口，但无法被其他节点主动发现，需通过 `-connect` 指定对端。

---

## 5. 与 Phase 2 设计的关系

- 部署文档对应 [Phase2-设计文档](./Phase2-设计文档.md) **M4** 中的「节点部署文档：安装、配置、Bootstrap 列表、防火墙建议」。
- 贡献证明与 24 小时验收见 node/README 的 M3 小节。
