# 比特100 项目 - 生产级部署（单节点中枢 + 可选前端 + Prometheus 监控 + Watchtower 自动更新）
# 用法: docker compose -f docker-compose.prod.yml --env-file .env up -d
# 启用监控: docker compose -f docker-compose.prod.yml --profile monitoring up -d
# 详见 docs/部署与使用说明.md、docs/主网上线与优化总览.md

version: '3.9'

services:
  p2p-node:
    build: ./node
    image: p2p-node:latest
    container_name: p2p-node-hub
    restart: unless-stopped
    ports:
      - "4001:4001"   # libp2p P2P（对外暴露供其他节点连接）
      - "8080:8080"   # WebSocket + HTTP API（前端连此）
    environment:
      - NODE_TYPE=match
      - API_LISTEN=:8080
      - NETWORK=${NETWORK:-sepolia}
      - SEPOLIA_RPC_URL=${SEPOLIA_RPC_URL:-https://ethereum-sepolia.publicnode.com}
      - REWARD_WALLET=${REWARD_WALLET:-}
      - BOOTSTRAP_NODES=${BOOTSTRAP_NODES:-}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    volumes:
      - node-data:/app/data
      - ./node/config.yaml:/app/config.yaml
    command: ["-config", "/app/config.yaml"]
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - p2p-network

  # 可选：本地开发前端（连容器内 node WS）
  frontend-dev:
    build: ./frontend
    ports:
      - "5173:5173"
    environment:
      - VITE_P2P_WS_URL=ws://p2p-node:8080/ws
      - VITE_P2P_API_URL=http://p2p-node:8080
      - VITE_NETWORK=${NETWORK:-sepolia}
    depends_on:
      p2p-node:
        condition: service_healthy
    command: npm run dev
    profiles:
      - dev
    networks:
      - p2p-network

  # Prometheus 监控（抓取 p2p-node /metrics：p2p_match_trades_total、p2p_match_latency_seconds）
  prometheus:
    image: prom/prometheus:v2.47.0
    container_name: p2p-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    depends_on:
      p2p-node:
        condition: service_healthy
    profiles:
      - monitoring
    networks:
      - p2p-network

  # Grafana 监控仪表板（数据源 Prometheus，预置 P2P 节点仪表板）
  grafana:
    image: grafana/grafana:10.2.0
    container_name: p2p-grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=${GRAFANA_ROOT_URL:-http://localhost:3000}
      - GF_INSTALL_PLUGINS=
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
    profiles:
      - monitoring
    networks:
      - p2p-network

  # 自动更新镜像（每小时检查，更新后重启容器）
  watchtower:
    image: containrrr/watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --interval 3600 --cleanup
    restart: unless-stopped
    profiles:
      - watchtower
    networks:
      - p2p-network

volumes:
  node-data:
  prometheus-data:
  grafana-data:

networks:
  p2p-network:
    driver: bridge
