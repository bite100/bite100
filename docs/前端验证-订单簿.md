# 前端订单簿本地验证

按以下步骤在本地起节点 API 与前端，手动验证订单簿、下单、撤单、成交与结算状态。

## 1. 节点配置

确保 `node/config.yaml` 中已开启 API 并包含订单/成交主题：

```yaml
api:
  listen: ":8080"

network:
  topics:
    - /p2p-exchange/sync/trades
    - /p2p-exchange/sync/orderbook
    - /p2p-exchange/order/new
    - /p2p-exchange/order/cancel
    - /p2p-exchange/trade/executed
```

当前仓库 `node/config.yaml` 已包含上述配置；节点类型为 **storage**（有 DB，可持久化订单与成交）。

## 2. 启动节点（终端一）

```powershell
cd D:\P2P\node
go run ./cmd/node -config config.yaml
```

看到类似输出即表示 API 已监听：

```
[api] 监听 :8080
```

可选：用浏览器访问 http://localhost:8080/api/health 应返回 `{"ok":true}`；http://localhost:8080/api/node 应返回 `{"nodeType":"storage"}`。

## 3. 启动前端（终端二）

```powershell
cd D:\P2P\frontend
$env:VITE_NODE_API_URL="http://localhost:8080"
npm run dev
```

浏览器打开 Vite 给出的地址（通常 http://localhost:5173）。

## 4. 验证步骤

1. **连接钱包**  
   点击「连接钱包」，切到 Sepolia（或当前配置网络）。

2. **订单簿**  
   - 在「链下订单簿」区域应看到交易对 TKA/TKB、卖盘 Asks / 买盘 Bids 表格（初始可为空）。  
   - 若显示「请配置节点 API 地址」，说明 `VITE_NODE_API_URL` 未生效，请确认在启动 `npm run dev` 的终端里已执行 `$env:VITE_NODE_API_URL="http://localhost:8080"` 后再启动。

3. **下限价单**  
   - 选择「买入」或「卖出」，输入价格（如 `1.5`）、数量（如 `10`），点击「买入」或「卖出」。  
   - 钱包弹窗签名后，订单应提交成功；刷新或等待自动刷新后，在「我的订单」和订单簿中应能看到该订单。

4. **撤单**  
   - 在「我的订单」中找到状态为 open/partial 的订单，点击「撤单」并签名。  
   - 成功后该订单状态变为 cancelled 或从列表中消失。

5. **最近成交**  
   - 「最近成交」表格显示该节点 DB 中的成交记录；单节点无撮合时多为空，有撮合节点并产生成交后会显示，且「结算」列会显示「已上链」或「待结算」。

6. **节点类型**  
   - 订单簿区域提示中应显示「节点类型：存储」（当前 config 为 storage）。

## 5. 故障排查

| 现象 | 可能原因 | 处理 |
|------|----------|------|
| 订单簿区域提示「请配置节点 API 地址」 | 前端未读到 `VITE_NODE_API_URL` | 在启动 `npm run dev` 的终端先执行 `$env:VITE_NODE_API_URL="http://localhost:8080"` 再执行 `npm run dev` |
| 订单簿/我的订单一直加载或报错 | 节点未启动或未开 API | 确认节点已启动且日志有 `[api] 监听 :8080`，浏览器可访问 http://localhost:8080/api/health |
| 下单后订单簿/我的订单无数据 | 节点未订阅 order/new 或未持久化 | 确认 config 中 topics 含 `/p2p-exchange/order/new`，节点类型为 storage |
| CORS 报错 | 节点 API 未允许跨域 | 当前实现已设置 `Access-Control-Allow-Origin: *`，若仍报错请检查是否连错端口或代理 |

## 6. 可选：撮合节点 + 存储节点

若需验证「成交」与「结算状态」：

- 启动一个 **match** 节点（config 中 `node.type: match`、`api.listen: ":8080"` 或另一端口如 `:8081`），并订阅 order/new、order/cancel、trade/executed。  
- 前端将 `VITE_NODE_API_URL` 指向撮合节点（如 `http://localhost:8081`），订单簿为实时撮合盘口，下单后可能产生成交；成交记录在撮合节点内存，存储节点若也收到 trade/executed 会持久化，前端连存储节点时可看到「最近成交」。

当前单节点（storage + API）验证以上 1–4 步即可。
