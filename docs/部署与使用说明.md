# 部署与使用说明

本文档说明如何在 Sepolia 测试网部署合约、配置前端，以及治理与日常使用流程。合约地址以 [API-接口说明](./API-接口说明.md) 为准。

---

## 一、环境准备

### 1.1 依赖

- **Foundry**（合约）：[getfoundry.sh](https://getfoundry.sh/)（`forge`、`cast`）
- **Node.js 18+**（前端）：[nodejs.org](https://nodejs.org/)
- **Go 1.21+**（可选，治理用 merkletool）：[go.dev](https://go.dev/dl/)

### 1.2 合约环境变量

在 `contracts` 目录下：

```powershell
cd contracts
copy .env.example .env
# 编辑 .env：
# PRIVATE_KEY=0x你的钱包私钥（部署与 owner 操作均用此密钥）
# 可选：SEPOLIA_RPC_URL=https://ethereum-sepolia.publicnode.com
```

- 部署与调用需 Sepolia 测试 ETH（水龙头见 [sepoliafaucet.com](https://sepoliafaucet.com/) 等）。
- RPC 未设置时脚本会使用 `https://ethereum-sepolia.publicnode.com`。

---

## 二、部署顺序（Sepolia）

当前 Sepolia 已部署一套完整合约；若你从零部署或更换网络，建议顺序如下。

### 2.1 核心合约（Vault → FeeDistributor → Settlement）

```powershell
cd contracts
# 加载 .env 后执行（或使用 scripts 中的 PowerShell 脚本加载）
forge script script/Deploy.s.sol:Deploy --rpc-url "https://ethereum-sepolia.publicnode.com" --broadcast
```

会部署 Vault、FeeDistributor、Settlement，并在 Vault 上设置 Settlement。

### 2.2 Mock 代币 + AMM 池（演示用）

```powershell
forge script script/Deploy.s.sol:Deploy --sig "runWithAmmAndMocks()" --rpc-url "https://ethereum-sepolia.publicnode.com" --broadcast
```

会部署 Token A/B（Mock）和 AMMPool，并设置 FeeDistributor 接收方。

### 2.3 治理相关（ContributorReward → Governance → TokenRegistry / ChainConfig）

**一键脚本（推荐）：**

```powershell
cd contracts
.\scripts\deploy-governance.ps1
```

脚本会：

- 若未设置 `CONTRIBUTOR_REWARD_ADDRESS`，先部署 ContributorReward
- 部署 Governance，并绑定 Settlement、AMMPool、ContributorReward（若为 owner）
- 部署 TokenRegistry、ChainConfig，并设置其 Governance 地址

若非 Settlement/AMMPool 的 owner，可设 `$env:SKIP_SETTLEMENT_AMM = "1"` 仅绑定 ContributorReward。  
若链上 Settlement/AMMPool 为旧版（无 governance），见下文「重新部署 Settlement / AMMPool」。

### 2.4 重新部署 Settlement / AMMPool（含 governance 支持）

当链上已部署的 Settlement 或 AMMPool 为旧版（无 `setGovernance` / `governance()`）时，可重新部署并绑定 Governance：

```powershell
cd contracts
.\scripts\redeploy-settlement-amm.ps1
```

脚本会：

- 使用现有 Vault、FeeDistributor、Token0/1、Governance 地址
- 部署新的 Settlement、AMMPool
- 调用 Vault.setSettlement(新 Settlement)、新 Settlement.setGovernance、新 AMMPool.setGovernance
- 输出新合约地址

**必做**：将输出的 Settlement、AMMPool 地址更新到 `frontend/src/config.ts` 和 `docs/API-接口说明.md`。新 AMM 池流动性为空，需在前端或通过 cast 重新添加流动性。

---

## 三、前端配置与运行

### 3.1 配置合约地址

编辑 `frontend/src/config.ts`，确保与链上一致：

- `CHAIN_ID`：Sepolia 为 `11155111`
- `VAULT_ADDRESS`、`SETTLEMENT_ADDRESS`、`AMM_POOL_ADDRESS`、`TOKEN0_ADDRESS`、`TOKEN1_ADDRESS`
- 治理：`GOVERNANCE_ADDRESS`、`CONTRIBUTOR_REWARD_ADDRESS`、`TOKEN_REGISTRY_ADDRESS`、`CHAIN_CONFIG_ADDRESS`

地址表以 [API-接口说明](./API-接口说明.md) 为准；部署或重部署后按脚本输出更新。

### 3.2 本地运行

```bash
cd frontend
npm install
npm run dev
```

浏览器打开 **http://localhost:5173**，连接钱包并切换到 Sepolia。

### 3.3 功能说明

- **存提**：在「代币与 Vault 余额」输入 ERC20 地址或点 Token A/B 快捷填入，查询余额后可使用「存入 Vault」「从 Vault 提取」。
- **AMM Swap**：选择 TKA→TKB 或 TKB→TKA，输入数量后 Swap；池子需有流动性（见「添加流动性」）。
- **添加流动性**：在「添加流动性」中填入 Token A、Token B 数量，先授权再添加；新池需先加流动性才能 Swap。
- **治理**：查看提案列表、创建提案、投票、执行（执行需等投票期 7 天结束）。详见 [治理部署与提案执行指南](./治理部署与提案执行指南.md)。

---

## 四、治理流程摘要

1. **准备活跃地址**：将可投票地址列表写入 `node/active-addresses.txt`。
2. **生成 Merkle root 与 proof**：`go run ./cmd/merkletool -list active-addresses.txt` 得到 root 与 activeCount；`-proof-for 0x<地址>` 得到该地址的 proof。
3. **创建提案**：调用 `Governance.createProposal(target, callData, merkleRoot, activeCount)`，或在前端治理区填写目标与参数后创建。
4. **投票**：活跃集内地址调用 `vote(proposalId, support, proof)`，或在前端投票。
5. **执行**：投票期（7 天）结束后，任何人可调用 `execute(proposalId)`，或在前端执行。

详细步骤与 cast 示例见 [治理部署与提案执行指南](./治理部署与提案执行指南.md) 与 [contracts/scripts/create-proposal-example.md](../contracts/scripts/create-proposal-example.md)。

---

## 五、常用脚本与命令

| 用途 | 命令或脚本 |
|------|------------|
| 部署治理（Governance + TokenRegistry + ChainConfig，并绑定） | `contracts/scripts/deploy-governance.ps1` |
| 重新部署 Settlement、AMMPool 并绑定 Governance | `contracts/scripts/redeploy-settlement-amm.ps1` |
| 仅绑定已有 Settlement/AMMPool 到 Governance（需 owner） | `contracts/scripts/bind-settlement-amm-to-governance.ps1` |
| 设置 Sepolia 上 Settlement/AMMPool 费率 | `forge script script/Deploy.s.sol:Deploy --sig "runSetFeeBpsSepolia()" --rpc-url <rpc> --broadcast` |

---

## 六、文档索引

- [API-接口说明](./API-接口说明.md)：链配置、合约地址、接口定义
- [治理部署与提案执行指南](./治理部署与提案执行指南.md)：治理部署、创建提案、投票、执行
- [技术架构说明](./技术架构说明.md)：合约模块与数据流
- [contracts/README.md](../contracts/README.md)：合约结构、构建与测试
- [contracts/DEPLOY-SEPOLIA.md](../contracts/DEPLOY-SEPOLIA.md)：多网络部署与验证
