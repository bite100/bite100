# 桌面版钱包连接问题修复说明

## 🔧 已实施的修复

### 1. 改进扩展加载逻辑 (`electron/main.js`)

**问题**：扩展加载后没有等待初始化完成

**修复**：
- 添加详细的错误日志和扩展路径提示
- 等待扩展初始化（500ms + 1000ms）
- 在页面加载完成后检查扩展状态

### 2. 改进钱包检测 (`src/utils.ts`)

**问题**：在 Electron 中无法正确检测 `window.ethereum`

**修复**：
- 在 Electron 环境中直接访问 `window.ethereum`
- 不依赖 `WIN?.ethereum`（可能为 null）

### 3. 改进连接逻辑 (`src/App.tsx`)

**问题**：扩展注入需要时间，立即检测可能失败

**修复**：
- 添加重试机制（最多等待 2 秒，每 500ms 检查一次）
- 改进错误提示信息，包含调试信息
- 显示 `window.ethereum` 是否存在

### 4. 添加调试支持 (`electron/preload.cjs`)

**修复**：
- 添加 `electronDebug` API 用于调试
- 可以在页面中检查扩展状态

## 📋 使用说明

### 首次使用

1. **确保 MetaMask 已安装**
   - 在 Chrome 或 Edge 中安装 MetaMask
   - 确保 MetaMask 已启用

2. **启动桌面应用**
   - 运行 `P2P 交易所.exe`
   - 查看控制台日志（开发模式）

3. **连接钱包**
   - 点击"连接钱包"按钮
   - 如果失败，查看错误提示

### 排查步骤

如果仍然无法连接：

1. **检查控制台日志**：
   ```
   ✅ MetaMask 扩展已加载: ...
   ✅ MetaMask 扩展在页面中可用: ...
   ```

2. **在开发者工具中检查**：
   ```javascript
   console.log('window.ethereum:', window.ethereum)
   ```

3. **检查扩展路径**：
   - Windows: `%LOCALAPPDATA%\Google\Chrome\User Data\Default\Extensions\nkbihfbeogaeaoehlefnkodbefgpgknn`

## 🔍 调试信息

### 控制台输出

**成功加载**：
```
✅ MetaMask 扩展已加载: ...
✅ MetaMask 扩展在页面中可用: MetaMask
```

**加载失败**：
```
⚠️ MetaMask 扩展未找到
   扩展路径查找位置：
   - C:\Users\...\Chrome\User Data\Default\Extensions\...
```

### 页面中的调试

在开发者工具控制台：
```javascript
// 检查 ethereum 对象
window.ethereum

// 检查是否是 Electron
navigator.userAgent.includes('electron')
```

## ⚠️ 已知限制

1. **扩展路径依赖**：Electron 只能从 Chrome/Edge 加载扩展
2. **注入延迟**：扩展需要时间注入 `window.ethereum`（已添加重试机制）
3. **contextIsolation**：扩展注入的对象应该可用，但需要等待

## 🚀 测试建议

1. **开发模式测试**：
   ```bash
   npm run electron:dev
   ```
   - 会自动打开开发者工具
   - 可以查看控制台日志

2. **生产模式测试**：
   - 运行打包后的应用
   - 如果失败，按 `F12` 打开开发者工具（如果可用）

## 📝 相关文件

- `frontend/electron/main.js` - 扩展加载
- `frontend/electron/preload.cjs` - Preload 脚本
- `frontend/src/utils.ts` - 钱包检测
- `frontend/src/App.tsx` - 连接逻辑
- `docs/桌面版钱包连接无反应排查.md` - 详细排查指南（已放弃电脑端，仅保留供参考）

## 💡 如果问题仍然存在

1. **使用浏览器版本**：https://p2p-p2p.github.io/p2p/
2. **检查 MetaMask 版本**：确保使用最新版本
3. **重新安装 MetaMask**：在 Chrome/Edge 中重新安装
4. **查看详细排查文档**：`docs/桌面版钱包连接无反应排查.md`
