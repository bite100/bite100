# 按信誉分分配奖励示例

> 说明：当 `useReputationWeighting = true` 时，奖励按照（贡献分 × 信誉分数/10000）进行分配

---

## 一、分配公式

### 1.1 加权贡献分计算

```
加权贡献分 = 贡献分 × (信誉分数 / 10000)
```

### 1.2 奖励分配

```
我的奖励 = (可分配额 × 我的加权贡献分) / 总加权贡献分
```

其中：
- **可分配额** = 奖励池 × (10000 - reserveBps) / 10000
- **总加权贡献分** = 所有节点的加权贡献分之和

---

## 二、示例场景

### 场景 1：两个节点对比

**周期奖励池**：1000 USDC  
**储备比例**：15%（reserveBps = 1500）  
**可分配额**：1000 × (10000 - 1500) / 10000 = 850 USDC

**节点 A**：
- 贡献分：1000
- 信誉分数：8000（高信誉）
- 加权贡献分：1000 × (8000 / 10000) = 800

**节点 B**：
- 贡献分：1000
- 信誉分数：5000（中等信誉）
- 加权贡献分：1000 × (5000 / 10000) = 500

**总加权贡献分**：800 + 500 = 1300

**分配结果**：
- 节点 A 获得：850 × (800 / 1300) = **523.08 USDC**
- 节点 B 获得：850 × (500 / 1300) = **326.92 USDC**

**结论**：即使贡献分相同，信誉分数高的节点 A 获得了更多奖励（523.08 vs 326.92）。

---

### 场景 2：多个节点

**周期奖励池**：5000 USDC  
**可分配额**：4250 USDC（储备 15%）

| 节点 | 贡献分 | 信誉分数 | 加权贡献分 | 奖励份额 | 实际奖励 |
|------|--------|----------|------------|----------|----------|
| A    | 2000   | 9000     | 1800       | 45.0%    | 1912.5 USDC |
| B    | 1500   | 8000     | 1200       | 30.0%    | 1275.0 USDC |
| C    | 1000   | 6000     | 600        | 15.0%    | 637.5 USDC |
| D    | 500    | 4000     | 200        | 5.0%     | 212.5 USDC |
| E    | 300    | 3000     | 90         | 2.25%    | 95.6 USDC |
| F    | 200    | 2000     | 40         | 1.0%     | 42.5 USDC |
| G    | 100    | 1000     | 10         | 0.25%    | 10.6 USDC |
| **总计** | **5600** | - | **3940** | **100%** | **4250 USDC** |

**观察**：
1. 节点 A 虽然贡献分不是最高，但因为信誉分数最高（9000），获得了最多的奖励
2. 节点 D、E、F、G 虽然也有贡献分，但因为信誉分数较低，获得的奖励份额很小
3. 这形成了正向激励：节点会努力提高信誉分数以获得更多奖励

---

### 场景 3：信誉分数对奖励的影响

假设节点贡献分固定为 1000，比较不同信誉分数下的奖励份额：

| 信誉分数 | 加权贡献分 | 如果总加权贡献分为 5000 | 奖励份额 |
|----------|------------|------------------------|----------|
| 10000    | 1000       | 20.0%                  | 最高     |
| 8000     | 800        | 16.0%                  | 高       |
| 6000     | 600        | 12.0%                  | 中等     |
| 4000     | 400        | 8.0%                   | 低       |
| 2000     | 200        | 4.0%                   | 很低     |
| 1000     | 100        | 2.0%                   | 极低     |
| 0        | 0          | 0%                     | 无法领取 |

**结论**：信誉分数每提高 2000 分，奖励份额大约提高 4 个百分点。

---

## 三、正向激励循环

### 3.1 激励机制

1. **节点提供高质量服务** → 转发量大、违规少 → **信誉分数提高**
2. **信誉分数提高** → 加权贡献分提高 → **奖励份额增加**
3. **奖励增加** → 节点有更多资源 → **继续提供高质量服务**
4. **循环往复** → 网络整体质量提升

### 3.2 惩罚机制

1. **节点违规** → 违规次数增加 → **信誉分数降低**
2. **信誉分数降低** → 加权贡献分降低 → **奖励份额减少**
3. **奖励减少** → 节点收益下降 → **激励节点改正行为**

---

## 四、实际应用建议

### 4.1 初期配置

```solidity
// 启用按信誉分分配
contributorReward.setReputationWeighting(true);

// 设置较低的信誉阈值（允许新节点参与）
contributorReward.setReputationThreshold(1000);

// 新节点初始信誉分数建议设置为 5000（中等）
contributorReward.setReputationScore(newNodeAddress, 5000);
```

### 4.2 稳定期配置

```solidity
// 保持启用按信誉分分配
contributorReward.setReputationWeighting(true);

// 提高信誉阈值（筛选优质节点）
contributorReward.setReputationThreshold(5000);

// 根据实际表现调整节点信誉分数
// 高表现节点：8000-10000
// 中等表现节点：5000-7000
// 低表现节点：3000-4000
```

### 4.3 信誉分数更新频率

建议**每周更新一次**，与贡献周期同步：
- 周期结束后，计算节点在该周期的表现
- 更新信誉分数
- 使用 `updateReputationAndRecalculateWeightedScore` 更新相关周期的总加权贡献分

---

## 五、注意事项

1. **总加权贡献分的维护**：
   - 节点提交贡献证明时自动更新
   - 更新信誉分数时需要调用 `updateReputationAndRecalculateWeightedScore` 重新计算

2. **信誉分数的公平性**：
   - 需要多个中继节点提供数据，避免单点故障
   - 建议定期审计信誉数据来源

3. **新节点的公平性**：
   - 新节点初始信誉分数不应过低（建议 5000）
   - 可以通过治理设置新节点保护期

4. **Gas 成本**：
   - 更新信誉分数时重新计算总加权贡献分需要 Gas
   - 建议批量更新多个节点以减少 Gas 消耗

---

## 六、对比：传统分配 vs 按信誉分分配

### 传统分配（useReputationWeighting = false）

**节点 A**：贡献分 1000，信誉分数 8000 → 奖励份额：1000 / 总贡献分  
**节点 B**：贡献分 1000，信誉分数 5000 → 奖励份额：1000 / 总贡献分

**结果**：A 和 B 获得相同的奖励份额（如果贡献分相同）

### 按信誉分分配（useReputationWeighting = true）

**节点 A**：贡献分 1000，信誉分数 8000 → 加权贡献分 800 → 奖励份额：800 / 总加权贡献分  
**节点 B**：贡献分 1000，信誉分数 5000 → 加权贡献分 500 → 奖励份额：500 / 总加权贡献分

**结果**：A 获得比 B 多 60% 的奖励份额（800/500 = 1.6）

---

*本文档提供按信誉分分配奖励的详细示例和说明。*
