# 跨链功能实现指南

> 版本：v1.0  
> 更新日期：2025-02-08

---

## 一、概述

本文档说明跨链功能的实现和使用方法，包括目标链选择、多链部署、前端链切换和跨链桥接。

---

## 二、已完成功能

### 2.1 目标链选择

✅ **已明确目标链**：
- Ethereum Mainnet (Chain ID: 1)
- Base (Chain ID: 8453)
- Arbitrum (Chain ID: 42161)
- Polygon (Chain ID: 137)
- Optimism (Chain ID: 10)
- Sepolia (Chain ID: 11155111) - 已部署

### 2.2 多链配置

✅ **链配置管理** (`frontend/src/config/chains.ts`)：
- 统一的链配置接口
- 支持多链配置
- 合约地址管理

### 2.3 前端链切换

✅ **链切换组件** (`frontend/src/components/ChainSwitcher.tsx`)：
- 下拉菜单选择链
- 自动添加链到 MetaMask
- 显示链状态（已部署/待部署）

✅ **链切换 Hook** (`frontend/src/hooks/useChain.ts`)：
- 检测当前链
- 切换链逻辑
- 监听链变化

### 2.4 多链部署脚本

✅ **部署脚本**：
- `contracts/scripts/deploy-base.ps1` - Base 链部署
- `contracts/scripts/deploy-arbitrum.ps1` - Arbitrum 链部署

---

## 三、使用方法

### 3.1 前端链切换

**使用链切换组件**：

```tsx
import { ChainSwitcher } from './components/ChainSwitcher'
import { useChain } from './hooks/useChain'

function App() {
  const { currentChainId, switchChain } = useChain()
  
  return (
    <ChainSwitcher
      currentChainId={currentChainId}
      onChainChange={switchChain}
    />
  )
}
```

**切换链**：

1. 点击链切换按钮
2. 选择目标链
3. MetaMask 会提示切换链
4. 确认后，前端自动更新配置

### 3.2 多链部署

#### Base 链部署

```powershell
cd contracts

# 设置环境变量
$env:PRIVATE_KEY = "0x..."
$env:BASE_RPC_URL = "https://mainnet.base.org"
$env:BASE_TOKEN0_ADDRESS = "0x..."  # USDC
$env:BASE_TOKEN1_ADDRESS = "0x..."  # USDT

# 执行部署
.\scripts\deploy-base.ps1
```

#### Arbitrum 链部署

```powershell
cd contracts

# 设置环境变量
$env:PRIVATE_KEY = "0x..."
$env:ARBITRUM_RPC_URL = "https://arb1.arbitrum.io/rpc"
$env:ARBITRUM_TOKEN0_ADDRESS = "0x..."  # USDC
$env:ARBITRUM_TOKEN1_ADDRESS = "0x..."  # USDT

# 执行部署
.\scripts\deploy-arbitrum.ps1
```

#### 更新前端配置

部署完成后，更新 `frontend/src/config/chains.ts` 中的合约地址：

```typescript
const BASE: ChainConfig = {
  // ...
  contracts: {
    vault: '0x...',  // 更新为实际地址
    settlement: '0x...',
    // ...
  },
}
```

---

## 四、跨链桥接（待实现）

### 4.1 方案选择

**推荐方案**：使用第三方跨链桥（LayerZero、Axelar）

**原因**：
- 快速集成
- 无需维护验证节点
- 成熟的解决方案

### 4.2 集成步骤

1. **选择跨链桥**：LayerZero 或 Axelar
2. **部署跨链合约**：实现资产锁定和解锁
3. **集成前端**：添加跨链转移界面
4. **测试验证**：测试跨链资产转移

---

## 五、配置说明

### 5.1 环境变量

**Base 链**：
- `BASE_RPC_URL`：Base RPC 地址
- `BASE_TOKEN0_ADDRESS`：Token0 地址（如 USDC）
- `BASE_TOKEN1_ADDRESS`：Token1 地址（如 USDT）

**Arbitrum 链**：
- `ARBITRUM_RPC_URL`：Arbitrum RPC 地址
- `ARBITRUM_TOKEN0_ADDRESS`：Token0 地址
- `ARBITRUM_TOKEN1_ADDRESS`：Token1 地址

### 5.2 前端配置

**环境变量**（可选）：
- `VITE_CHAIN_ID`：默认链 ID（如 `8453` 表示 Base）

**链配置**：
- 编辑 `frontend/src/config/chains.ts`
- 更新各链的合约地址

---

## 六、测试

### 6.1 链切换测试

1. 连接钱包
2. 点击链切换按钮
3. 选择不同的链
4. 确认 MetaMask 提示
5. 验证前端配置更新

### 6.2 多链功能测试

1. 在 Sepolia 测试网测试基本功能
2. 切换到 Base（如果已部署）
3. 验证合约地址正确
4. 测试交易功能

---

## 七、相关文档

- [跨链功能设计](./跨链功能设计.md)
- [部署与使用说明](./部署与使用说明.md)
- [主网部署指南](./主网部署指南.md)

---

*本文档说明跨链功能的实现和使用方法，帮助用户在不同链上使用 P2P DEX。*
