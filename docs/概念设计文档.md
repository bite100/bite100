# P2P 去中心化交易所 - 概念设计文档

> 版本：v0.1  
> 更新日期：2025-02-07

---

## 文档维护原则

- **以当时修改为准**：以每次修改时的内容为当前权威；有冲突时以当时修改后的文档或代码为准。
- **随时更新设计文档**：功能、参数、阶段状态或策略有变更时，应同步更新对应设计文档（概念设计、Phase2/Phase3、技术架构、规划与路线图等），避免文档滞后。
- **文档索引**：各文档间通过链接相互引用；完整索引见 [设计文档索引](./设计文档索引.md)。

---

## 一、项目概述

### 1.1 愿景

构建一个真正去中心化的交易所，融合三大核心理念：

- **区块链去中心化**：无单一控制点，交易由智能合约执行
- **P2P 资源共享**：用户贡献闲置计算资源，类似 PCDN 模式
- **分布式团队**：远程协作，按贡献付费，能力导向

### 1.2 核心创新

| 传统 DEX | 本方案 |
|---------|--------|
| 依赖第三方节点/基础设施 | 资源由用户贡献，自给自足 |
| 数据集中存储 | 用户节点分布式保存，冗余备份 |
| 团队固定薪酬 | 按贡献自动分配利润 |
| 单一物理入口 | 无具体地址，全网分布 |
| 仅 Web 端 | 未来支持手机端（iOS / Android） |

---

## 二、去中心化原则

### 2.1 无具体地址

- 系统运行在 **区块链** 和 **P2P 网络** 之上
- 无单一物理地址或 IP 入口
- 交易通过智能合约执行，数据分布在用户节点
- 任何节点均可作为接入点

### 2.2 服务器/资源由客户提供

- 用户安装节点软件，成为「矿工」或「贡献者」
- 贡献资源类型：
  - **CPU**：订单撮合、交易验证
  - **存储**：订单簿、历史交易数据
  - **带宽**：交易广播、数据同步

### 2.3 费用用利润支付

- 交易所收取手续费（如 0.01% 交易费，每边最高 1 USD）
- 利润分配：
  - 资源贡献者（代币/加密货币）
  - 远程团队员工（按工作量）
  - 系统维护与治理基金
- 分配机制写入智能合约，自动执行

### 2.4 用户保存资料

- 每个节点可同步 **部分或全部** 交易所数据
- 数据包括：订单簿、历史交易、用户余额快照
- **数据保留策略**：节点存储的交易数据统一保留 **两周**，超期自动清理，不继续存储
- 采用分布式存储（如 IPFS）确保冗余与可用性
- 数据公开可验证，防止篡改

### 2.5 类似 PCDN 的资源调度

- 用户提供闲置设备，系统自动调度
- 贡献量度量指标：
  - 在线时长（uptime）
  - 带宽贡献
  - 存储容量
  - 有效任务完成数
- 贡献者根据贡献量获得奖励

---

## 三、系统架构

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户层（Clients）                          │
│   Web / App / CLI  ────────  P2P 网络  ────────  任意节点接入      │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                      节点层（Contributors）                       │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐             │
│  │ 撮合节点  │ │ 存储节点  │ │ 中继节点  │ │ 验证节点  │             │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘             │
│        提供 CPU / 存储 / 带宽，获得奖励                             │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                      共识与结算层（Blockchain）                    │
│  智能合约：资产托管 | 交易结算 | 手续费分配 | 贡献奖励发放           │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 节点类型

| 节点类型 | 职责 | 贡献资源 | 奖励依据 |
|---------|------|---------|---------|
| **撮合节点** | 订单匹配、价格发现 | CPU、内存 | 撮合成交量 |
| **存储节点** | 订单簿、历史数据存储（统一保留两周） | 磁盘、带宽 | 存储量、可用性 |
| **中继节点** | 交易广播、P2P 通信 | 带宽 | 转发量、uptime |

**重要原则**：**中继/撮合节点入网无任何条件**
- ✅ 无需白名单
- ✅ 无需质押
- ✅ 无需邀请
- ✅ 无需任何审批或准入机制
- ✅ 任何节点都可以自由加入和退出网络

节点只需配置并启动即可加入网络。奖励分配基于信誉分数，信誉分数高的节点获得更多奖励份额，形成正向激励循环。详见 [信誉机制说明](./信誉机制说明.md)。

### 3.3 数据流

```
用户下单 ──► 中继节点广播 ──► 撮合节点处理 ──► 智能合约结算
                │                    │
                ▼                    ▼
           存储节点同步          存储节点持久化
```

---

## 四、经济模型

### 4.1 收入来源

- **交易手续费**：每笔交易收取 **0.01%**（单边），买卖双方各自从其使用的代币收取；每边最高等值 **1 美元**（由 `feeCapPerToken` 配置，如 USDC 6 位小数下 1e6 = 1 USD）。
- **可选**：上币费、跨链桥费用

**费率**：详见 [API-接口说明](./API-接口说明.md) 交易费率对照币安。**手续费比例与上限可通过治理投票调整**（`setFeeBps`、`setFeeCap` 经治理合约执行）。

### 4.2 分配比例（示例）

| 分配对象 | 比例 | 说明 |
|---------|------|------|
| **开发者** | **1%** | **永久分成，每次手续费到账时自动转入开发者地址，无需手动领取或兑换**（FeeDistributor 合约实现）；**上线奖励 5 万贡献分**（ContributorReward 合约，第一个周期，**可自由流通，不受周期结束时间限制**；**每次领取不超过奖励池的 10%**，可多次领取） |
| 撮合节点 | 40% | 按撮合成交量分配（在剩余 99% 中 claim） |
| 存储节点 | 25% | 按存储贡献与 uptime |
| 中继节点 | 15% | 按带宽与转发量 |
| 开发/运维团队 | 14% | 按完成任务、代码贡献 |
| 治理/储备 | 5% | 协议升级、紧急基金 |

### 4.3 结算机制

- 使用 **原生代币** 或 **稳定币** 结算
- 分配逻辑写入智能合约，定期（如每日/每周）自动执行
- 贡献数据链上可验证，防止作弊

### 4.3.1 交易所代付 Gas（当买卖双方无原生代币时）

- **场景**：卖家/买家没有链上原生代币（如 ETH/MATIC）支付结算交易的 gas 时，可由 **交易所作为第三方** 代为提交结算交易。
- **前提**：交易所（relayer）地址已配置，且交易所持有足够原生代币支付 gas。
- **规则**：
  - Gas 费由 **卖方与买方均摊**（各一半，或按约定比例折算为 tokenIn/tokenOut 数量）。
  - 结算时 **先扣交易费、再扣 gas 费**，剩余部分再转给买家/卖家。
  - 代付方（relayer）调用 `settleTrade(..., gasReimburseIn, gasReimburseOut)` 时，`gasReimburseIn` 从 maker 侧（tokenIn）扣除并转给 relayer，`gasReimburseOut` 从 taker 侧（tokenOut）扣除并转给 relayer；relayer 可将收到的代币兑换为原生代币以补充 gas 成本。
- **合约**：Settlement 提供 `setRelayer(address)`、`settleTrade(..., gasReimburseIn, gasReimburseOut)`；仅 owner 或 relayer 可传入非零 gas 代付参数。

### 4.4 治理提案规则

- **参与资格**：**最近活跃人员**（定义见下）。
- **通过条件**：当提议出现时，**同意票数超过最近活跃人员总数的 50%** 即通过；反之不通过。
- **适用范围**：**任何可由链上执行的操作**均可提案表决，包括但不限于：
  - 交易手续费（feeBps）、自由流动比例（freeFlowBps）、储备比例（reserveBps）
  - **添加可交易货币**（上币）：对 TokenRegistry / 交易对白名单等合约调用 addToken 等
  - **流通链**：添加/移除支持的链（跨链桥、多链结算配置等）
  - 合约升级、参数调整、储备金用途等

#### 4.4.1 最近活跃的定义

| 维度 | 建议值 | 说明 |
|------|--------|------|
| **时间窗口** | 过去 **2 周**（与贡献周期 1 周对齐，取 2 个周期） | 提案创建时刻往前推 2 周内 |
| **周期长度** | 7 天（UTC 自然周） | 与贡献证明周期一致 |
| **活跃判定** | **仅贡献**：过去 2 周内至少一个周期 `submitProof` 成功 | 不区分贡献类型（storage/relay 均算）；**不统计历史投票**，实现简单 |
| **身份映射** | 领奖地址（EVM address）= 治理参与身份 | 与 ContributorReward 的 `msg.sender` 一致 |

#### 4.4.2 投票期限与提案冷却期

| 参数 | 建议值 | 说明 |
|------|--------|------|
| **投票期限** | 7 天 | 提案创建后 7 天内可投票，过期不可投 |
| **同一提案冷却期** | 7 天 | 同一 (target, callData) 执行后 7 天内不得再次创建相同提案 |
| **执行延迟** | 可选 | 通过后可立即执行；若接入 Timelock 可设 2 天延迟便于紧急取消 |

#### 4.4.3 链上认定与校验「最近活跃人员」

- **数据来源**：ContributorReward 合约内 `submitted[period][addr] == true` 表示该地址在该周期提交过证明。
- **活跃集合**：提案创建时，链下/链上计算「过去 2 周内」有 `submitProof` 的去重地址集合，记为 `activeSet`；其数量为 `activeCount`。**不统计历史投票**。
- **通过判定**：`yesCount > activeCount / 2`（整数除法，严格超过 50%）。
- **实现方式**：Governance 合约从 ContributorReward 只读查询各周期 `submitted` 记录，汇总最近 4 周去重得 `activeSet`；或链下生成默克尔根提交链上、投票时校验，以降低 Gas。

---

## 五、分布式团队管理

### 5.1 招聘与协作

- **在线招聘**：全球范围，基于能力筛选
- **远程办公**：无固定办公地点
- **按需付费**：完成任务或达成里程碑后支付

### 5.2 贡献类型

- 智能合约开发
- 前端/后端开发
- 安全审计
- 运维与节点部署
- 文档与社区运营

### 5.3 激励机制

- 任务完成 → 自动触发支付（智能合约或多签）
- 长期贡献者可获得代币激励
- 透明、可追溯的贡献记录

---

## 六、技术栈建议

### 6.1 区块链层

- **公链选择**：Ethereum / EVM 兼容链 / 自建链
- **智能合约**：Solidity / Vyper
- **跨链**：根据需要接入跨链桥

### 6.2 P2P 网络层

- **通信协议**：libp2p / WebRTC
- **数据存储**：IPFS / Filecoin / 自定义 DHT
- **共识**：链下订单簿 + 链上结算（参考 dYdX v4）

### 6.3 节点软件

- 跨平台（Windows / macOS / Linux）
- 轻量级，支持家庭带宽与普通硬件
- 贡献量自动统计与上报

---

## 七、风险与挑战

### 7.1 技术风险

| 风险 | 缓解措施 |
|------|---------|
| 订单簿一致性 | 链下共识 + 定期链上锚定 |
| 节点 Sybil 攻击 | 信誉系统（节点入网无任何条件，通过信誉分分配奖励激励高质量服务） |
| 数据可用性 | 多副本、纠删码 |

### 7.2 经济风险

| 风险 | 缓解措施 |
|------|---------|
| 早期贡献不足 | 启动阶段补贴、种子节点 |
| 恶意节点 | 罚没机制、贡献审计 |
| 代币波动 | 支持稳定币结算 |

### 7.3 合规风险

- 不同司法辖区对 DEX、代币的监管要求不同
- 需根据目标市场进行合规设计
- 可考虑无需 KYC 的免许可证模式（取决于所在地法律）

---

## 八、发展路线图

### Phase 1：核心交易（0-6 个月）

- [x] 智能合约：资产托管、交易结算
- [x] 基础 DEX 功能（AMM 或简单订单簿）
- [x] 手续费收取与分配逻辑

### Phase 2：节点网络（6-12 个月）

- [x] 节点软件设计与开发
- [x] 数据同步与存储节点
- [x] 贡献度量与奖励发放  
- **详细设计与进度**：[Phase2-设计文档](./Phase2-设计文档.md)（M1 连通 / M2 存储与 SyncTrades / M3 中继与贡献证明 / M4 链上对接与文档；节点部署、贡献奖励接口见该文档及 [节点部署](./节点部署.md)、[贡献奖励接口](./贡献奖励接口.md)）

### Phase 3：去中心化撮合（12-18 个月）

- [x] 撮合节点与共识机制（单主撮合、订单簿与 Settlement 衔接）
- [x] 中继节点与 P2P 通信（限流、信誉、bytesRelayed 按周期统计）
- [x] 完整经济模型上线（ContributorReward 40/25/15、领取截止、前端订单簿与贡献看板）
- **详细设计与实现状态**：[Phase3-设计文档](./Phase3-设计文档.md)

### Phase 4：生态扩张（18+ 个月）

- [ ] **手机端支持**：iOS / Android 原生或跨平台 App
- [ ] 跨链支持
- [x] 治理代币与 DAO（不发行项目自己的治理代币，使用贡献分和信誉分进行治理）
- [ ] 第三方应用接入

---

## 九、附录

### 9.1 参考项目

- **dYdX**：链下订单簿 + 链上结算
- **0x**：去中心化交易协议
- **Akash / Filecoin**：去中心化计算与存储
- **BitTorrent / IPFS**：P2P 内容分发

### 9.2 术语表

| 术语 | 说明 |
|------|------|
| PCDN | Peer-to-Peer Content Delivery Network，点对点内容分发网络 |
| DEX | Decentralized Exchange，去中心化交易所 |
| AMM | Automated Market Maker，自动做市商 |
| IPFS | InterPlanetary File System，星际文件系统 |
| Sybil | 女巫攻击，一人控制多个虚假身份 |

---

*本文档为概念设计基准；具体技术实现与参数在 Phase2/Phase3、技术架构说明等文档中细化。有变更以当时修改为准，并随时更新相关设计文档。*
