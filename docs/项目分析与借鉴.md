# 项目分析与借鉴

> 对标成熟 P2P DEX、架构增强方向、部署优化与上线奖励机制设计  
> 关联：[概念设计文档](./概念设计文档.md)、[技术架构说明](./技术架构说明.md)、[上线奖励分发机制实现指南](./上线奖励分发机制实现指南.md)

---

## 一、成熟 P2P DEX 对标与借鉴

### 1.1 对标项目概览

| 项目 | 特点 | 可借鉴点 |
|------|------|----------|
| **Bisq** | 去中心化 P2P 法币/币兑换，无中心服务器 | Tor 隐私集成、多签托管、声誉/惩罚、仲裁与争议 |
| **Haveno** | Bisq 分支，Monero 生态 | 原子交换、隐私币优先、托管流程 |
| **DCRDEX** | Decred 链上 DEX，订单簿 + 原子交换 | 原子交换、链上订单匹配、无托管 |
| **Tatanka** | P2P 网格/中继网络 | P2P 网格拓扑、中继发现与路由 |

### 1.2 建议借鉴的能力清单

| 能力 | 来源 | 说明 | 与本项目结合 |
|------|------|------|--------------|
| **Tor 隐私集成** | Bisq / Haveno | 节点/用户可选走 Tor，隐藏 IP | 可选 Tor 出口，保护节点与交易方隐私 |
| **多签托管** | Bisq | 2/2 或 2/3 多签锁定资金，争议时仲裁释放 | 可与 Vault + Settlement 结合，做「可选托管模式」 |
| **原子交换** | Haveno / DCRDEX | 跨链/跨资产原子交换，无中介托管 | 长期：跨链交易对、HTLC 或链上原子交换 |
| **声誉/惩罚系统** | Bisq | 作恶扣分、仲裁记录、禁入 | 与现有信誉分、贡献证明结合，链下声誉 + 链上奖励挂钩 |
| **Epoch-based 订单匹配** | 常见于 DEX | 按时间窗口（如 1 分钟）收集订单，窗口结束后统一撮合 | 可降低 Gas（批量结算）、减少抢跑，需与 relayer 批量提交配合 |
| **Tatanka P2P 网格** | Tatanka | 多跳中继、网格拓扑、去中心化路由 | 增强 libp2p 拓扑：DHT + GossipSub + 可选中继网格，提升连通性 |

### 1.3 从 Bisq / Haveno 学 Tor 集成（加隐私层）

Bisq、Haveno 将 **Tor** 作为默认或可选的网络层，实现「IP 隐藏 + 抗审查」，可作为本项目的**可选隐私层**。

| 借鉴点 | Bisq/Haveno 做法 | 本项目落地建议 |
|--------|------------------|----------------|
| **节点走 Tor** | 节点流量经 Tor 出口，隐藏真实 IP，降低被封锁/溯源风险 | 节点配置项 `use_tor=true`，libp2p 使用 Tor SOCKS 代理或内置 Tor 传输 |
| **用户端可选 Tor** | 桌面端可配置系统/应用走 Tor | 前端可选「通过 Tor 连接节点」：请求经 Tor 发往节点 API，或 PWA 内代理到 Tor |
| **不记录 IP** | 不记录用户 IP，仅记录必要链上/订单数据 | 节点与前端明确「不记录、不存储用户 IP」；日志脱敏 |
| **订单内容保护** | 订单可仅以哈希或加密形式在 P2P 层广播 | 协议扩展：订单敏感字段加密或仅广播哈希，撮合节点按权限解密（中长期） |

**实现优先级**：先做「节点可选 Tor 出口」与「不记录 IP」策略文档；用户端 Tor 与订单加密可放在 Phase 3/4。

---

### 1.4 从 dYdX / Hyperliquid 学高性能订单簿（优化 MatchEngine）

dYdX v4、Hyperliquid 等以**链下订单簿 + 高频撮合**著称，本项目可借鉴其「性能与体验」思路，在**保持 P2P 与去中心化**前提下优化 MatchEngine。

| 借鉴点 | dYdX / Hyperliquid 特点 | 本项目 MatchEngine 优化方向 |
|--------|-------------------------|-----------------------------|
| **内存订单簿 + 增量更新** | 订单簿全内存、增量 tick/level 更新，低延迟 | 订单簿常驻内存，Gossip 只传增量或 compact 的 level 快照，减少序列化与网络开销 |
| **确定性撮合与排序** | 价格优先、时间优先，规则明确、可复现 | 明确 FIFO/价格优先规则，同一 epoch 内订单排序确定性，便于多节点校验与批量结算 |
| **批量提交与 Epoch** | 多笔成交批量上链，降低 gas、减少抢跑 | Epoch（如 30s/1min）内收集订单 → 统一撮合 → 一批成交由 relayer 批量 settle（见 2.2 节） |
| **低延迟 API** | WebSocket 推送、最少 RTT | 节点 HTTP/WS 已具备；可优化：订单确认、成交推送的延迟与重试策略 |
| **限价单类型** | GTC、IOC、FOK 等 | 在订单类型与撤单逻辑上逐步支持更多类型，与合约结算语义对齐 |

**注意**：dYdX/Hyperliquid 依赖中心化 sequencer/validator；本项目保持 **P2P 广播 + 多节点撮合**，在「去中心化」与「性能」之间取平衡，优先保证一致性再压延迟。

---

## 二、针对 libp2p + GossipSub + relayer 架构的增强

> 当前架构：链下订单簿（GossipSub 广播）+ 撮合节点 + 链上 Settlement（relayer 代付 gas）

### 2.1 增强去中心化

| 方向 | 具体点 | 实现思路 |
|------|--------|----------|
| **节点无准入** | 保持节点入网无白名单、无质押 | 与 [节点入网说明](./节点入网说明.md) 一致，仅通过声誉与奖励调节行为 |
| **订单与撮合分离** | 订单广播与撮合逻辑可分布在不同节点 | 部分节点只做中继/存储，部分做撮合；贡献证明区分「中继/存储/撮合」 |
| **Relayer 去中心化** | 避免单一 relayer 成为单点 | 多 relayer 注册、按轮询或声誉选择；或 EIP-2771 兼容多 relayer 提交 |
| **治理去中心化** | 参数与分配由 Governance 决定 | 手续费比例、奖励池分配、紧急暂停等均通过提案 + 投票执行 |
| **P2P 网格增强** | 借鉴 Tatanka 思路 | 在现有 DHT + GossipSub 上增加「中继发现」与「多跳路由」，弱化对少量 bootstrap 的依赖 |

### 2.2 降低 Gas

| 方向 | 具体点 | 实现思路 |
|------|--------|----------|
| **批量结算** | 多笔成交一次上链 | Settlement 支持 `settleBatch(trade1, trade2, ...)` 或 Merkle 证明批量结算，relayer 一次交易多笔 |
| **Epoch 撮合** | 按时间窗口批量撮合 | 如每 30s/1min 一个 epoch，窗口内订单统一排序、撮合，窗口结束后一次性提交一批成交 |
| **Layer2 / 侧链** | 结算层迁移到 L2 | 在 Arbitrum/Base/Optimism 部署 Settlement，大幅降低单笔 gas；与 [跨链功能设计](./跨链功能设计.md) 协同 |
| **Gas 优化** | 合约与调用优化 | 减少 Storage 写入、用 event 替代部分读、relayer 使用 EIP-1559 调优 gas price |

### 2.3 提升用户体验

| 方向 | 具体点 | 实现思路 |
|------|--------|----------|
| **零 gas 感知** | 用户不直接付 gas | 保持 relayer 代付；前端明确提示「由 relayer 代付 gas」 |
| **价格参考** | 挂单有据可依 | 集成 CoinGecko 等市场价，突出零滑点限价优势（见 [快速优化实现指南](./快速优化实现指南.md)） |
| **手续费透明** | 费用与分成可见 | 展示平台费、gas 成本、分成去向（见 [优化与改进清单](./优化与改进清单.md)） |
| **隐私可选** | 高隐私需求用户 | 可选 Tor 出口、不记录 IP；订单内容仅哈希或加密广播（需协议扩展） |
| **多签/托管可选** | 大额或争议敏感场景 | 提供「多签托管」模式：资金先入 2/2 多签，成交后双方签名释放或仲裁释放 |

---

## 三、电脑端 / VPS 部署优化（**已放弃电脑端**，以 PWA/浏览器为主；本节仅保留供参考）

### 3.1 总体目标

- **完整环境一键部署**：Docker Compose 覆盖「节点中枢 + 辅助服务」。
- **电脑端**：命令行安装、优先浏览器交易（弱化/禁用 Electron 桌面内交易）、节点中枢可本地运行。
- **VPS**：一键脚本、systemd 自启、cron 自动更新（git pull + compose up）。
- **电脑端自动更新**：Electron 应用通过 electron-updater（GitHub Releases）+ 可选 watchtower/定时任务。

### 3.2 Docker Compose 一键部署（完整环境）

| 组件 | 说明 | 建议 |
|------|------|------|
| **node（中枢）** | Go 节点，libp2p + 订单簿 + 撮合 + HTTP/WS API | 单容器或 docker-compose 中 `node` 服务 |
| **辅助服务** | 价格服务、监控、索引等 | 可选容器：pricefeed、prometheus、grafana |
| **前端** | 静态站点或 Nginx 托管 | 可单独 build 后由 Nginx 提供，或独立容器 |

**示例结构**（保持与现有 [部署与使用说明](./部署与使用说明.md) 可衔接）：

```yaml
# docker-compose.yml 概念示例
services:
  node:
    build: ./node
    ports: ["8080:8080", "4001:4001"]  # HTTP API + libp2p
    env_file: .env
    restart: unless-stopped
  # pricefeed:
  #   image: ...
  # prometheus:
  #   ...
```

- 提供一键脚本：`curl -sSL https://.../install.sh | bash` 或 `docker-compose up -d` 文档化。

### 3.3 电脑端：命令行安装与运行策略

| 项目 | 说明 |
|------|------|
| **命令行安装** | 提供 CLI 或脚本：安装依赖、拉取镜像/二进制、写入配置、启动 node（及可选前端） |
| **强制/优先浏览器交易** | 桌面端（Electron）可「禁用或弱化」在应用内直接发起交易：引导用户用浏览器打开 DApp 完成交易，Electron 仅做节点中枢/只读展示；降低钱包注入与安全边界问题 |
| **节点中枢运行** | 电脑端可仅运行「节点进程」：连接 P2P 网络、提供本地 API，浏览器连本地 node 或公网 node 进行交易 |

### 3.4 VPS 部署

| 项目 | 说明 |
|------|------|
| **一键脚本** | 脚本完成：安装 Docker/Docker Compose、克隆仓库、配置 `.env`、`docker-compose up -d` |
| **systemd 自启** | 若不用 Docker 自启，可用 systemd 管理 node 进程：`Restart=always`，开机自启 |
| **cron 自动更新** | 定时（如每日）`git pull` + `docker-compose pull && docker-compose up -d` 或等效命令，保持节点与镜像更新 |

### 3.5 电脑端自动更新（Electron）

| 项目 | 说明 |
|------|------|
| **electron-updater** | 集成 `electron-updater`，从 GitHub Releases 检查并下载新版本，提示用户安装 |
| **发布流程** | 每次发布打 tag，CI 构建 Windows/macOS 安装包并上传到 GitHub Releases |
| **定时/后台检查** | 应用内定时检查更新；或由系统级定时任务触发检查（不替代应用内更新逻辑，仅作补充） |

---

## 四、上线奖励机制设计

### 4.0 节点奖励等按各自规则与池子分配（当前情况）

以下说明**节点奖励、团队/治理、手续费池**的现有规则与池子划分，便于与「仅开发者积分 1 积分=1 USDT」区分。

#### 4.0.1 两套合约分工

| 合约 | 用途 | 分配依据 |
|------|------|----------|
| **FeeDistributor** | 接收链上手续费（Settlement/AMMPool 转入） | **固定比例**：1% 自动转开发者地址；其余 99% 按 owner 设置的 `recipients[]` 与 `shareBps[]` 由各地址自行 `claim` |
| **ContributorReward** | 按周期、按贡献发放奖励 | **按贡献分动态分配**：每周期由 owner 注入奖励池（`setPeriodReward(period, token, amount)`），节点提交证明后按「我的贡献分 / 周期总贡献分」领取该周期池中份额 |

手续费先进入 FeeDistributor；「节点池」的来源可以是：Governance/多签定期从 FeeDistributor 或金库把一部分资金注入 ContributorReward 的某周期，或单独拨款。详见 [贡献奖励接口 §3.3、§4](./贡献奖励接口.md)。

#### 4.0.2 经济模型比例（与概念文档、Phase3 一致）

| 对象 | 比例 | 依据 | 实现位置 |
|------|------|------|----------|
| 撮合节点 | 40% | 撮合成交量（笔数/金额） | ContributorReward：nodeType=2，`submitProofEx` 的 tradesMatched/volumeMatched，权重 40 |
| 存储节点 | 25% | 存储量、uptime | ContributorReward：nodeType=1，uptime + storage，权重 25 |
| 中继节点 | 15% | bytesRelayed、uptime | ContributorReward：nodeType=0，权重 15 |
| 流动性提供 | 20% | 注入 AMM 的流动性数量 | ContributorReward：nodeType=3，`submitLiquidityProof`，权重 20（见 [流动性贡献分设计](./流动性贡献分设计.md)） |
| 开发/运维团队 | 15% | 任务/里程碑或固定分成 | FeeDistributor 的 recipients 或单独拨款，不经过 ContributorReward |
| 治理/储备 | 5% | 协议升级、紧急基金 | FeeDistributor 的 recipients 或单独拨款 |

上述 40/25/15/20 是**节点侧**在 ContributorReward 内部按贡献类型的**权重**；团队 15% 与治理 5% 由 FeeDistributor 或金库直接分配。

#### 4.0.3 节点奖励池与领取规则（当前）

- **池子来源**：每周期（如 7 天 UTC 自然周）奖励池 = 由 owner/Governance 向 ContributorReward **注入**的该周期某代币数量（`setPeriodReward(period, token, amount)`）。注入额通常来自当周或前一周手续费收入中「划给节点」的那一部分（比例由治理或部署约定）。
- **贡献分计算**：节点在周期内/结束后提交 `submitProof` 或 `submitProofEx`（含 nodeType、uptime、storage、bytesRelayed、撮合时含 tradesMatched/volumeMatched）；合约按 40/25/15/20 权重算出该地址在本周期的 **contributionScore**，并累加得到周期 **totalScore**。
- **每贡献分价值锁定（重新规定）**：
  - **每个周期**在结算/发放贡献分时确定：**该周期可分配池价值（稳定币）** 与 **该周期 totalScore**，则 **该周期「每贡献分价值」= 可分配池价值 ÷ totalScore**。该值即该周期的固定价值，之后不变。
  - **以后任何时候领取**：应得额度一律按**发放贡献分时（该周期）**锁定的价值计算。某地址应得稳定币价值 = 该地址在该周期的 contributionScore × 该周期「每贡献分价值」；若用某代币领取，领取数量 = 应得稳定币价值 ÷ **该代币在该周期结算时**的稳定币单价（不是领取时市价）。早领、晚领拿到的都是「发放时的那份价值」。
- **领取限制与截止**：可按应得额度**一次或分次**领取，不再设「单次不超过池子 10%」；**不设「周期结束 14 天后作废」**，任何时候领都按该周期锁定价值算，未领部分一直有效直至领完。详见 [贡献奖励接口 §3.3](./贡献奖励接口.md)。
- **可选：按信誉分加权**：若开启 `useReputationWeighting`，奖励按「贡献分 × 信誉分/10000」分配，详见 [信誉机制说明](./信誉机制说明.md)。

#### 4.0.4 与开发者积分的区别（小结）

| 项目 | 开发者积分 | 节点奖励等 |
|------|------------|------------|
| 兑换规则 | **仅此一项**：1 积分 = 1 USDT（主网上线时一次性） | 不按 1:1 USDT；按周期池子与贡献分占比分配 |
| 池子 | 上线奖励池（Governance/多签注入或 Merkle 等） | 每周期 ContributorReward 注入的 period 池 |
| 依据 | 开发贡献（PR/文档/测试等） | 撮合/存储/中继/流动性贡献证明 |

### 4.1 原则

- **开发者积分**：仅主网上线时发放；**仅开发者积分**按 **1 积分 = 1 USDT**（或等值稳定币）兑换，用于激励早期开发与贡献；节点奖励等按各自规则与池子分配，不适用 1:1 USDT。
- **绑定钱包**：节点启动或前端注册时绑定钱包地址，交易所/节点记录该绑定关系。
- **统一领取**：开发者积分 + 节点奖励均通过**绑定钱包**在 **ContributorReward** 合约上 **claim**，一口径发放。
- **直接发放**：上线时通过 snapshot → Governance 分配/批量空投或合约 `claim`，避免复杂多步。

### 4.2 绑定钱包

| 时机 | 方式 | 记录方 |
|------|------|--------|
| **节点启动** | 配置文件或环境变量写入奖励钱包；可选链上注册（NodeRegistry 或 ContributorReward） | 节点本地 + 可选链上 |
| **前端注册** | 用户连接钱包后在前端「绑定奖励钱包」并签名，调用 ContributorReward.bindWallet | 链上合约 |

- 防重复：一个钱包可绑定有限数量节点（见 4.5 防 Sybil）。

### 4.3 领取流程

- **开发者积分**：由 Governance 或多签调用 `ContributorReward.allocatePoints(developer, points)`（或等价接口），记入该地址「待领取」。
- **节点奖励**：按贡献证明/snapshot 结果，由 Governance 或多签调用 `allocatePoints(nodeWallet, nodePoints)` 或 `distributeFeeRewards`。
- **用户领取**：用户通过 **ContributorReward.claim()** 一次性领取当前累积的开发者积分 + 节点奖励 + 手续费分成（若合约设计为统一入口）。

详见 [上线奖励分发机制实现指南](./上线奖励分发机制实现指南.md) 中的「统一奖励领取机制」。

### 4.4 直接发放方式

| 方式 | 说明 |
|------|------|
| **Snapshot** | 主网上线前某区块/时刻 snapshot：节点列表、贡献度、开发者名单 |
| **Governance 分配** | 通过治理提案确定名单与数量，执行时调用合约分配 |
| **批量空投** | Merkle 空投或批量 transfer，领取时 claim（与现有 MerkleDistributor 思路一致） |
| **Claim 制** | 分配只写入「可领取额度」，用户自行调用 claim 领取，节省一次性大额转账 gas |

### 4.5 防 Sybil（一个钱包控制多节点）

在**无资金质押**前提下，可组合以下手段：

| 手段 | 说明 |
|------|------|
| **声誉系统** | 长期行为（稳定在线、正确转发、无 spam）积累声誉；低声誉节点奖励打折或排除 |
| **网络延迟/拓扑检测** | 同一 NAT 或同机多节点可通过 IP/延迟/拓扑聚类识别，限制同一「簇」的节点数或奖励上限 |
| **分层信任** | 新节点低权重，运行满 N 天或贡献达标后提升权重 |
| **绑定限制** | 1 个钱包最多绑定 1–3 个节点（可配置），超出不记奖励或需治理特批 |
| **社区治理挑战** | 对疑似 Sybil 的地址可发起治理提案，投票通过则冻结或扣减奖励 |

以上可与现有 [信誉机制说明](./信誉机制说明.md)、[贡献奖励接口](./贡献奖励接口.md) 结合，在 Phase2/Phase3 中逐步实现。

---

## 五、与现有文档的衔接

| 文档 | 衔接点 |
|------|--------|
| [概念设计文档](./概念设计文档.md) | 经济模型、Phase 路线、去中心化原则 |
| [技术架构说明](./技术架构说明.md) | 分层架构、GossipSub、relayer、Settlement |
| [Phase2-设计文档](./Phase2-设计文档.md) | 节点类型、贡献证明、数据保留 |
| [Phase3-设计文档](./Phase3-设计文档.md) | 链下订单簿、撮合、中继规模化 |
| [上线奖励分发机制实现指南](./上线奖励分发机制实现指南.md) | 绑定钱包、统一 claim、Merkle/批量发放 |
| [优化与改进清单](./优化与改进清单.md) | 价格参考、手续费透明、公开数据、P2P 性能 |
| [部署与使用说明](./部署与使用说明.md) | Docker、前端配置、治理流程 |

---

## 六、优先级建议（简要）

1. **先做**：上线奖励机制（绑定钱包 + 统一 claim）、Docker Compose 一键部署；**电脑端已放弃**，以 PWA/浏览器为主。
2. **随后**：Epoch 撮合 + 批量结算（降 gas）、声誉/惩罚与防 Sybil、P2P 网格增强。
3. **中长期**：Tor 可选、多签托管可选、原子交换（跨链）。

*本文档以当时修改为准，随产品与架构演进更新。*
