# 节点入网说明

> **核心原则**：**中继/撮合节点入网无任何条件**

---

## 一、入网原则

### 1.1 完全开放

P2P DEX 网络采用**完全开放**的节点加入机制：

- ✅ **无需白名单**：任何节点都可以直接加入
- ✅ **无需质押**：不需要锁定任何代币
- ✅ **无需邀请**：不需要现有节点的邀请码
- ✅ **无需审批**：不需要任何中心化机构的审批
- ✅ **无需注册**：不需要在链上或链下注册节点身份

### 1.2 自由退出

节点可以随时退出网络：

- ✅ 直接停止节点即可
- ✅ 无需任何手续或通知
- ✅ 已获得的贡献分和奖励不受影响

---

## 二、如何加入网络

### 2.1 基本步骤

1. **下载节点软件**
   ```bash
   git clone https://github.com/P2P-P2P/p2p.git
   cd p2p/node
   ```

2. **配置节点**
   ```bash
   cp config.example.yaml config.yaml
   # 编辑 config.yaml，设置节点类型、监听地址等
   ```

3. **启动节点**
   ```bash
   # 方式一：Docker
   docker build -t p2p-node .
   docker run -it --rm -p 4001:4001 p2p-node
   
   # 方式二：Go 源码
   go run ./cmd/node
   
   # 方式三：一键脚本
   ./run.sh  # Linux/macOS
   .\run.ps1 # Windows
   ```

4. **连接到网络**
   - 配置 `network.bootstrap` 连接到已知节点
   - 或使用 `-connect <multiaddr>` 直连
   - DHT 会自动发现其他节点

### 2.2 节点类型选择

**中继节点**（`node.type: relay`）：
- 转发订单和成交消息
- 需要稳定的网络连接
- 奖励基于转发量和在线时长

**撮合节点**（`node.type: match`）：
- 执行订单撮合
- 需要配置交易对和链上代币地址
- 奖励基于撮合成交量和成交量

**存储节点**（`node.type: storage`）：
- 存储订单簿和历史数据
- 需要足够的磁盘空间
- 奖励基于存储量和可用性

---

## 三、奖励机制

### 3.1 贡献证明

节点需要定期提交贡献证明：

1. **收集指标**：uptime、转发量、存储量、撮合数据等
2. **生成证明**：使用节点私钥签名
3. **提交链上**：调用 `ContributorReward.submitProof` 或 `submitProofEx`

### 3.2 按信誉分分配

奖励按照（贡献分 × 信誉分数/10000）进行分配：

- **贡献分**：基于节点类型和贡献量计算（撮合 40%、存储 25%、中继 15%）
- **信誉分数**：基于转发量、违规次数、在线时长等计算（0-10000）
- **加权贡献分** = 贡献分 × (信誉分数 / 10000)
- **奖励份额** = 我的加权贡献分 / 总加权贡献分

详见 [信誉机制说明](./信誉机制说明.md) 和 [信誉分配示例](./信誉分配示例.md)。

---

## 四、常见问题

### Q1: 新节点如何获得初始信誉分数？

A: 新节点初始信誉分数建议设置为 5000（中等），可以通过治理或 owner 调用 `setReputationScore` 设置。随着节点提供高质量服务，信誉分数会逐步提高。

### Q2: 低信誉节点能否获得奖励？

A: 可以。只要节点有贡献分且满足信誉阈值（如果设置了），就可以获得奖励。信誉分数越高，获得的奖励份额越大。

### Q3: 节点需要多少资源？

A: 
- **中继节点**：最低配置即可，主要需要稳定的网络
- **撮合节点**：需要一定的 CPU 和内存，用于订单匹配
- **存储节点**：需要足够的磁盘空间（建议至少 10GB）

### Q4: 节点可以同时运行多种类型吗？

A: 当前实现中，一个节点实例只能是一种类型。如果需要多种功能，可以运行多个节点实例。

### Q5: 节点退出后数据会丢失吗？

A: 不会。数据分布在多个存储节点中，单个节点退出不会影响数据可用性。节点重新加入后可以重新同步数据。

---

## 五、最佳实践

### 5.1 新节点建议

1. **选择合适的节点类型**：根据你的资源选择中继、撮合或存储节点
2. **配置 Bootstrap**：连接到已知的稳定节点，加快网络发现
3. **保持在线**：在线时长是贡献分和信誉分数的重要因素
4. **避免违规**：遵守限流规则，避免被标记为违规

### 5.2 提高信誉分数

1. **稳定运行**：保持高在线时长
2. **积极转发**：中继节点应积极转发消息
3. **避免违规**：遵守网络规则，避免超限
4. **长期参与**：信誉分数会随着时间积累

### 5.3 获得更多奖励

1. **提高贡献分**：根据节点类型提供相应资源
2. **提高信誉分数**：提供高质量服务，避免违规
3. **及时提交证明**：周期结束后及时提交贡献证明
4. **及时领取奖励**：在截止日期前领取奖励

---

## 六、技术细节

### 6.1 网络发现

节点通过以下方式发现网络：

1. **Bootstrap 节点**：配置 `network.bootstrap` 连接到已知节点
2. **DHT 发现**：通过 Kademlia DHT 自动发现其他节点
3. **直连**：使用 `-connect <multiaddr>` 直接连接到指定节点

### 6.2 消息传播

节点通过 GossipSub 协议传播消息：

- 订阅相关 topic（订单、成交等）
- 自动转发收到的消息
- 限流保护（如果启用）

### 6.3 数据同步

- **订单簿**：通过 GossipSub 实时同步
- **历史数据**：通过 SyncTrades 协议同步
- **链上数据**：可选，通过 RPC 拉取链上事件

---

## 七、相关文档

- [节点部署](./节点部署.md)：详细的部署步骤和配置说明
- [信誉机制说明](./信誉机制说明.md)：信誉分数计算和奖励分配机制
- [信誉分配示例](./信誉分配示例.md)：按信誉分分配的具体示例
- [节点发现与Bootstrap](./节点发现与Bootstrap.md)：网络发现和连接说明

---

*本文档说明节点入网的基本原则和流程。节点入网无任何条件，完全开放。*
