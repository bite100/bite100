# 跨链功能设计文档

> 版本：v1.0  
> 更新日期：2025-02-08

---

## 一、概述

本文档描述 P2P DEX 的跨链功能设计，包括目标链选择、多链部署、前端链切换和跨链桥接。

---

## 二、目标链选择

### 2.1 推荐目标链

| 链 | Chain ID | 特点 | 优先级 |
|----|----------|------|--------|
| **Ethereum Mainnet** | 1 | 主网，流动性最大 | ⭐⭐⭐⭐⭐ |
| **Base** | 8453 | Coinbase L2，低 Gas | ⭐⭐⭐⭐ |
| **Arbitrum** | 42161 | 高性能 L2，生态丰富 | ⭐⭐⭐⭐ |
| **Polygon** | 137 | 成熟 L2，用户基数大 | ⭐⭐⭐ |
| **Optimism** | 10 | 以太坊 L2 | ⭐⭐⭐ |
| **Sepolia** | 11155111 | 测试网（已支持） | ✅ 已支持 |

### 2.2 选择标准

- **Gas 费用**：低 Gas 费用降低用户交易成本
- **生态成熟度**：已有 DEX 和 DeFi 生态
- **用户基数**：活跃用户数量
- **技术稳定性**：链的稳定性和安全性
- **桥接便利性**：跨链桥的可用性和成本

---

## 三、多链部署

### 3.1 部署策略

#### 3.1.1 合约部署

每条链需要部署相同的合约套件：
- Vault（资产托管）
- FeeDistributor（手续费分配）
- Settlement（交易结算）
- AMMPool（AMM 交易池）
- ContributorReward（贡献奖励）
- Governance（治理）
- TokenRegistry（上币配置）
- ChainConfig（流通链配置）

#### 3.1.2 部署顺序

1. **核心合约**：Vault → FeeDistributor → Settlement
2. **交易合约**：AMMPool（需要 Token0/Token1）
3. **治理合约**：ContributorReward → Governance
4. **配置合约**：TokenRegistry → ChainConfig
5. **绑定关系**：设置 Governance 绑定关系

#### 3.1.3 代币配置

每条链需要配置：
- **Token0**：基础代币（如 USDC）
- **Token1**：报价代币（如 USDT 或 WETH）

**建议**：
- Base/Arbitrum：使用 USDC/USDT
- Polygon：使用 USDC/USDT 或 MATIC/USDC
- 主网：使用 USDC/USDT 或 WETH/USDC

### 3.2 部署脚本

创建多链部署脚本：
- `deploy-base.ps1` - Base 链部署
- `deploy-arbitrum.ps1` - Arbitrum 链部署
- `deploy-polygon.ps1` - Polygon 链部署
- `deploy-optimism.ps1` - Optimism 链部署

---

## 四、前端链切换

### 4.1 链切换组件

#### 4.1.1 功能需求

- **链选择器**：下拉菜单选择目标链
- **自动切换**：连接钱包后自动切换到支持的链
- **链信息显示**：显示当前连接的链和网络
- **切换提示**：切换链时的用户提示

#### 4.1.2 支持的链

```typescript
export const SUPPORTED_CHAINS = [
  { chainId: 1, name: 'Ethereum', rpc: 'https://ethereum.publicnode.com' },
  { chainId: 8453, name: 'Base', rpc: 'https://mainnet.base.org' },
  { chainId: 42161, name: 'Arbitrum', rpc: 'https://arb1.arbitrum.io/rpc' },
  { chainId: 137, name: 'Polygon', rpc: 'https://polygon-rpc.com' },
  { chainId: 10, name: 'Optimism', rpc: 'https://mainnet.optimism.io' },
  { chainId: 11155111, name: 'Sepolia', rpc: 'https://ethereum-sepolia.publicnode.com' },
]
```

### 4.2 实现方案

#### 4.2.1 链配置管理

```typescript
// frontend/src/config/chains.ts
export interface ChainConfig {
  chainId: number
  name: string
  rpcUrl: string
  blockExplorer?: string
  contracts: {
    vault: string
    settlement: string
    ammPool: string
    // ...
  }
}

export const CHAIN_CONFIGS: Record<number, ChainConfig> = {
  1: { /* Ethereum */ },
  8453: { /* Base */ },
  // ...
}
```

#### 4.2.2 链切换 Hook

```typescript
// frontend/src/hooks/useChainSwitch.ts
export function useChainSwitch() {
  const switchChain = async (chainId: number) => {
    // 1. 检查钱包是否支持该链
    // 2. 如果支持，切换链
    // 3. 如果不支持，添加链配置
    // 4. 更新前端配置
  }
}
```

#### 4.2.3 链切换组件

```typescript
// frontend/src/components/ChainSwitcher.tsx
export function ChainSwitcher() {
  // 显示当前链
  // 提供链选择下拉菜单
  // 处理链切换逻辑
}
```

---

## 五、跨链桥接

### 5.1 桥接方案

#### 5.1.1 方案选择

| 方案 | 说明 | 优点 | 缺点 |
|------|------|------|------|
| **第三方桥** | 使用 LayerZero、Axelar 等 | 快速集成，无需维护 | 依赖第三方，可能有费用 |
| **自建桥** | 自己实现跨链桥 | 完全控制，无第三方依赖 | 开发成本高，需要验证节点 |
| **混合方案** | 主要使用第三方桥，关键路径自建 | 平衡成本和可控性 | 复杂度较高 |

**推荐**：初期使用第三方桥（LayerZero、Axelar），后期考虑自建桥。

#### 5.1.2 LayerZero 集成

LayerZero 是一个全链互操作性协议，支持跨链消息传递。

**集成步骤**：
1. 部署 LayerZero Endpoint
2. 实现跨链消息发送和接收
3. 处理跨链资产锁定和解锁

#### 5.1.3 跨链资产转移

**流程**：
1. 用户在源链锁定资产
2. 发送跨链消息到目标链
3. 目标链验证消息并解锁资产
4. 用户收到目标链资产

### 5.2 跨链交易

#### 5.2.1 场景

- **跨链 Swap**：用户在链 A 有 TokenA，想在链 B 获得 TokenB
- **跨链流动性**：在不同链之间转移流动性

#### 5.2.2 实现方案

1. **锁定-铸造模式**：
   - 源链锁定资产
   - 目标链铸造等量资产
   - 反向操作时销毁并解锁

2. **中继模式**：
   - 使用中继节点验证跨链消息
   - 中继节点负责资产转移

---

## 六、实施计划

### 6.1 阶段 1：基础多链支持（高优先级）

- ✅ 明确目标链（Base、Arbitrum）
- ✅ 创建多链配置
- ✅ 实现前端链切换
- ✅ 创建多链部署脚本

### 6.2 阶段 2：多链部署（中优先级）

- ⏳ 在 Base 链部署合约
- ⏳ 在 Arbitrum 链部署合约
- ⏳ 验证多链功能

### 6.3 阶段 3：跨链桥接（低优先级）

- ⏳ 集成第三方跨链桥（LayerZero）
- ⏳ 实现跨链资产转移
- ⏳ 实现跨链交易

---

## 七、技术细节

### 7.1 链配置管理

**配置文件**：`frontend/src/config/chains.ts`

```typescript
export const CHAIN_CONFIGS = {
  1: {
    chainId: 1,
    name: 'Ethereum',
    rpcUrl: 'https://ethereum.publicnode.com',
    blockExplorer: 'https://etherscan.io',
    contracts: { /* ... */ }
  },
  8453: {
    chainId: 8453,
    name: 'Base',
    rpcUrl: 'https://mainnet.base.org',
    blockExplorer: 'https://basescan.org',
    contracts: { /* ... */ }
  },
  // ...
}
```

### 7.2 钱包链切换

**MetaMask 链切换**：

```typescript
async function switchChain(chainId: number) {
  try {
    await window.ethereum.request({
      method: 'wallet_switchEthereumChain',
      params: [{ chainId: `0x${chainId.toString(16)}` }],
    })
  } catch (error: any) {
    if (error.code === 4902) {
      // 链不存在，需要添加
      await addChain(chainId)
    }
  }
}

async function addChain(chainId: number) {
  const config = CHAIN_CONFIGS[chainId]
  await window.ethereum.request({
    method: 'wallet_addEthereumChain',
    params: [{
      chainId: `0x${chainId.toString(16)}`,
      chainName: config.name,
      rpcUrls: [config.rpcUrl],
      blockExplorerUrls: [config.blockExplorer],
      nativeCurrency: {
        name: 'ETH',
        symbol: 'ETH',
        decimals: 18,
      },
    }],
  })
}
```

### 7.3 多链状态管理

**使用 Context 管理当前链**：

```typescript
// frontend/src/contexts/ChainContext.tsx
export const ChainContext = createContext<{
  currentChain: ChainConfig | null
  switchChain: (chainId: number) => Promise<void>
}>({ /* ... */ })
```

---

## 八、相关文档

- [部署与使用说明](./部署与使用说明.md)
- [主网部署指南](./主网部署指南.md)
- [API-接口说明](./API-接口说明.md)

---

*本文档描述跨链功能的设计方案，包括目标链选择、多链部署、前端链切换和跨链桥接。*
