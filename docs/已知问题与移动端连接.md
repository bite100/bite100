# 项目已知问题 & 移动端连接（基于最新代码）

## 技术栈与依赖

前端使用 **Wagmi + RainbowKit**，底层仍依赖浏览器注入的 `window.ethereum`。桌面端 MetaMask 扩展会直接注入，连接正常；移动端依赖钱包内置浏览器或 WalletConnect。

## 根源

- **桌面浏览器**：MetaMask 等扩展直接注入 `window.ethereum`，连接顺畅。
- **手机外部浏览器**（iOS Safari / Android Chrome）：不会从 MetaMask/Trust/Phantom 等 App 自动注入 `window.ethereum`（系统安全与无扩展机制）。
- **移动钱包**：Trust 注入在 `window.trustwallet`，Phantom 在 `window.phantom.ethereum`，默认不会写到 `window.ethereum`，导致 dApp 检测不到。

项目已通过以下方式修复（见 commit 974b89b 及后续）：

1. **index.html** 内联脚本：页面加载时若无 `window.ethereum`，将 `trustwallet` 或 `phantom.ethereum` 同步到 `window.ethereum`。
2. **walletConfig.tsx**：应用加载时再执行一次相同同步，应对 index.html 被缓存未执行脚本的情况。
3. **WalletConnect**：配置 `VITE_WC_PROJECT_ID` 后，连接弹窗优先展示 WalletConnect，移动端可扫码连接。

## 手机打不开的常见原因（按概率）

1. **未检测到 window.ethereum**：移动钱包未注入或未同步到 `window.ethereum`。
2. **网络不是 Sepolia**：部分流程依赖链 ID，需切到 Sepolia（11155111）或对应主网。
3. **WalletConnect 未生效**：未配置 Project ID、或 deeplink/跳转失败。
4. **iOS 限制**：Safari 跨 App 跳转、CSP、第三方 cookie 等。
5. **PWA 模式**：添加到主屏幕后，部分环境下 provider 注入更不稳定。

## 推荐解决方式（开发者）

### 1. 用钱包内置浏览器打开（最稳定）

- MetaMask App → 内置浏览器 → 打开 `https://bite100.github.io/bite100/`
- 或 Trust Wallet / Phantom 的内置浏览器打开同一地址  

内置浏览器会由钱包注入 provider，同步逻辑会写入 `window.ethereum`，连接成功率最高。先确认此处能连，再排查外部浏览器。

### 2. 在手机外部浏览器里检查 provider

- 用 Safari/Chrome 打开站点，通过远程调试（iOS：Mac Safari 连 iPhone；Android：Chrome `chrome://inspect`）。
- 控制台执行：
  ```js
  console.log(!!window.ethereum);
  console.log(window.ethereum?.isMetaMask); // 或 isTrust、phantom 等
  ```
- 若为 `false`：当前环境未注入。可尝试安装/打开钱包 App 并刷新；部分钱包需在 App 内开启「连接浏览器 dApp」。

### 3. 确认代码与部署为最新

- 拉取最新：`git pull origin main`。
- 确认 `frontend/index.html` 含 Trust/Phantom 同步脚本，`frontend/src/walletConfig.tsx` 含 `syncMobileProvider()` 的兜底同步。
- 重新构建并部署：`npm run build`，再部署到 GitHub Pages / Vercel 等。

### 4. 其他快速排查

- 清空手机浏览器缓存并强制刷新。
- 钱包切到 Sepolia，RPC 可用：`https://ethereum-sepolia.publicnode.com`。
- 若支持 WalletConnect：在连接弹窗选 WalletConnect → 用钱包 App 扫 QR。
- 用同一手机浏览器测试其他 dApp（如 Sepolia 水龙头）能否连接，以区分是本站还是环境问题。

## 相关代码位置

- Provider 同步（首屏）：`frontend/index.html` 内联 script。
- Provider 同步（兜底）：`frontend/src/walletConfig.tsx` 中 `syncMobileProvider()`。
- 连接与链配置：`frontend/src/walletConfig.tsx`（Wagmi connectors）、`frontend/src/App.tsx`（ConnectButton）。
