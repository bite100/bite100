# 跨链桥接实现指南

> 版本：v1.0  
> 更新日期：2025-02-08

---

## 一、概述

本文档说明如何使用 LayerZero OApp 实现跨链资产桥接功能。跨链桥接允许用户在不同链之间转移资产，实现真正的多链 DEX 体验。

---

## 二、技术方案

### 2.1 LayerZero OApp

**选择原因**：
- ✅ 成熟的跨链消息传递协议
- ✅ 支持任意消息传递（不仅限于代币）
- ✅ 良好的 Foundry 支持
- ✅ 活跃的社区和文档

**核心概念**：
- **OApp**: 可以发送和接收跨链消息的合约
- **Endpoint**: LayerZero 的跨链消息端点
- **DVN**: 默认虚拟节点，负责验证和转发消息

### 2.2 架构设计

```
源链 (Source Chain)             目标链 (Destination Chain)
┌─────────────────┐            ┌─────────────────┐
│  CrossChainBridge│            │  CrossChainBridge│
│  (锁定资产)      │            │  (解锁/铸造)     │
└────────┬────────┘            └────────┬────────┘
         │                               │
         │  LayerZero Message            │
         └───────────────────────────────┘
```

**流程**：
1. 用户在源链调用 `bridgeToken`
2. 资产被锁定在源链的桥接合约
3. 通过 LayerZero 发送跨链消息
4. 目标链接收消息并解锁/铸造资产

---

## 三、合约实现

### 3.1 核心合约

**文件**: `contracts/src/CrossChainBridge.sol`

**主要功能**：
- `bridgeToken()`: 发起跨链转移（锁定资产）
- `_lzReceive()`: 接收跨链消息（解锁/铸造资产）
- `quoteBridgeFee()`: 估算跨链费用
- `setSupportedToken()`: 管理支持的代币
- `setTokenMapping()`: 设置代币映射

### 3.2 依赖安装

```bash
cd contracts

# 安装 LayerZero OApp 包
forge install LayerZero-Labs/oapp-evm

# 安装 OpenZeppelin
forge install OpenZeppelin/openzeppelin-contracts
```

### 3.3 部署步骤

#### 1. 配置 LayerZero Endpoint

各链的 LayerZero Endpoint 地址：
- **Ethereum**: `0x1a44076050125825900e736c501f859c50fE728c`
- **Base**: `0x1a44076050125825900e736c501f859c50fE728c`
- **Arbitrum**: `0x1a44076050125825900e736c501f859c50fE728c`
- **Polygon**: `0x1a44076050125825900e736c501f859c50fE728c`
- **Sepolia**: `0x6EDCE65403992e310A62460808c4b910D972f10f`

#### 2. 部署脚本

```solidity
// contracts/script/DeployCrossChainBridge.s.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "forge-std/Script.sol";
import "../src/CrossChainBridge.sol";

contract DeployCrossChainBridge is Script {
    function run() external {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        address endpoint = vm.envAddress("LAYERZERO_ENDPOINT");
        address owner = vm.addr(deployerPrivateKey);
        
        vm.startBroadcast(deployerPrivateKey);
        
        CrossChainBridge bridge = new CrossChainBridge(
            endpoint,
            owner,
            owner // delegate
        );
        
        console.log("CrossChainBridge deployed at:", address(bridge));
        
        vm.stopBroadcast();
    }
}
```

#### 3. 配置代币映射

部署后，需要在每条链上配置代币映射：

```solidity
// 在源链上设置目标链的代币映射
bridge.setTokenMapping(
    dstChainId,      // 目标链 ID（如 Base = 8453）
    srcToken,        // 源链代币地址
    dstToken         // 目标链代币地址
);
```

---

## 四、前端集成

### 4.1 组件使用

**文件**: `frontend/src/components/CrossChainBridge.tsx`

```tsx
import { CrossChainBridge } from './components/CrossChainBridge'

function App() {
  return (
    <CrossChainBridge
      account={account}
      currentChainId={currentChainId}
    />
  )
}
```

### 4.2 配置桥接合约地址

在各链配置中添加桥接合约地址：

```typescript
// frontend/src/config/chains.ts
export interface ChainConfig {
  // ...
  contracts: {
    // ...
    crossChainBridge?: string  // 桥接合约地址
  }
}
```

### 4.3 使用流程

1. **选择源链和目标链**
2. **输入代币地址和数量**
3. **授权代币**（首次需要）
4. **发起跨链转移**
5. **等待确认**（通常需要几分钟）

---

## 五、测试

### 5.1 本地测试

```bash
# 启动本地节点
anvil

# 部署合约
forge script script/DeployCrossChainBridge.s.sol --rpc-url http://localhost:8545 --broadcast
```

### 5.2 测试网测试

**Sepolia 测试**：
1. 部署桥接合约到 Sepolia
2. 配置代币映射
3. 测试跨链转移

**注意事项**：
- 测试网可能需要测试代币
- LayerZero 测试网配置可能不同
- 费用较低，适合测试

---

## 六、安全考虑

### 6.1 重放攻击防护

- 使用 `nonce` 和 `timestamp` 生成唯一请求 ID
- 使用 `processedRequests` 映射防止重复处理

### 6.2 代币验证

- 验证代币映射是否存在
- 检查代币是否支持桥接
- 验证数量是否有效

### 6.3 费用管理

- 设置合理的桥接费用
- 防止费用过高导致用户损失
- 费用提取需要 owner 权限

---

## 七、常见问题

### Q1: 跨链转移需要多长时间？

**A**: 通常需要 5-15 分钟，取决于目标链的确认时间。

### Q2: 如何查询转移状态？

**A**: 可以通过 LayerZero 扫描器查询消息状态，或监听合约事件。

### Q3: 如果转移失败怎么办？

**A**: 资产会锁定在源链的桥接合约中，需要联系管理员手动处理。

### Q4: 支持哪些代币？

**A**: 需要管理员通过 `setSupportedToken` 添加支持的代币。

---

## 八、相关文档

- [LayerZero 官方文档](https://docs.layerzero.network/v2)
- [OApp 标准](https://docs.layerzero.network/v2/developers/evm/oapp/overview)
- [跨链功能设计](./跨链功能设计.md)
- [跨链功能实现指南](./跨链功能实现指南.md)

---

*本文档说明如何使用 LayerZero OApp 实现跨链资产桥接功能。*
