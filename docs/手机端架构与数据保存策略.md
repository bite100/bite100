# 手机端架构与数据保存策略

> 专注手机端（纯 PWA + 手机浏览器）时的贡献分、数据保存位置和访问方式

---

## 一、核心原则

**项目定位**：纯 PWA + 手机浏览器使用，不依赖桌面版。

**关键点**：
- 手机用户通过 PWA 访问，无需下载 App
- 所有核心数据保存在链上（区块链）
- 本地数据用 IndexedDB 缓存，提升离线体验
- 节点运行由少数 VPS/开发者承担，手机用户无需跑节点

---

## 二、贡献分 / 手续费分成保存位置

### 2.1 链上保存（核心、权威）

**保存位置**：Sepolia 测试网（未来主网/Polygon）的智能合约

| 合约 | 地址 | 功能 |
|------|------|------|
| **FeeDistributor** | `0xeF4BFB58541270De18Af9216EB0Cd8EC07a2547F` | 收集所有交易手续费，按 Governance 提案比例自动分发 |
| **ContributorReward** | `0x851019107c4F3150D90f1629f6A646eBC1B1E286` | 管理贡献者奖励逻辑（基于贡献记录或提案分配） |
| **Governance** | `0x8F107ffaB0FC42E623AA69Bd10d8ad4cfbcE87BB` | 提案和投票设置分成比例、受益地址 |

### 2.2 手机端如何查看/领取

**查看分成余额**：
1. 用手机钱包（MetaMask / Trust Wallet 等）连接前端 PWA
2. 前端调用合约 `view` 函数查询你的分成余额
3. 显示在"我的贡献"页面

**领取分成**：
1. 点击"领取"按钮
2. 手机钱包弹出确认（签名交易）
3. 分成直接转到你的钱包地址
4. **完全不需要跑节点或桌面**，只要你的地址在 Governance 里被设置成受益人，就能领取

**优势**：
- ✅ 链上自动执行，无需人工干预
- ✅ 手机钱包即可操作，门槛极低
- ✅ 分成规则透明，Governance 可治理

---

## 三、个人贡献记录 / 挂单 / 撮合数据保存位置

### 3.1 链上保存（永久、权威）

**实际成交、结算记录**：
- **Settlement 合约**（地址 `0x493Da680973F6c222c89eeC02922E91F1D9404a0`）
- 所有成交记录通过合约事件永久保存
- 贡献分累积基于链上事件（手续费流入 FeeDistributor → 分成逻辑）

**手机端查询**：
- 使用 `ethers.js` / `viem` 查询合约事件或 `view` 函数
- 前端可显示"我的分成累计"、"我的交易历史"等

### 3.2 手机本地保存（离线可见、快速加载）

**IndexedDB（已实现）**：

前端用 Dexie.js 或原生 IndexedDB 保存：

| 数据类型 | 说明 | 用途 |
|----------|------|------|
| **挂单** | pending orders | 本地缓存，快速显示 |
| **撮合记录** | matches | 离线查看交易历史 |
| **个人交易历史** | trade history | 避免重复查询链上 |
| **贡献追踪** | contribution tracking | 本地缓存链上查询结果 |

**特点**：
- ✅ 浏览器关闭/重启后，数据还在手机浏览器里
- ✅ PWA 支持离线读取
- ✅ 链上确认后，前端可同步更新 IndexedDB（避免重复查询链）

**实现位置**：
- `frontend/src/p2p/storage.ts` - IndexedDB 存储实现
- `frontend/src/dataCache.ts` - 数据缓存逻辑

### 3.3 P2P 网络临时数据

**未确认订单/撮合消息**：
- 在 libp2p GossipSub 广播期间存在于节点内存或 DHT（去中心化存储）
- 手机端轻客户端（js-libp2p + WebRTC）只能短暂参与广播
- **不能长期存储或跑完整节点**

**特点**：
- ⚠️ 临时性：订单确认后同步到链上
- ⚠️ 轻量级：手机端只参与广播，不存储完整订单簿

---

## 四、专注手机时的限制与方案

### 4.1 限制

**完整 Go + libp2p 节点**：
- ❌ 无法在手机浏览器运行（Go 环境 + 端口监听不支持）
- ❌ 贡献分中"节点运行者分成"部分需要有人跑节点（VPS / 电脑 / Docker）

**手机用户限制**：
- ⚠️ 只能作为"轻客户端"参与（广播少量订单）
- ⚠️ 拿不到节点奖励，但仍可拿开发者/提案分成

### 4.2 解决方案

**节点运行**：
1. **开发者/核心贡献者用 VPS**（每月几美元）跑 1-2 个节点
2. 确保网络活跃 → 手机用户正常撮合
3. 节点运行成本低，不影响项目可持续性

**分成规则调整**：
1. **大部分给开发者/流动性提供者**（Governance 提案可改）
2. **节点奖励占小比例**（如 10-20%）
3. 手机用户主要受益于"开发者分成"和"流动性提供者分成"

**前端优化**：
1. 加"我的贡献"页面：
   - 从链上查 FeeDistributor 余额
   - IndexedDB 缓存本地记录
   - 手机随时看分成
2. 显示分成来源：
   - 开发者分成
   - 流动性提供者分成
   - 提案奖励（如有）

---

## 五、数据保存位置总结表

| 数据类型 | 保存位置 | 手机怎么访问/操作 | 是否需要跑节点？ |
|---------|---------|-----------------|-----------------|
| **贡献分 / 手续费分成** | 链上（FeeDistributor + ContributorReward） | 手机钱包查看余额 + 签名领取 | ❌ 否 |
| **链上成交/结算记录** | 链上（Settlement 事件） | 前端查询显示（ethers/viem） | ❌ 否 |
| **个人挂单/撮合/历史** | IndexedDB（手机本地）+ 链上确认后同步 | 浏览器/PWA 自动读取，重启不丢 | ❌ 否 |
| **未确认订单广播** | P2P 网络（GossipSub + DHT） | 手机轻客户端短暂参与（js-libp2p） | ⚠️ 否（但网络需有人跑完整节点） |
| **节点运行者奖励** | 链上分成 | 需跑节点才能赚；手机用户无法赚此部分 | ✅ 是（需 VPS/电脑） |

---

## 六、结论

### ✅ 专注手机完全可行

**核心价值（手续费分成）**：
- ✅ 保存在链上，手机钱包就能查看/领取
- ✅ 无需跑节点，只要地址在 Governance 里被设置成受益人
- ✅ 链上自动执行，透明可治理

**本地数据**：
- ✅ IndexedDB 保证离线体验
- ✅ 快速加载，避免重复查询链上
- ✅ PWA 支持，数据持久化

**唯一牺牲**：
- ⚠️ "跑节点赚额外奖励"——这部分可以让少数人（开发者或 VPS）承担
- ⚠️ 不影响主流手机用户的核心功能（交易、撮合、领取分成）

### 📱 手机用户能做什么

1. ✅ **交易和撮合**：通过 PWA 挂单、撮合、结算
2. ✅ **查看贡献**：查看自己的分成余额和交易历史
3. ✅ **领取分成**：通过手机钱包签名领取分成
4. ✅ **参与治理**：投票、提案（如果地址在活跃集内）

### 🖥️ 需要节点运行者做什么

1. ✅ **运行节点**：在 VPS 上运行 Go + libp2p 节点
2. ✅ **维护网络**：确保 P2P 网络活跃，订单能正常广播
3. ✅ **获得奖励**：获得节点运行者分成（小比例）

---

## 七、实现建议

### 7.1 前端"我的贡献"页面

**功能**：
- 显示分成余额（从 FeeDistributor 查询）
- 显示交易历史（从 Settlement 事件查询）
- 显示本地挂单记录（从 IndexedDB 读取）
- "领取分成"按钮（调用 ContributorReward 合约）

**实现位置**：
- `frontend/src/components/ContributionSection.tsx`（已有，需增强）
- `frontend/src/hooks/useContribution.ts`（新建）

### 7.2 IndexedDB 数据结构

**建议结构**：
```typescript
interface LocalData {
  orders: Order[]           // 挂单记录
  trades: Trade[]          // 撮合记录
  contribution: {           // 贡献缓存
    balance: bigint        // 分成余额（缓存）
    lastSync: number      // 最后同步时间
  }
}
```

### 7.3 链上查询优化

**缓存策略**：
- IndexedDB 缓存链上查询结果（如分成余额）
- 30 秒自动刷新
- 用户手动刷新按钮

---

## 八、相关文档

- [手机端开发指南](./手机端开发指南.md)
- [项目价值与定位](./项目价值与定位.md)
- [贡献奖励接口](./贡献奖励接口.md)
- [治理部署与提案执行指南](./治理部署与提案执行指南.md)

---

*本文档说明专注手机端时的架构设计和数据保存策略，确保手机用户能完整使用所有核心功能。*
