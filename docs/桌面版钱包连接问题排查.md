# 桌面版钱包连接问题排查

> **说明**：本文档已合并至 [桌面版钱包连接无反应排查](./桌面版钱包连接无反应排查.md)，仅保留供参考。项目已放弃电脑端，以 PWA/浏览器为主。

---

## 问题描述

桌面版（Electron）无法检测到 MetaMask 钱包。

## 可能原因

1. **MetaMask 扩展未安装**
2. **扩展路径未找到**（Electron 从 Chrome/Edge 加载扩展）
3. **扩展注入延迟**（需要等待扩展初始化）
4. **contextIsolation 隔离**（扩展注入的 window.ethereum 可能被隔离）

## 已实施的修复

### 1. 改进扩展加载逻辑
- 添加了详细的错误日志
- 显示扩展查找路径
- 等待扩展初始化完成

### 2. 改进钱包检测
- 在 Electron 中直接访问 `window.ethereum`
- 添加重试机制（最多等待 2 秒）
- 改进错误提示信息

### 3. 添加调试信息
- 在控制台显示扩展加载状态
- 检查扩展是否在页面中可用

## 排查步骤

### 步骤 1：检查 MetaMask 是否已安装

1. **打开 Chrome 或 Edge**
2. **访问**：`chrome://extensions/` 或 `edge://extensions/`
3. **确认**：MetaMask 已安装并启用

### 步骤 2：检查扩展路径

Electron 会在以下位置查找 MetaMask：

**Windows**：
- `%LOCALAPPDATA%\Google\Chrome\User Data\Default\Extensions\nkbihfbeogaeaoehlefnkodbefgpgknn`
- `%LOCALAPPDATA%\Microsoft\Edge\User Data\Default\Extensions\nkbihfbeogaeaoehlefnkodbefgpgknn`

**检查方法**：
```powershell
# 检查 Chrome
Test-Path "$env:LOCALAPPDATA\Google\Chrome\User Data\Default\Extensions\nkbihfbeogaeaoehlefnkodbefgpgknn"

# 检查 Edge
Test-Path "$env:LOCALAPPDATA\Microsoft\Edge\User Data\Default\Extensions\nkbihfbeogaeaoehlefnkodbefgpgknn"
```

### 步骤 3：查看 Electron 控制台日志

运行桌面应用时，查看控制台输出：

```
✅ MetaMask 扩展已加载: ...
✅ MetaMask 扩展在页面中可用: ...
```

如果看到：
```
⚠️ MetaMask 扩展未找到
```
说明扩展路径未找到。

### 步骤 4：检查页面中的 window.ethereum

在 Electron 开发者工具中（开发模式自动打开）：

```javascript
// 在控制台执行
console.log('window.ethereum:', window.ethereum)
```

如果返回 `undefined`，说明扩展未注入。

## 解决方案

### 方案 1：重新安装 MetaMask（推荐）

1. **在 Chrome/Edge 中重新安装 MetaMask**
2. **确保 MetaMask 已启用**
3. **重启桌面应用**

### 方案 2：手动指定扩展路径

如果扩展安装在非默认位置，可以修改 `main.js` 中的 `findMetaMaskPath()` 函数。

### 方案 3：使用浏览器版本

如果桌面版无法连接，可以使用浏览器版本：
- 访问：https://p2p-p2p.github.io/p2p/
- 在浏览器中直接使用 MetaMask

### 方案 4：检查 Electron 版本

确保 Electron 版本支持扩展加载：
- 当前版本：33.4.11（支持）

## 调试代码

在 `App.tsx` 中添加调试代码：

```typescript
useEffect(() => {
  if (isElectron()) {
    console.log('Electron 环境检测')
    console.log('window.ethereum:', (window as any).ethereum)
    
    // 等待扩展注入
    setTimeout(() => {
      console.log('2秒后 window.ethereum:', (window as any).ethereum)
    }, 2000)
  }
}, [])
```

## 常见错误消息

### "桌面版无法检测到 MetaMask"
- **原因**：扩展未加载或未注入
- **解决**：确保 MetaMask 已安装并启用，重启应用

### "请安装 MetaMask 或其他钱包扩展"
- **原因**：`window.ethereum` 不存在
- **解决**：检查扩展是否已正确加载

## 技术细节

### Electron 扩展加载流程

1. **查找扩展路径**：在 Chrome/Edge 的扩展目录中查找
2. **加载扩展**：使用 `session.loadExtension()`
3. **等待注入**：扩展需要时间注入 `window.ethereum`
4. **检测可用性**：在页面中检查 `window.ethereum`

### contextIsolation 的影响

当 `contextIsolation: true` 时：
- 扩展注入的 `window.ethereum` 应该仍然可用
- 但可能需要等待扩展初始化完成
- preload 脚本无法直接访问扩展注入的对象

## 相关文件

- `frontend/electron/main.js` - 扩展加载逻辑
- `frontend/electron/preload.cjs` - Preload 脚本
- `frontend/src/utils.ts` - 钱包检测函数
- `frontend/src/App.tsx` - 钱包连接逻辑
