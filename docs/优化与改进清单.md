# 优化与改进清单

> 基于项目当前状态和用户反馈，整理的关键优化点和技术债务

---

## 一、P2P 节点与 MatchEngine（高优先级）

### 1.1 性能瓶颈优化

| 问题 | 影响 | 优先级 | 难度 | 解决方案 |
|------|------|--------|------|----------|
| **节点重启后订单簿同步** | 节点重启后订单簿丢失，需要重新从网络同步 | 🔴 高 | 中 | 实现订单簿持久化存储（LevelDB/RocksDB），启动时从本地恢复 + 网络同步 |
| **GossipSub 延迟** | 订单广播延迟影响撮合速度 | 🟡 中 | 中 | 优化 GossipSub 参数（heartbeat、fanout、D），添加本地缓存减少网络依赖 |
| **Spam 防护** | 恶意节点发送大量无效订单 | 🔴 高 | 高 | 实现订单签名验证、速率限制、信誉机制、黑名单 |

**实现建议**：
- 订单簿持久化：在 `node/internal/storage/` 中添加订单簿快照功能
- GossipSub 优化：调整 `node/internal/p2p/` 中的 GossipSub 配置
- Spam 防护：在 `node/internal/match/` 中添加订单验证和限流逻辑

**相关文档**：
- [P2P节点整合交易撮合指南](./P2P节点整合交易撮合指南.md)
- [多节点与共识实现指南](./多节点与共识实现指南.md)

---

### 1.2 一致性问题

| 问题 | 影响 | 优先级 | 难度 | 解决方案 |
|------|------|--------|------|----------|
| **订单簿状态不一致** | 不同节点看到的订单簿可能不同 | 🔴 高 | 高 | 实现订单簿同步协议、定期校验、冲突解决机制 |
| **撮合结果不一致** | 不同节点可能产生不同的撮合结果 | 🔴 高 | 高 | 实现确定性撮合算法、BFT 共识（Phase 3 方案 C） |

**实现建议**：
- 参考 [多节点与共识设计](./多节点与共识设计.md) 中的方案 C
- 实现订单簿校验和同步机制
- 添加单元测试和集成测试

---

## 二、手机端体验优化（高优先级）

### 2.1 WalletConnect / Deep Link 稳定性

| 问题 | 影响 | 优先级 | 难度 | 解决方案 |
|------|------|------|------|----------|
| **WalletConnect 连接不稳定** | 用户无法连接钱包，体验差 | 🔴 高 | 中 | 使用 wagmi + RainbowKit 升级连接，添加重试机制、错误提示优化 |
| **Deep Link 跳转失败** | 从网页跳转到钱包 App 失败 | 🟡 中 | 中 | 实现多种 deep link 格式、fallback 机制、用户引导、内置浏览器优先提示 |
| **打开钱包失败** | 点击连接钱包无反应 | 🔴 高 | 低 | 已部分修复，需要进一步优化错误处理和用户提示 |

**实现建议**：
- 使用 `wagmi` + `@rainbow-me/rainbowkit` 升级钱包连接（2026 年最佳实践）
- RainbowKit 自动处理 deep link、QR、移动重定向
- 优先使用 deep link 直接打开钱包 App
- 失败时 fallback 到 QR 码 + 手动扫码
- 添加手机端提示："推荐在 MetaMask/Trust App 内置浏览器打开链接"（成功率 95%+）
- 自动添加网络（`wallet_addEthereumChain`）
- 添加"断开所有 WalletConnect 会话"功能

**用户侧 Workaround（无需改代码）**：
- 先手动打开钱包 App
- 在钱包 App 内置浏览器输入链接
- 在内置浏览器点击 Connect（绕过外部浏览器 deep link 限制）

**预期效果**：
- 手机连接成功率提升到 90%+（主流 DEX 如 Uniswap 也用类似方式）
- 强化"手机优先"定位

**相关文档**：
- [桌面版钱包连接无反应排查](./桌面版钱包连接无反应排查.md)
- [手机端开发指南](./手机端开发指南.md)

---

### 2.2 PWA 完善

| 功能 | 优先级 | 难度 | 说明 |
|------|--------|------|------|
| **Manifest 优化** | 🟡 中 | 低 | 完善 `frontend/public/manifest.webmanifest`，添加图标、主题色、启动画面 |
| **Service Worker** | 🟡 中 | 中 | 实现离线缓存、资源预加载、更新机制 |
| **离线体验** | 🟢 低 | 高 | 支持离线查看订单簿、离线下单（上线后同步） |

**实现建议**：
- 检查并完善 `frontend/public/manifest.webmanifest`
- 在 `frontend/vite.config.ts` 中配置 PWA 插件（如 `vite-plugin-pwa`）
- 实现 Service Worker 缓存策略

### 2.3 价格参考集成（新增）

| 功能 | 优先级 | 难度 | 说明 |
|------|--------|------|------|
| **实时市场价显示** | 🔴 高 | 低 | 在 Swap 表单和订单簿旁显示 CoinGecko 市场参考价，让用户挂限价单时有基准 |
| **价格对比** | 🔴 高 | 低 | 显示 P2P 撮合价 vs 市场价，突出"零滑点限价"优势 |

**实现建议**：
- 创建 `frontend/src/hooks/useTokenPrice.ts` Hook
- 使用 CoinGecko API 获取 TKA/TKB 的 USD 价格和 24h 变化
- 在 Swap 组件和订单簿组件中显示参考价
- 30 秒自动刷新价格

**预期效果**：
- 用户能看到市场参考价，避免盲目定价
- 直观对比"零滑点限价" vs 主流钱包的 AMM 滑点（0.5%+）
- 强化项目差异化优势

**实现时间**：< 1 天

**相关代码位置**：
- `frontend/src/hooks/useTokenPrice.ts`（新建）
- `frontend/src/components/OrderForm.tsx`（更新）
- `frontend/src/OrderBookSection.tsx`（更新）

---

## 三、多链扩展（中优先级）

### 3.1 链配置结构优化

| 问题 | 优先级 | 难度 | 解决方案 |
|------|--------|------|----------|
| **Config 结构** | 🟡 中 | 中 | 统一链配置结构，支持动态添加链、RPC 轮询、链切换 |
| **自动添加网络** | 🟡 中 | 低 | 实现 `wallet_addEthereumChain` 自动调用，用户一键添加网络 |
| **Gas 估算** | 🟡 中 | 中 | 实现多链 gas 价格查询、交易前 gas 估算、gas 优化建议 |

**实现建议**：
- 优化 `frontend/src/config/chains.ts` 的配置结构
- 在 `frontend/src/components/ChainSwitcher.tsx` 中添加自动添加网络功能
- 实现 gas 价格查询服务（使用各链的 gas station API）

**相关文档**：
- [跨链功能设计](./跨链功能设计.md)
- [跨链功能实现指南](./跨链功能实现指南.md)

### 3.2 支持的链

**当前支持**：
- Ethereum Sepolia（测试网）
- Ethereum Mainnet
- Polygon Mainnet

**计划支持**：
- Arbitrum One
- Base
- Optimism
- BSC（可选）

**实现步骤**：
1. 在 `frontend/src/config/chains.ts` 中添加新链配置
2. 部署合约到新链（参考 [主网部署指南](./主网部署指南.md)）
3. 更新前端构建脚本
4. 测试链切换和交易功能

---

## 四、桌面版清理（低优先级）

### 4.1 构建清理

| 任务 | 优先级 | 难度 | 说明 |
|------|--------|------|------|
| **移除 Electron 相关代码** | 🟢 低 | 中 | 如果决定去掉桌面版，需要清理 Electron 相关代码和依赖 |
| **清理构建脚本** | 🟢 低 | 低 | 移除 `package.json` 中的 `electron:build` 等脚本 |
| **更新文档** | 🟢 低 | 低 | 更新 README 和相关文档，移除桌面版说明 |

**注意**：根据项目定位（手机优先），桌面版可以作为可选功能保留，但不应作为主要入口。

---

## 五、贡献分与手续费分成（中优先级）

### 5.1 Governance 提案逻辑

| 功能 | 优先级 | 难度 | 说明 |
|------|--------|------|------|
| **手续费分成提案** | 🟡 中 | 高 | 实现通过 Governance 提案设置手续费分成比例和分配对象 |
| **链上分成实现** | 🟡 中 | 高 | 在 `FeeDistributor` 合约中实现按提案自动分配手续费 |

**实现建议**：
- 参考 [DAO扩展设计](./DAO扩展设计.md) 和 [DAO扩展实现指南](./DAO扩展实现指南.md)
- 在 `contracts/src/FeeDistributor.sol` 中添加治理控制的分成逻辑
- 实现提案模板和投票机制

**相关文档**：
- [治理部署与提案执行指南](./治理部署与提案执行指南.md)
- [流动性贡献分设计](./流动性贡献分设计.md)

### 5.2 手续费透明化（新增）

| 功能 | 优先级 | 难度 | 说明 |
|------|--------|------|------|
| **手续费显示** | 🔴 高 | 低 | 在结算/撮合页面显示"预计手续费"（平台 0.5% + Gas 估算） |
| **分成去向标注** | 🔴 高 | 低 | 显示手续费分成去向（e.g., 20% 给节点/开发者），突出自定义分成 vs 主流钱包的"黑箱费" |

**实现建议**：
- 创建 `frontend/src/hooks/useGasEstimate.ts` Hook
- 使用 ethers 估算 gas 费用
- 在交易确认页面显示：
  - 平台手续费：0.5%
  - Gas 费用：${gas * gasPrice}（relayer 代付）
  - 分成去向：20% 节点、30% 开发者、50% 流动性提供者
- 对比主流钱包："主流钱包：0.5% + 隐含滑点 0.5%+，我们：0.5% + 零滑点"

**预期效果**：
- 用户看到透明费用结构
- 突出"自定义分成"的差异化优势
- 强化"去中心化 + 可持续"的项目意义

**实现时间**：< 1 天

**相关代码位置**：
- `frontend/src/hooks/useGasEstimate.ts`（新建）
- `frontend/src/components/OrderForm.tsx`（更新）
- `frontend/src/OrderBookSection.tsx`（更新）

### 5.3 公开数据展示（新增）

| 功能 | 优先级 | 难度 | 说明 |
|------|--------|------|------|
| **流动性池余额** | 🔴 高 | 低 | 所有人可见，显示 Token A/B 储备量和 TVL |
| **奖励池余额** | 🔴 高 | 低 | 显示 FeeDistributor 中的待分发奖励 |
| **交易记录** | 🔴 高 | 中 | 显示最近交易记录，连接钱包后可过滤"我的交易" |

**实现建议**：
- 创建 `LiquidityPoolInfo`、`RewardPoolInfo`、`TradeHistory` 组件
- 使用 `wagmi` 的 `useContractRead`（无需签名，访客可见）
- 实时刷新（10-30 秒）
- 手机端卡片布局

**预期效果**：
- 符合 DeFi 透明性原则
- 让用户感受到"平台不黑箱"
- 提升信任度和用户体验

**实现时间**：1-2 天

**相关文档**：
- [公开数据展示实现指南](./公开数据展示实现指南.md)

### 5.4 贡献分领取机制（新增）

| 功能 | 优先级 | 难度 | 说明 |
|------|--------|------|------|
| **统一奖励领取** | 🔴 高 | 中 | 同一个钱包可同时领取开发者积分和节点奖励，避免多钱包管理 |
| **手动领取** | 🔴 高 | 低 | 手机钱包签名一次即可领取，推荐先实现 |
| **每周自动领取** | 🟡 中 | 中 | 用 Chainlink Keeper 实现每周自动发放，真正做到"躺赚" |

**实现建议**：
- **统一奖励机制**（推荐）：
  - 扩展 `ContributorReward` 合约，支持开发者积分 + 节点奖励统一领取
  - 钱包绑定机制：前端绑定 + 节点启动时绑定
  - 一键领取所有奖励（开发者积分 + 节点积分 + 手续费分成）
- **手动领取**：
  - 创建 `UnifiedRewardClaim` 组件
  - 使用 `wagmi` 的 `useContractWrite` 调用 `claimRewards()` 函数
  - 手机端按钮大、触控友好（≥48px）
  - 显示各类奖励明细和总奖励
- **自动领取**：
  - 用 Chainlink Keeper 实现每周自动发放
  - 提升用户粘性和信任感

**预期效果**：
- 避免多钱包管理，减少领取摩擦
- 激励开发者既贡献代码又运行节点（双重身份）
- 用户能立即看到并领取奖励
- 强化"去中心化 + 可持续"的项目意义

**实现时间**：
- 统一奖励机制：1-2 周
- 手动领取：1 天
- 自动领取：1-2 周（需要 Chainlink Keeper）

**相关文档**：
- [贡献分领取机制实现指南](./贡献分领取机制实现指南.md)
- [上线奖励分发机制实现指南](./上线奖励分发机制实现指南.md#七统一奖励领取机制推荐实现)

---

## 六、安全加固（高优先级）

### 6.1 订单签名验证

| 问题 | 优先级 | 难度 | 解决方案 |
|------|--------|------|----------|
| **订单签名验证** | 🔴 高 | 中 | 在节点和前端都实现 EIP-712 签名验证，拒绝无效订单 |
| **Replay Attack 防护** | 🔴 高 | 中 | 实现 nonce 机制、订单过期时间、链上订单状态检查 |
| **Relayer 防滥用** | 🔴 高 | 高 | 实现 relayer 白名单、gas 限制、费用回收机制 |

**实现建议**：
- 在 `frontend/src/services/orderVerification.ts` 中完善签名验证
- 在 `node/internal/match/` 中添加订单验证逻辑
- 在 `contracts/src/Settlement.sol` 中添加 replay attack 防护

**相关文档**：
- [P2P节点整合交易撮合指南 - EIP-712 签名](./P2P节点整合交易撮合指南.md#eip-712-签名)

---

## 七、测试与部署（高优先级）

### 7.1 主网上线 Checklist

| 检查项 | 优先级 | 状态 | 说明 |
|--------|--------|------|------|
| **合约审计** | 🔴 高 | ⏳ 待做 | 进行安全审计，修复漏洞 |
| **Gas 优化** | 🔴 高 | ⏳ 待做 | 优化合约 gas 消耗，降低交易成本 |
| **合约验证** | 🔴 高 | ⏳ 待做 | 在 Etherscan 等区块浏览器验证合约源码 |
| **测试覆盖** | 🔴 高 | ⏳ 待做 | 提高测试覆盖率，添加集成测试 |
| **文档完善** | 🟡 中 | ✅ 部分完成 | 完善部署和使用文档 |

**实现建议**：
- 参考 [主网试运行指南](./主网试运行指南.md) 中的检查清单
- 使用 Foundry 进行合约测试和 gas 优化
- 使用 Hardhat 或 Foundry 进行合约验证

**相关文档**：
- [主网部署指南](./主网部署指南.md)
- [主网试运行指南](./主网试运行指南.md)

---

## 八、性能监控（中优先级）

### 8.1 监控系统搭建

| 功能 | 优先级 | 难度 | 说明 |
|------|--------|------|------|
| **Prometheus + Grafana** | 🟡 中 | 中 | 搭建监控系统，收集节点和 MatchEngine 指标 |
| **MatchEngine TPS** | 🟡 中 | 低 | 监控订单撮合吞吐量（每秒处理订单数） |
| **延迟指标** | 🟡 中 | 低 | 监控订单广播延迟、撮合延迟、链上结算延迟 |

**实现建议**：
- 在 `node/internal/metrics/` 中添加 Prometheus 指标导出
- 使用 Docker Compose 部署 Prometheus + Grafana
- 创建监控仪表板，展示关键指标

**相关文档**：
- [节点部署](./节点部署.md)

---

## 十、上线奖励分发机制（中优先级）

### 10.1 节点绑定钱包

| 方式 | 优先级 | 难度 | 说明 |
|------|--------|------|------|
| **配置文件绑定** | 🟡 中 | 低 | 在 config.yaml 中添加 REWARD_WALLET，零链上成本 |
| **链上注册** | 🟡 中 | 中 | NodeRegistry 合约，防作弊、可验证 |
| **前端/CLI 绑定** | 🟡 中 | 低 | 用户友好的绑定界面 |

**实现建议**：
- 推荐选项 A + B 结合：配置文件 + 链上注册
- 创建 NodeRegistry 合约
- 节点启动时自动注册到链上
- 前端添加"节点管理"页面（可选）

**预期效果**：
- 节点运营者绑定钱包，上线时自动发放奖励
- 提升节点运营者积极性
- 项目上线的一大亮点

### 10.2 批量发放方式

| 方式 | 优先级 | 难度 | 说明 |
|------|--------|------|------|
| **Merkle Airdrop** | 🟡 中 | 中 | Gas 高效，用户按需领取 |
| **批量 Multisig 推送** | 🟡 中 | 低 | 简单直接，无需用户操作 |
| **自动从 FeeDistributor** | 🟡 中 | 中 | 可持续，无需预存资金 |

**实现建议**：
- 推荐 Merkle Airdrop（Gas 高效）
- 上线前生成 Merkle Tree
- 前端添加领取界面
- Governance 提案批准奖励池

**实施时间**：1-2 周

**相关文档**：
- [上线奖励分发机制实现指南](./上线奖励分发机制实现指南.md)

---

## 九、优先级总结

### 🔴 高优先级（立即处理）

1. **价格参考集成**：CoinGecko API 显示市场价，突出零滑点优势（< 1 天）
2. **手续费透明化**：显示费用结构和分成去向（< 1 天）
3. **手机端连接优化**：wagmi + RainbowKit 升级，提升连接成功率到 90%+（1-2 小时）
4. **公开数据展示**：流动性池余额、奖励池余额、交易记录（1-2 天）
5. **贡献分手动领取**：手机端友好的领取界面（1 天）
6. **P2P 节点性能优化**：订单簿持久化、GossipSub 延迟优化
7. **Spam 防护**：订单签名验证、速率限制
8. **安全加固**：Replay attack 防护、relayer 防滥用
9. **主网上线准备**：合约审计、gas 优化、测试覆盖

### 🟡 中优先级（近期处理）

1. **上线奖励分发机制**：节点绑定钱包 + 批量空投（1-2 周）
2. **多链扩展**：Arbitrum/Base/Optimism 支持
3. **性能监控**：Prometheus + Grafana 搭建
4. **贡献分自动领取**：Chainlink Keeper 每周自动发放（1-2 周）
5. **PWA 完善**：Service Worker、离线体验

### 🟡 中优先级（近期处理）

1. **多链扩展**：Arbitrum/Base/Optimism 支持
2. **性能监控**：Prometheus + Grafana 搭建
3. **贡献分与分成**：Governance 提案逻辑完善
4. **PWA 完善**：Service Worker、离线体验

### 🟢 低优先级（长期规划）

1. **桌面版清理**：如果决定去掉桌面版
2. **离线体验**：完整的离线功能支持

---

## 十、实现建议

### 10.1 分阶段实施

**第一阶段（1-2 周）**：
- 订单簿持久化
- 订单签名验证
- WalletConnect 连接优化

**第二阶段（2-4 周）**：
- Spam 防护机制
- 多链扩展（Arbitrum/Base）
- 性能监控搭建

**第三阶段（1-2 月）**：
- Governance 提案逻辑完善
- 主网上线准备
- PWA 完善

### 10.2 技术选型建议

- **订单簿存储**：LevelDB（Go）或 IndexedDB（前端）
- **监控系统**：Prometheus + Grafana
- **Gas 价格查询**：各链的 gas station API 或链上查询
- **PWA 插件**：`vite-plugin-pwa`

---

## 十一、相关文档

- [项目价值与定位](./项目价值与定位.md) - 了解项目当前最缺的要素
- [待实现功能清单](./待实现功能清单.md) - 功能层面的待实现项
- [规划与路线图](./规划与路线图.md) - 项目整体规划
- [技术架构说明](./技术架构说明.md) - 技术架构参考

---

*本文档随项目进展持续更新，反映最新的优化需求和优先级。*
