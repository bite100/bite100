# 价格与结算服务使用说明

结算周期内需用到「按日去极值再周平均」的周均价（见 [贡献奖励接口](贡献奖励接口.md)）。可用 `pricefeed` 从 JSON 或 CoinGecko 拉取价格并计算周均价，供链下结算或文档示例。

---

## 一、从 CoinGecko 拉取周均价（推荐）

### 1. 安装与运行

```bash
cd node
go run ./cmd/pricefeed -source coingecko -coin ethereum -days 7
```

`-coin` 使用 CoinGecko 的 coin id，例如：

| 代币   | coin id     |
|--------|-------------|
| ETH    | ethereum    |
| USDC   | usd-coin    |
| USDT   | tether      |
| WETH   | weth        |

### 2. 输出示例

实际运行示例（ETH 过去 7 天）：

```
周均价（trim 5%）: 2231.309951186732178030
```

即过去 7 天按「每日去掉最高/最低 5% 采样价后取日均，再对 7 天日均取算术平均」得到的价格，可直接用于当周结算或文档示例。

### 3. 可选参数

- `-days 7`：拉取天数（默认 7）
- `-trim 5`：日去极值比例，默认 5（表示两端各 5%）

---

## 二、从 JSON 文件读取（手动或脚本生成）

适用于自有数据源或测试。

### 1. JSON 格式

`prices.json`：

```json
{
  "dailyPrices": [
    [1.01, 1.02, 1.00, 1.015, 1.02],
    [1.02, 1.01, 1.03, 1.02, 1.01],
    [1.00, 1.01, 0.99, 1.00, 1.01],
    [1.02, 1.03, 1.01, 1.02, 1.02],
    [1.01, 1.00, 1.02, 1.01, 1.00],
    [1.00, 1.02, 1.01, 1.00, 1.01],
    [1.01, 1.01, 1.02, 1.00, 1.01]
  ]
}
```

- `dailyPrices`：长度为 7 的数组，对应一周 7 天  
- 每个元素为当日多个采样价（可任意长度）

### 2. 运行

```bash
go run ./cmd/pricefeed -input prices.json
# 或指定去极值比例
go run ./cmd/pricefeed -input prices.json -trim 5
```

---

## 三、接到链下结算脚本示例

将周均价写入环境变量或文件，供后续脚本使用：

```bash
# 获取 ETH 周均价并写入变量
AVG_ETH=$(go run ./cmd/pricefeed -source coingecko -coin ethereum -days 7 | awk '{print $NF}')
echo "ETH 周均价: $AVG_ETH"

# 获取 USDC 周均价（稳定币通常≈1）
AVG_USDC=$(go run ./cmd/pricefeed -source coingecko -coin usd-coin -days 7 | awk '{print $NF}')
echo "USDC 周均价: $AVG_USDC"
```

结算逻辑中可用上述价格将「当周可分配奖励池价值」按稳定币计价，再按贡献分占比计算每份价值与可领取额度（详见 [贡献奖励接口](贡献奖励接口.md)）。

---

## 四、说明

- CoinGecko 公开 API 有速率限制，生产环境可考虑缓存或付费方案。  
- 链上结算若需「按兑换时价格」或自由流动部分按市价，需另行接入预言机或链下价格服务，与 `pricefeed` 配合使用。
