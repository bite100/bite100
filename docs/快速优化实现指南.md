# å¿«é€Ÿä¼˜åŒ–å®ç°æŒ‡å—

> åŸºäºç”¨æˆ·åé¦ˆå’Œé¡¹ç›®å®šä½ï¼Œæ•´ç†çš„é«˜ä¼˜å…ˆçº§å¿«é€Ÿä¼˜åŒ–æ–¹æ¡ˆï¼ˆ1-2 å¤©å¯å®Œæˆï¼‰

---

## ä¸€ã€ä»·æ ¼å‚è€ƒé›†æˆï¼ˆ< 1 å¤©ï¼‰

### 1.1 ç›®æ ‡

åœ¨ Swap è¡¨å•å’Œè®¢å•ç°¿æ—æ˜¾ç¤º CoinGecko å¸‚åœºå‚è€ƒä»·ï¼Œè®©ç”¨æˆ·æŒ‚é™ä»·å•æ—¶æœ‰åŸºå‡†ï¼Œçªå‡º"é›¶æ»‘ç‚¹é™ä»·" vs ä¸»æµé’±åŒ…çš„ AMM æ»‘ç‚¹ä¼˜åŠ¿ã€‚

### 1.2 å®ç°æ­¥éª¤

#### æ­¥éª¤ 1ï¼šå®‰è£…ä¾èµ–

```bash
cd frontend
npm install axios
```

#### æ­¥éª¤ 2ï¼šåˆ›å»ºä»·æ ¼ Hook

åˆ›å»º `frontend/src/hooks/useTokenPrice.ts`ï¼š

```typescript
import { useState, useEffect } from 'react'
import axios from 'axios'

interface TokenPrice {
  usd: number
  usd_24h_change: number
}

interface UseTokenPriceResult {
  price: TokenPrice | null
  loading: boolean
  error: Error | null
}

/**
 * è·å–ä»£å¸ä»·æ ¼ï¼ˆCoinGecko APIï¼‰
 * @param tokenId CoinGecko ä»£å¸ IDï¼ˆå¦‚ 'ethereum', 'tether'ï¼‰
 * @param refreshInterval åˆ·æ–°é—´éš”ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤ 30 ç§’
 */
export function useTokenPrice(
  tokenId: string,
  refreshInterval: number = 30000
): UseTokenPriceResult {
  const [price, setPrice] = useState<TokenPrice | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<Error | null>(null)

  useEffect(() => {
    const fetchPrice = async () => {
      try {
        setLoading(true)
        setError(null)
        
        // CoinGecko å…è´¹ APIï¼ˆæ— éœ€ keyï¼Œä½†æœ‰é€Ÿç‡é™åˆ¶ï¼‰
        const res = await axios.get(
          `https://api.coingecko.com/api/v3/simple/price`,
          {
            params: {
              ids: tokenId,
              vs_currencies: 'usd',
              include_24hr_change: true,
            },
          }
        )

        const data = res.data[tokenId]
        if (data) {
          setPrice({
            usd: data.usd || 0,
            usd_24h_change: data.usd_24h_change || 0,
          })
        } else {
          setError(new Error(`Token ${tokenId} not found`))
        }
      } catch (err) {
        console.error('Price fetch failed:', err)
        setError(err instanceof Error ? err : new Error('Failed to fetch price'))
      } finally {
        setLoading(false)
      }
    }

    fetchPrice()
    const interval = setInterval(fetchPrice, refreshInterval)
    return () => clearInterval(interval)
  }, [tokenId, refreshInterval])

  return { price, loading, error }
}

/**
 * è·å–å¤šä¸ªä»£å¸ä»·æ ¼
 */
export function useTokenPrices(
  tokenIds: string[],
  refreshInterval: number = 30000
): Record<string, UseTokenPriceResult> {
  const results: Record<string, UseTokenPriceResult> = {}
  
  tokenIds.forEach((id) => {
    results[id] = useTokenPrice(id, refreshInterval)
  })
  
  return results
}
```

#### æ­¥éª¤ 3ï¼šåœ¨ Swap ç»„ä»¶ä¸­ä½¿ç”¨

æ›´æ–° `frontend/src/components/OrderForm.tsx`ï¼š

```typescript
import { useTokenPrice } from '../hooks/useTokenPrice'

// åœ¨ç»„ä»¶ä¸­
const { price: tokenAPrice, loading: loadingA } = useTokenPrice('your-tka-coingecko-id')
const { price: tokenBPrice, loading: loadingB } = useTokenPrice('your-tkb-coingecko-id')

// åœ¨ JSX ä¸­æ˜¾ç¤º
{loadingA || loadingB ? (
  <span className="text-sm text-gray-500">åŠ è½½å‚è€ƒä»·...</span>
) : (
  <div className="text-sm">
    <span className="text-gray-600">å¸‚åœºå‚è€ƒä»·: </span>
    <span className="font-medium">
      ${tokenAPrice?.usd.toFixed(4)} / ${tokenBPrice?.usd.toFixed(4)}
    </span>
    {tokenAPrice?.usd_24h_change !== undefined && (
      <span className={`ml-2 ${tokenAPrice.usd_24h_change >= 0 ? 'text-green-600' : 'text-red-600'}`}>
        ({tokenAPrice.usd_24h_change >= 0 ? '+' : ''}{tokenAPrice.usd_24h_change.toFixed(2)}%)
      </span>
    )}
    <span className="text-gray-500 ml-2">
      Â· P2P é›¶æ»‘ç‚¹é™ä»·å• vs ä¸»æµé’±åŒ… AMM æ»‘ç‚¹ 0.5%+
    </span>
  </div>
)}
```

#### æ­¥éª¤ 4ï¼šåœ¨è®¢å•ç°¿ä¸­æ˜¾ç¤º

æ›´æ–° `frontend/src/OrderBookSection.tsx`ï¼Œåœ¨è®¢å•ç°¿é¡¶éƒ¨æ˜¾ç¤ºå‚è€ƒä»·ã€‚

### 1.3 CoinGecko ä»£å¸ ID é…ç½®

åœ¨ `frontend/src/config/tokens.ts` ä¸­æ·»åŠ ï¼š

```typescript
export const COINGECKO_TOKEN_IDS: Record<string, string> = {
  // Sepolia æµ‹è¯•ä»£å¸ï¼ˆéœ€è¦æ›¿æ¢ä¸ºå®é™… CoinGecko IDï¼‰
  '0x678195277dc8F84F787A4694DF42F3489eA757bf': 'ethereum', // TKA ç¤ºä¾‹
  '0x9Be241a0bF1C2827194333B57278d1676494333a': 'tether',   // TKB ç¤ºä¾‹
}
```

### 1.4 æµ‹è¯•

1. å¼€å‘ç¯å¢ƒæµ‹è¯•ï¼š`npm run dev`
2. æ£€æŸ¥ä»·æ ¼æ˜¯å¦æ­£ç¡®æ˜¾ç¤º
3. æµ‹è¯•ç½‘ç»œé”™è¯¯å¤„ç†
4. éªŒè¯ 30 ç§’è‡ªåŠ¨åˆ·æ–°

### 1.5 ä¸Šçº¿åä¼˜åŒ–

- ç”³è¯· CoinGecko Pro API keyï¼ˆæé«˜é€Ÿç‡é™åˆ¶ï¼‰
- æ·»åŠ ä»·æ ¼ç¼“å­˜ï¼ˆå‡å°‘ API è°ƒç”¨ï¼‰
- æ”¯æŒå¤šä¸ªä»·æ ¼æºï¼ˆCoinGeckoã€CoinMarketCap ç­‰ï¼‰

---

## äºŒã€æ‰‹æœºç«¯é’±åŒ…é›†æˆä¼˜åŒ–ï¼ˆ1 å¤©ï¼‰

### 2.1 ç›®æ ‡

ä½¿ç”¨ wagmi + RainbowKit å‡çº§é’±åŒ…è¿æ¥ï¼Œæå‡æ‰‹æœºè¿æ¥æˆåŠŸç‡ 30%+ï¼Œå¼ºåŒ–"æ‰‹æœºä¼˜å…ˆ"å®šä½ã€‚

### 2.2 å®ç°æ­¥éª¤

#### æ­¥éª¤ 1ï¼šå®‰è£…ä¾èµ–

```bash
cd frontend
npm install wagmi viem @rainbow-me/rainbowkit @tanstack/react-query
```

#### æ­¥éª¤ 2ï¼šé…ç½® wagmi

åˆ›å»º `frontend/src/config/wagmi.ts`ï¼š

```typescript
import { getDefaultConfig } from '@rainbow-me/rainbowkit'
import { sepolia, mainnet, polygon } from 'wagmi/chains'
import { getChainConfig } from './chains'

// è·å–å½“å‰é“¾é…ç½®
const currentChain = getChainConfig(11155111) // Sepolia

export const wagmiConfig = getDefaultConfig({
  appName: 'P2P DEX',
  projectId: 'your-walletconnect-project-id', // ä» WalletConnect Cloud è·å–
  chains: [sepolia, mainnet, polygon],
  ssr: false,
})
```

#### æ­¥éª¤ 3ï¼šæ›´æ–°ä¸»åº”ç”¨

æ›´æ–° `frontend/src/main.tsx` æˆ– `frontend/src/App.tsx`ï¼š

```typescript
import { WagmiProvider } from 'wagmi'
import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
import { RainbowKitProvider } from '@rainbow-me/rainbowkit'
import { wagmiConfig } from './config/wagmi'
import '@rainbow-me/rainbowkit/styles.css'

const queryClient = new QueryClient()

function App() {
  return (
    <WagmiProvider config={wagmiConfig}>
      <QueryClientProvider client={queryClient}>
        <RainbowKitProvider>
          {/* ä½ çš„åº”ç”¨ç»„ä»¶ */}
        </RainbowKitProvider>
      </QueryClientProvider>
    </WagmiProvider>
  )
}
```

#### æ­¥éª¤ 4ï¼šæ·»åŠ æ‰‹æœºç«¯æç¤º

åˆ›å»º `frontend/src/components/MobileWalletHint.tsx`ï¼š

```typescript
import { useEffect, useState } from 'react'

export function MobileWalletHint() {
  const [isMobile, setIsMobile] = useState(false)

  useEffect(() => {
    setIsMobile(/iPhone|iPad|iPod|Android/i.test(navigator.userAgent))
  }, [])

  if (!isMobile) return null

  return (
    <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
      <p className="text-sm text-blue-800">
        ğŸ“± <strong>æ‰‹æœºç”¨æˆ·æç¤ºï¼š</strong>æ¨èåœ¨ MetaMask/Trust Wallet App å†…ç½®æµè§ˆå™¨æ‰“å¼€æ­¤é“¾æ¥ï¼Œè¿æ¥æˆåŠŸç‡æ›´é«˜ã€‚
      </p>
    </div>
  )
}
```

#### æ­¥éª¤ 5ï¼šè‡ªåŠ¨æ·»åŠ ç½‘ç»œ

åœ¨ `frontend/src/hooks/useChain.ts` ä¸­æ·»åŠ è‡ªåŠ¨æ·»åŠ ç½‘ç»œåŠŸèƒ½ï¼š

```typescript
import { useChainId, useSwitchChain, useAddChain } from 'wagmi'
import { getChainConfig } from '../config/chains'

export function useAutoAddChain() {
  const chainId = useChainId()
  const { switchChain } = useSwitchChain()
  const { addChain } = useAddChain()

  const ensureChain = async (targetChainId: number) => {
    const config = getChainConfig(targetChainId)
    if (!config) return

    try {
      await switchChain({ chainId: targetChainId })
    } catch (error: any) {
      // å¦‚æœé“¾ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨æ·»åŠ 
      if (error.code === 4902) {
        await addChain({
          chain: {
            id: targetChainId,
            name: config.name,
            nativeCurrency: config.nativeCurrency,
            rpcUrls: { default: { http: [config.rpcUrl] } },
            blockExplorers: config.blockExplorer
              ? { default: { name: 'Explorer', url: config.blockExplorer } }
              : undefined,
          },
        })
      }
    }
  }

  return { ensureChain }
}
```

### 2.3 WalletConnect Cloud è®¾ç½®

1. è®¿é—® https://cloud.walletconnect.com/
2. åˆ›å»ºé¡¹ç›®ï¼Œè·å– Project ID
3. å°† Project ID å¡«å…¥ `wagmi.ts` é…ç½®

### 2.4 æµ‹è¯•

1. iOS Safari æµ‹è¯•
2. Android Chrome æµ‹è¯•
3. MetaMask App å†…ç½®æµè§ˆå™¨æµ‹è¯•
4. Trust Wallet App æµ‹è¯•
5. éªŒè¯è‡ªåŠ¨æ·»åŠ ç½‘ç»œåŠŸèƒ½

---

## ä¸‰ã€æ‰‹ç»­è´¹é€æ˜åŒ–ï¼ˆ< 1 å¤©ï¼‰

### 3.1 ç›®æ ‡

åœ¨ç»“ç®—/æ’®åˆé¡µé¢æ˜¾ç¤º"é¢„è®¡æ‰‹ç»­è´¹"å’Œ"åˆ†æˆå»å‘"ï¼Œçªå‡ºè‡ªå®šä¹‰åˆ†æˆ vs ä¸»æµé’±åŒ…çš„"é»‘ç®±è´¹"ã€‚

### 3.2 å®ç°æ­¥éª¤

#### æ­¥éª¤ 1ï¼šåˆ›å»º Gas ä¼°ç®— Hook

åˆ›å»º `frontend/src/hooks/useGasEstimate.ts`ï¼š

```typescript
import { useState, useEffect } from 'react'
import { BrowserProvider, Contract } from 'ethers'
import { getProvider } from '../utils'
import { SETTLEMENT_ADDRESS, SETTLEMENT_ABI } from '../config'

interface GasEstimate {
  gasLimit: bigint
  gasPrice: bigint
  totalCost: bigint // gasLimit * gasPrice
  usdCost: number // è½¬æ¢ä¸º USDï¼ˆå¯é€‰ï¼‰
}

/**
 * ä¼°ç®—äº¤æ˜“ Gas è´¹ç”¨
 */
export function useGasEstimate(
  method: string,
  params: unknown[],
  enabled: boolean = true
) {
  const [estimate, setEstimate] = useState<GasEstimate | null>(null)
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<Error | null>(null)

  useEffect(() => {
    if (!enabled || !method) return

    const estimateGas = async () => {
      try {
        setLoading(true)
        setError(null)

        const provider = getProvider()
        if (!provider) {
          throw new Error('Provider not available')
        }

        const contract = new Contract(SETTLEMENT_ADDRESS, SETTLEMENT_ABI, provider)
        const gasLimit = await contract[method].estimateGas(...params)
        const feeData = await provider.getFeeData()
        const gasPrice = feeData.gasPrice || 0n

        const totalCost = gasLimit * gasPrice
        // å¯é€‰ï¼šè½¬æ¢ä¸º USDï¼ˆéœ€è¦ ETH/USD ä»·æ ¼ï¼‰
        const usdCost = 0 // TODO: å®ç°ä»·æ ¼è½¬æ¢

        setEstimate({
          gasLimit,
          gasPrice,
          totalCost,
          usdCost,
        })
      } catch (err) {
        console.error('Gas estimate failed:', err)
        setError(err instanceof Error ? err : new Error('Failed to estimate gas'))
      } finally {
        setLoading(false)
      }
    }

    estimateGas()
  }, [method, JSON.stringify(params), enabled])

  return { estimate, loading, error }
}
```

#### æ­¥éª¤ 2ï¼šåˆ›å»ºæ‰‹ç»­è´¹æ˜¾ç¤ºç»„ä»¶

åˆ›å»º `frontend/src/components/FeeDisplay.tsx`ï¼š

```typescript
import { formatEther } from 'ethers'
import { useGasEstimate } from '../hooks/useGasEstimate'

interface FeeDisplayProps {
  tradeAmount: bigint
  platformFeePercent: number // 0.5 = 0.5%
  feeDistribution: {
    nodes: number // 20 = 20%
    developers: number // 30 = 30%
    liquidity: number // 50 = 50%
  }
}

export function FeeDisplay({
  tradeAmount,
  platformFeePercent,
  feeDistribution,
}: FeeDisplayProps) {
  const platformFee = (tradeAmount * BigInt(Math.floor(platformFeePercent * 100))) / 10000n
  const { estimate: gasEstimate, loading } = useGasEstimate('settleTrade', [], false)

  return (
    <div className="bg-gray-50 rounded-lg p-4 space-y-2">
      <h3 className="font-semibold text-sm mb-2">é¢„è®¡è´¹ç”¨</h3>
      
      <div className="space-y-1 text-sm">
        <div className="flex justify-between">
          <span className="text-gray-600">å¹³å°æ‰‹ç»­è´¹ï¼š</span>
          <span className="font-medium">{platformFeePercent}%</span>
        </div>
        
        {loading ? (
          <div className="text-gray-500">è®¡ç®— Gas è´¹ç”¨...</div>
        ) : gasEstimate ? (
          <div className="flex justify-between">
            <span className="text-gray-600">Gas è´¹ç”¨ï¼š</span>
            <span className="font-medium text-green-600">
              {formatEther(gasEstimate.totalCost)} ETH
            </span>
            <span className="text-gray-500 text-xs ml-2">(relayer ä»£ä»˜)</span>
          </div>
        ) : null}
      </div>

      <div className="border-t pt-2 mt-2">
        <h4 className="font-semibold text-xs mb-1">æ‰‹ç»­è´¹åˆ†æˆå»å‘ï¼š</h4>
        <div className="space-y-1 text-xs text-gray-600">
          <div className="flex justify-between">
            <span>èŠ‚ç‚¹è¿è¡Œè€…ï¼š</span>
            <span>{feeDistribution.nodes}%</span>
          </div>
          <div className="flex justify-between">
            <span>å¼€å‘è€…ï¼š</span>
            <span>{feeDistribution.developers}%</span>
          </div>
          <div className="flex justify-between">
            <span>æµåŠ¨æ€§æä¾›è€…ï¼š</span>
            <span>{feeDistribution.liquidity}%</span>
          </div>
        </div>
      </div>

      <div className="bg-blue-50 border border-blue-200 rounded p-2 mt-2">
        <p className="text-xs text-blue-800">
          ğŸ’¡ <strong>å¯¹æ¯”ä¸»æµé’±åŒ…ï¼š</strong>ä¸»æµé’±åŒ… 0.5% + éšå«æ»‘ç‚¹ 0.5%+ï¼Œæˆ‘ä»¬ 0.5% + é›¶æ»‘ç‚¹ + é€æ˜åˆ†æˆ
        </p>
      </div>
    </div>
  )
}
```

#### æ­¥éª¤ 3ï¼šåœ¨äº¤æ˜“ç¡®è®¤é¡µé¢ä½¿ç”¨

åœ¨ `frontend/src/components/OrderForm.tsx` æˆ–ç»“ç®—é¡µé¢ä¸­æ·»åŠ ï¼š

```typescript
import { FeeDisplay } from './FeeDisplay'

// åœ¨äº¤æ˜“ç¡®è®¤æ—¶æ˜¾ç¤º
<FeeDisplay
  tradeAmount={orderAmount}
  platformFeePercent={0.5}
  feeDistribution={{
    nodes: 20,
    developers: 30,
    liquidity: 50,
  }}
/>
```

### 3.3 æµ‹è¯•

1. æµ‹è¯•ä¸åŒäº¤æ˜“é‡‘é¢çš„æ‰‹ç»­è´¹è®¡ç®—
2. éªŒè¯ Gas ä¼°ç®—å‡†ç¡®æ€§
3. æ£€æŸ¥è´¹ç”¨æ˜¾ç¤ºæ ¼å¼
4. æµ‹è¯•åˆ†æˆæ¯”ä¾‹æ˜¾ç¤º

---

## å››ã€é¡¹ç›®æ„ä¹‰å¼ºåŒ–ï¼ˆ30 åˆ†é’Ÿï¼‰

### 4.1 æ›´æ–° README

åœ¨ `README.md` ä¸­æ·»åŠ "ä¸ºä»€ä¹ˆé€‰æ‹©æˆ‘ä»¬"ç« èŠ‚ï¼ˆå·²æ·»åŠ ï¼Œå¯è¿›ä¸€æ­¥ä¼˜åŒ–ï¼‰ã€‚

### 4.2 æ·»åŠ å¯¹æ¯”è¯´æ˜

åœ¨ `docs/é¡¹ç›®ä»·å€¼ä¸å®šä½.md` ä¸­å·²åŒ…å«å¯¹æ¯”è¡¨æ ¼ï¼Œå¯åœ¨ README ä¸­å¼•ç”¨ã€‚

---

## äº”ã€å®æ–½ä¼˜å…ˆçº§

### ç«‹å³å®æ–½ï¼ˆä»Šå¤©ï¼‰

1. âœ… **ä»·æ ¼å‚è€ƒé›†æˆ**ï¼ˆ< 1 å¤©ï¼‰- æœ€ç®€å•è§æ•ˆ
2. âœ… **æ‰‹ç»­è´¹é€æ˜åŒ–**ï¼ˆ< 1 å¤©ï¼‰- å¼ºåŒ–å·®å¼‚åŒ–

### æœ¬å‘¨å®æ–½

3. âœ… **æ‰‹æœºç«¯é’±åŒ…ä¼˜åŒ–**ï¼ˆ1 å¤©ï¼‰- æå‡ç”¨æˆ·ä½“éªŒ
4. âœ… **é¡¹ç›®æ„ä¹‰å¼ºåŒ–**ï¼ˆ30 åˆ†é’Ÿï¼‰- æ›´æ–°æ–‡æ¡£

---

## å…­ã€æµ‹è¯•æ¸…å•

### ä»·æ ¼å‚è€ƒ
- [ ] CoinGecko API è°ƒç”¨æ­£å¸¸
- [ ] ä»·æ ¼æ­£ç¡®æ˜¾ç¤º
- [ ] 30 ç§’è‡ªåŠ¨åˆ·æ–°
- [ ] ç½‘ç»œé”™è¯¯å¤„ç†
- [ ] ç§»åŠ¨ç«¯æ˜¾ç¤ºæ­£å¸¸

### é’±åŒ…è¿æ¥
- [ ] iOS Safari æµ‹è¯•
- [ ] Android Chrome æµ‹è¯•
- [ ] MetaMask App å†…ç½®æµè§ˆå™¨
- [ ] Trust Wallet App
- [ ] è‡ªåŠ¨æ·»åŠ ç½‘ç»œåŠŸèƒ½

### æ‰‹ç»­è´¹æ˜¾ç¤º
- [ ] æ‰‹ç»­è´¹è®¡ç®—æ­£ç¡®
- [ ] Gas ä¼°ç®—å‡†ç¡®
- [ ] åˆ†æˆæ¯”ä¾‹æ˜¾ç¤ºæ­£ç¡®
- [ ] å¯¹æ¯”è¯´æ˜æ¸…æ™°

---

## ä¸ƒã€ç›¸å…³æ–‡æ¡£

- [ä¼˜åŒ–ä¸æ”¹è¿›æ¸…å•](./ä¼˜åŒ–ä¸æ”¹è¿›æ¸…å•.md)
- [é¡¹ç›®ä»·å€¼ä¸å®šä½](./é¡¹ç›®ä»·å€¼ä¸å®šä½.md)
- [æ‰‹æœºç«¯å¼€å‘æŒ‡å—](./æ‰‹æœºç«¯å¼€å‘æŒ‡å—.md)

---

*æœ¬æ–‡æ¡£æä¾›å¿«é€Ÿä¼˜åŒ–çš„å…·ä½“å®ç°æ­¥éª¤ï¼Œå»ºè®®æŒ‰ä¼˜å…ˆçº§é€æ­¥å®æ–½ã€‚*
