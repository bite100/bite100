# 以管理员权限构建 Windows 安装包

## ⚠️ 当前问题

构建过程中遇到代码签名工具解压时的符号链接权限问题：
```
ERROR: Cannot create symbolic link : 客户端没有所需的特权
```

这需要**管理员权限**才能解决。

## 🔧 解决方案

### 方法 1：以管理员身份运行 PowerShell（推荐）

1. **打开 PowerShell 管理员模式**：
   - 按 `Win + X`
   - 选择 "Windows PowerShell (管理员)" 或 "终端 (管理员)"
   - 或在开始菜单搜索 "PowerShell"，右键选择 "以管理员身份运行"

2. **切换到项目目录**：
   ```powershell
   cd d:\P2P\frontend
   ```

3. **设置环境变量并构建**：
   ```powershell
   $env:CSC_IDENTITY_AUTO_DISCOVERY='false'
   npm run electron:build
   ```

4. **等待构建完成**：
   - 构建时间：约 2-5 分钟
   - 输出文件：`release/P2P 交易所 Setup 0.0.1.exe`

### 方法 2：使用便携版（无需管理员权限）

如果无法获取管理员权限，可以使用便携版：

1. **修改 package.json**：
   ```json
   "win": {
     "target": ["portable"]
   }
   ```

2. **运行构建**：
   ```powershell
   cd d:\P2P\frontend
   npm run electron:build
   ```

3. **输出文件**：
   - `release/P2P 交易所-0.0.1.exe`（便携版，无需安装）

### 方法 3：使用 GitHub Actions（推荐用于生产）

推送到 GitHub 后，Actions 会自动构建，无需本地权限：

1. **提交代码**：
   ```powershell
   git add .
   git commit -m "准备构建安装包"
   git push
   ```

2. **查看构建**：
   - 访问：`https://github.com/YOUR_REPO/actions`
   - 等待构建完成
   - 从 Artifacts 下载安装包

## 📋 完整构建命令（管理员权限）

```powershell
# 1. 以管理员身份打开 PowerShell

# 2. 切换到项目目录
cd d:\P2P\frontend

# 3. 设置环境变量（禁用代码签名自动发现）
$env:CSC_IDENTITY_AUTO_DISCOVERY='false'

# 4. 运行构建
npm run electron:build

# 5. 等待完成，安装包在 release/ 目录
```

## ✅ 构建成功标志

构建成功后，你会看到：
```
✔ building        platform=win32 arch=x64 electron=33.4.11
✔ packaging       platform=win32 arch=x64
✔ default Electron icon is used
✔ building        target=nsis file=release/P2P 交易所 Setup 0.0.1.exe
```

## 📦 输出文件位置

- **安装包**：`frontend/release/P2P 交易所 Setup 0.0.1.exe`
- **便携版**：`frontend/release/P2P 交易所-0.0.1.exe`（如果使用 portable 目标）
- **未打包文件**：`frontend/release/win-unpacked/`（已生成）

## 🐛 故障排查

### 问题 1：仍然提示权限不足
**解决**：确保 PowerShell 是以管理员身份运行的（标题栏应显示"管理员"）

### 问题 2：找不到 npm 命令
**解决**：确保 Node.js 已安装并添加到 PATH

### 问题 3：构建很慢
**解决**：这是正常的，首次构建需要下载 Electron 和依赖

### 问题 4：构建失败但 win-unpacked 已生成
**解决**：可以使用 `win-unpacked/P2P 交易所.exe` 直接运行，无需安装包

## 💡 推荐方案

1. **开发/测试**：使用 `win-unpacked/P2P 交易所.exe`（已生成）
2. **生产分发**：使用 GitHub Actions 自动构建
3. **本地构建**：以管理员权限运行构建命令

## 📝 注意事项

- 未签名的安装包在 Windows 上可能显示"未知发布者"警告
- 这是正常的，用户可以点击"仍要运行"
- 如需代码签名，需要购买代码签名证书
