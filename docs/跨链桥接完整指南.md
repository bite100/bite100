# 跨链桥接完整指南

> 版本：v1.0  
> 更新日期：2026-02-10  
> 整合自：跨链桥接实现/快速开始/部署测试、跨链功能设计、跨链功能实现指南

---

## 设计概述与实现状态

**目标链**：Ethereum Mainnet、Base、Arbitrum、Polygon、Optimism、Sepolia（已支持）。选择标准：Gas 费用、生态成熟度、用户基数、桥接便利性。

**多链部署**：每条链部署相同合约套件（Vault→FeeDistributor→Settlement→AMMPool→ContributorReward→Governance→TokenRegistry→ChainConfig）。链配置见 `frontend/src/config/chains.ts`，链切换组件见 `ChainSwitcher.tsx`、`useChain.ts`。部署脚本：`deploy-base.ps1`、`deploy-arbitrum.ps1` 等。

**桥接**：LayerZero OApp 实现跨链资产桥接，详见下文。

---

## 一、快速开始（5 分钟）

### 1.1 安装依赖

```powershell
cd contracts
.\scripts\install-layerzero.ps1
```

### 1.2 部署到测试网

```powershell
# Sepolia
.\scripts\deploy-crosschain-bridge.ps1 -Chain sepolia

# Base Sepolia
.\scripts\deploy-crosschain-bridge.ps1 -Chain base_sepolia
```

### 1.3 配置代币映射

```powershell
.\scripts\configure-bridge-tokens.ps1 `
    -BridgeAddress 0x你的桥接合约地址 `
    -Chain sepolia `
    -Token 0x源链代币地址 `
    -DstChainId 84532 `
    -DstToken 0x目标链代币地址
```

### 1.4 测试

打开前端应用，切换到「跨链桥」标签页，发起跨链转移。

---

## 二、概述与技术方案

### 2.1 概述

本文档说明如何使用 LayerZero OApp 实现跨链资产桥接。跨链桥接允许用户在不同链之间转移资产，实现多链 DEX 体验。

### 2.2 LayerZero OApp

**选择原因**：成熟的跨链消息传递协议、支持任意消息、良好 Foundry 支持、活跃社区。

**核心概念**：
- **OApp**: 可发送和接收跨链消息的合约
- **Endpoint**: LayerZero 的跨链消息端点
- **DVN**: 默认虚拟节点，负责验证和转发消息

### 2.3 架构

```
源链 (Source Chain)             目标链 (Destination Chain)
┌─────────────────┐            ┌─────────────────┐
│  CrossChainBridge│            │  CrossChainBridge│
│  (锁定资产)      │            │  (解锁/铸造)     │
└────────┬────────┘            └────────┬────────┘
         │  LayerZero Message           │
         └──────────────────────────────┘
```

**流程**：用户调用 `bridgeToken` → 资产锁定 → LayerZero 发送消息 → 目标链解锁/铸造。

---

## 三、合约实现

### 3.1 核心合约

**文件**: `contracts/src/CrossChainBridge.sol`

**主要功能**：
- `bridgeToken()`: 发起跨链转移（锁定资产）
- `_lzReceive()`: 接收跨链消息（解锁/铸造资产）
- `quoteBridgeFee()`: 估算跨链费用
- `setSupportedToken()`: 管理支持的代币
- `setTokenMapping()`: 设置代币映射

### 3.2 LayerZero Endpoint

各链 Endpoint 地址：
- **Ethereum**: `0x1a44076050125825900e736c501f859c50fE728c`
- **Sepolia**: `0x6EDCE65403992e310A62460808c4b910D972f10f`

---

## 四、部署步骤

### 4.1 前置准备

**环境变量**（`contracts/.env`）：

```bash
PRIVATE_KEY=0x你的私钥
SEPOLIA_RPC_URL=https://ethereum-sepolia.publicnode.com
BASE_SEPOLIA_RPC_URL=https://sepolia.base.org
ARBITRUM_SEPOLIA_RPC_URL=https://sepolia-rollup.arbitrum.io/rpc
```

### 4.2 部署桥接合约

```powershell
# Sepolia / Base Sepolia / Arbitrum Sepolia
.\scripts\deploy-crosschain-bridge.ps1 -Chain sepolia
.\scripts\deploy-crosschain-bridge.ps1 -Chain base_sepolia
.\scripts\deploy-crosschain-bridge.ps1 -Chain arbitrum_sepolia
```

部署成功后记录合约地址。

### 4.3 配置代币映射

**LayerZero EID**：Sepolia 40161 | Base Sepolia 40245 | Arbitrum Sepolia 40231

**在 Sepolia 上配置**：

```powershell
.\scripts\configure-bridge-tokens.ps1 `
    -BridgeAddress 0xSepoliaBridge `
    -Chain sepolia `
    -Token 0xSepoliaToken `
    -DstChainId 40245 `
    -DstToken 0xBaseToken
```

**在 Base Sepolia 上配置**（反向）：

```powershell
.\scripts\configure-bridge-tokens.ps1 `
    -BridgeAddress 0xBaseBridge `
    -Chain base_sepolia `
    -Token 0xBaseToken `
    -DstChainId 40161 `
    -DstToken 0xSepoliaToken
```

---

## 五、前端集成

### 5.1 配置桥接合约地址

编辑 `frontend/src/config/chains.ts`：

```typescript
contracts: {
  crossChainBridge: '0xSepoliaBridge',
}
```

### 5.2 使用流程

1. 选择源链和目标链  
2. 输入代币地址和数量  
3. 授权代币（首次）  
4. 发起跨链转移  
5. 等待确认（通常 5–15 分钟）

---

## 六、测试与验证

### 6.1 前端测试

1. 打开前端 →「跨链桥」标签  
2. 选择源链/目标链，输入代币和数量  
3. 发起转移并等待确认  

### 6.2 验证

- 源链：代币余额减少、桥接合约余额增加  
- 目标链：用户余额增加  
- 区块浏览器：查看 `BridgeInitiated` / `BridgeCompleted` 事件  

### 6.3 单元测试

```bash
cd contracts
forge test --match-contract CrossChainBridgeTest -vvv
```

---

## 七、常见问题

| 问题 | 解决方案 |
|------|----------|
| 部署失败，找不到 LayerZero 依赖 | 运行 `.\scripts\install-layerzero.ps1` |
| 编译错误，找不到 OApp | 检查 `foundry.toml` 中 remappings |
| 桥接转移失败 | 检查代币映射、支持列表、授权、Gas |
| 转移需要多久 | 通常 5–15 分钟 |
| 如何查询状态 | LayerZero 扫描器、合约事件 |
| 转移失败怎么办 | 资产锁定在源链，需管理员手动处理 |

---

## 八、安全考虑

- **重放防护**：nonce + timestamp，`processedRequests` 防重复  
- **代币验证**：验证映射、支持列表、数量  
- **费用管理**：合理桥接费、owner 权限提取  

---

## 九、相关文档

- [LayerZero 官方文档](https://docs.layerzero.network/v2)
- [API-接口说明](./API-接口说明.md)（合约地址与调用）

---

*本文档整合跨链桥接的设计、实现、部署与测试。*
