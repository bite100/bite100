# 流动性贡献分设计文档

> 版本：v1.0  
> 更新日期：2025-02-08

---

## 一、概述

本文档描述节点通过向 AMM 池注入流动性获得贡献分的机制。该机制鼓励节点提供流动性，提升 DEX 的流动性和交易体验。

---

## 二、设计目标

### 2.1 目标

- **激励流动性**：鼓励节点向 AMM 池注入流动性
- **公平分配**：根据流动性注入量分配贡献分
- **周期管理**：按周期统计和分配贡献分
- **灵活提取**：节点可以随时提取流动性

### 2.2 原则

- **按量计分**：流动性越多，贡献分越高
- **上限控制**：设置合理的贡献分上限，避免过度集中
- **权重平衡**：流动性贡献分权重与其他贡献类型平衡

---

## 三、机制设计

### 3.1 流动性贡献分计算

**公式**：
```
liquidityScore = min(liquidityAmount / CAP_LIQUIDITY, 1e18) * WEIGHT_LIQUIDITY
```

**参数**：
- `liquidityAmount`：注入的流动性数量（以稳定币计价，如 USDC/USDT）
- `CAP_LIQUIDITY`：流动性贡献分上限（如 100,000 USDC 等值）
- `WEIGHT_LIQUIDITY`：流动性贡献权重（建议 20%，与其他权重平衡）

**权重分配**（更新后）：
- **撮合**：40%
- **存储**：25%
- **流动性**：20%（新增）
- **中继**：15%

### 3.2 流动性记录

**AMMPool 合约**：
- 记录每个地址的流动性注入量
- 记录注入时间
- 支持查询当前流动性

**数据结构**：
```solidity
struct LiquidityProvider {
    uint256 totalLiquidity;      // 累计注入的流动性
    uint256 currentLiquidity;    // 当前持有的流动性
    uint256 lastUpdateTime;      // 最后更新时间
}

mapping(address => LiquidityProvider) public liquidityProviders;
```

### 3.3 贡献分更新

**自动更新**：
- 节点调用 `addLiquidity` 时，自动更新贡献分
- 节点调用 `removeLiquidity` 时，自动减少贡献分

**手动提交**（可选）：
- 节点也可以通过 `submitLiquidityProof` 手动提交流动性证明
- 适用于跨链流动性等场景

---

## 四、实现方案

### 4.1 AMMPool 合约扩展

**新增功能**：
- `recordLiquidity(address provider, uint256 amount0, uint256 amount1)`：记录流动性注入
- `getLiquidityScore(address provider)`：查询流动性贡献分
- `getTotalLiquidity()`：查询池子总流动性

**修改 `addLiquidity`**：
- 记录流动性提供者
- 计算流动性数量（以稳定币计价）
- 触发贡献分更新事件

### 4.2 ContributorReward 合约扩展

**新增功能**：
- `submitLiquidityProof(string period, uint256 liquidityAmount, bytes signature)`：提交流动性证明
- `_computeLiquidityScore(uint256 liquidityAmount)`：计算流动性贡献分
- 更新 `_computeScore` 支持 `nodeType=3`（流动性提供者）

**权重配置**：
```solidity
uint256 private constant WEIGHT_LIQUIDITY = 20; // 20%
```

### 4.3 贡献分计算

**流动性贡献分**：
```solidity
function _computeLiquidityScore(uint256 liquidityAmount) internal pure returns (uint256) {
    uint256 base = 1e18; // 基础分
    if (CAP_LIQUIDITY > 0 && liquidityAmount > 0) {
        uint256 liquidityPart = liquidityAmount * SCALE / CAP_LIQUIDITY;
        if (liquidityPart > SCALE) liquidityPart = SCALE;
        base += liquidityPart;
    }
    return base * WEIGHT_LIQUIDITY;
}
```

---

## 五、使用流程

### 5.1 节点注入流动性

1. **准备代币**：
   - 确保有足够的 Token0 和 Token1
   - 授权 AMMPool 合约

2. **注入流动性**：
   ```solidity
   ammPool.addLiquidity(amount0, amount1);
   ```

3. **自动获得贡献分**：
   - 合约自动记录流动性
   - 更新当前周期的贡献分

### 5.2 查询贡献分

```solidity
uint256 score = contributorReward.getContributionScore(period, nodeAddress);
```

### 5.3 提取流动性

1. **提取流动性**：
   ```solidity
   ammPool.removeLiquidity(amount0, amount1);
   ```

2. **贡献分自动减少**：
   - 合约自动更新流动性记录
   - 减少当前周期的贡献分

---

## 六、安全考虑

### 6.1 防刷分

- **最小流动性**：设置最小注入量（如 100 USDC）
- **时间锁定**：流动性需锁定一定时间（如 7 天）才能计入贡献分
- **上限控制**：单个地址的贡献分有上限

### 6.2 价格稳定

- **稳定币计价**：使用稳定币（USDC/USDT）计价，避免价格波动
- **定期快照**：定期快照流动性，避免频繁操作刷分

### 6.3 提取限制

- **提取冷却**：提取流动性后，需等待一定时间才能再次注入
- **最小持有期**：流动性需持有一定时间才能计入贡献分

---

## 七、参数配置

### 7.1 建议参数

| 参数 | 值 | 说明 |
|------|-----|------|
| `CAP_LIQUIDITY` | 100,000 USDC | 流动性贡献分上限 |
| `WEIGHT_LIQUIDITY` | 20% | 流动性贡献权重 |
| `MIN_LIQUIDITY` | 100 USDC | 最小注入量 |
| `LOCK_PERIOD` | 7 days | 锁定时间 |

### 7.2 治理配置

- 通过治理提案调整参数
- 支持动态调整权重和上限

---

## 八、实施计划

### 8.1 阶段 1：合约扩展

- [ ] 扩展 AMMPool 合约，记录流动性提供者
- [ ] 扩展 ContributorReward 合约，添加流动性贡献分计算
- [ ] 添加流动性贡献分查询接口

### 8.2 阶段 2：测试

- [ ] 单元测试：流动性注入和贡献分计算
- [ ] 集成测试：完整流程测试
- [ ] 安全审计：防刷分机制验证

### 8.3 阶段 3：部署

- [ ] 部署到测试网
- [ ] 测试流动性注入和贡献分
- [ ] 部署到主网

---

## 九、相关文档

- [贡献奖励接口](./贡献奖励接口.md)
- [AMM 池设计](./概念设计文档.md)
- [治理机制](./DAO扩展设计.md)

---

*本文档描述流动性贡献分的设计方案，鼓励节点提供流动性。*
