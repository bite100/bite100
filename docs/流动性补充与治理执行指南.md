# 流动性补充与治理执行指南

> 版本：v1.0  
> 更新日期：2025-02-08

---

## 一、流动性补充

### 1.1 概述

为 Sepolia AMM 池添加初始流动性，便于真实 Swap 交易和演示。

### 1.2 前置条件

1. **环境变量配置**：
   - `PRIVATE_KEY`：拥有代币的账户私钥
   - `SEPOLIA_RPC_URL`：Sepolia 测试网 RPC 地址
   - `AMMPOOL_ADDRESS`：AMM 池合约地址
   - `TOKEN0_ADDRESS`：Token0 合约地址
   - `TOKEN1_ADDRESS`：Token1 合约地址

2. **代币余额**：确保账户有足够的 Token0 和 Token1 余额

3. **Foundry 安装**：已安装 Foundry（forge 命令可用）

### 1.3 使用方法

#### Windows (PowerShell)

```powershell
cd contracts
.\scripts\add-liquidity.ps1 -Token0Amount 1000 -Token1Amount 1000
```

#### Linux / macOS

```bash
cd contracts
chmod +x scripts/add-liquidity.sh
./scripts/add-liquidity.sh 1000 1000
```

### 1.4 参数说明

| 参数 | 说明 | 默认值 | 示例 |
|------|------|--------|------|
| `Token0Amount` | Token0 数量（wei） | 1000 | 1000e18 |
| `Token1Amount` | Token1 数量（wei） | 1000 | 1000e18 |
| `PrivateKey` | 账户私钥 | `$env:PRIVATE_KEY` | - |
| `RpcUrl` | RPC 地址 | `$env:SEPOLIA_RPC_URL` | - |
| `AMMPoolAddress` | AMM 池地址 | `$env:AMMPOOL_ADDRESS` | - |
| `Token0Address` | Token0 地址 | `$env:TOKEN0_ADDRESS` | - |
| `Token1Address` | Token1 地址 | `$env:TOKEN1_ADDRESS` | - |

### 1.5 执行流程

1. **检查余额**：脚本会先检查账户的 Token0 和 Token1 余额
2. **批准代币**：自动调用 `approve` 批准 AMM 池使用代币
3. **添加流动性**：调用 `addLiquidity` 添加流动性
4. **验证结果**：显示池子的储备量

### 1.6 示例

```powershell
# 设置环境变量
$env:PRIVATE_KEY = "0x..."
$env:SEPOLIA_RPC_URL = "https://ethereum-sepolia.publicnode.com"
$env:AMMPOOL_ADDRESS = "0x85F18604a8e3ca3C87A1373e4110Ed5C337677d4"
$env:TOKEN0_ADDRESS = "0x..."
$env:TOKEN1_ADDRESS = "0x..."

# 添加流动性（1000 Token0 + 1000 Token1）
.\scripts\add-liquidity.ps1 -Token0Amount 1000000000000000000000 -Token1Amount 1000000000000000000000
```

### 1.7 注意事项

- 确保代币数量足够（包括 gas 费用）
- 首次添加流动性时，建议 Token0 和 Token1 数量相等（1:1 比例）
- 脚本会自动清理临时文件
- 如果执行失败，检查错误信息并确保所有环境变量正确设置

---

## 二、治理执行验证

### 2.1 概述

投票期结束后，执行已通过的治理提案，验证 Governance → Settlement/AMMPool 的完整链路。

### 2.2 前置条件

1. **提案状态**：
   - 投票期已结束（`votingEndsAt < now`）
   - 赞成票数超过活跃集的一半（`yesCount > activeCount / 2`）
   - Timelock 延迟已过（`executableAt <= now`）
   - 提案尚未执行（`executed == false`）

2. **环境变量**：
   - `PRIVATE_KEY`：执行账户私钥（可以是任意账户）
   - `GOVERNANCE_ADDRESS`：治理合约地址

### 2.3 使用方法

#### 方法一：前端界面（推荐）

1. 打开前端应用，进入「治理」标签页
2. 查看提案列表，找到状态为「✅ 可执行」的提案
3. 点击「立即执行」按钮
4. 确认交易并等待执行完成

#### 方法二：命令行脚本

**Windows (PowerShell)**：

```powershell
cd contracts
.\scripts\execute-proposal.ps1 -ProposalId 0
```

**Linux / macOS**：

```bash
cd contracts
cast send $GOVERNANCE_ADDRESS "execute(uint256)" 0 \
  --rpc-url $SEPOLIA_RPC_URL \
  --private-key $PRIVATE_KEY
```

### 2.4 执行流程

1. **检查提案状态**：
   - 投票期是否结束
   - 是否已通过（赞成票 > 活跃集/2）
   - Timelock 是否已过
   - 是否已执行

2. **执行提案**：
   - 调用 `Governance.execute(proposalId)`
   - 如果是单步骤提案，执行 `target.call(callData)`
   - 如果是多步骤提案，依次执行每个步骤

3. **验证结果**：
   - 检查目标合约的状态是否已更新
   - 查看交易日志确认执行成功

### 2.5 前端界面说明

前端界面会显示以下信息：

- **提案状态**：
  - ✅ 已执行：提案已成功执行
  - ⏳ 投票中：投票期尚未结束
  - ✅ 可执行：投票已通过，Timelock 已过，可以执行
  - ⏰ 等待 Timelock：投票已通过，但需要等待延迟时间
  - ❌ 未通过：赞成票未超过阈值

- **提案详情**：
  - 提案 ID
  - 赞成/反对票数
  - 目标合约地址
  - 可执行时间（如果等待 Timelock）

### 2.6 常见提案类型

#### 修改手续费率

```solidity
// 目标：AMMPool 或 Settlement
// 调用：setFeeBps(uint16)
// 示例：设置为 0.01%（1 bps）
```

#### 设置手续费上限

```solidity
// 目标：AMMPool 或 Settlement
// 调用：setFeeCap(address token, uint256 cap)
// 示例：设置 Token0 的手续费上限为 1 USD（1e6，6 位小数）
```

#### 多步骤提案

```solidity
// 可以同时执行多个操作
// 例如：先设置费率，再设置上限
```

### 2.7 验证执行结果

执行提案后，可以通过以下方式验证：

1. **查看交易日志**：
   - `ProposalExecuted` 事件
   - `ProposalStepExecuted` 事件（多步骤提案）

2. **检查合约状态**：
   ```solidity
   // 检查 AMMPool 费率
   AMMPool(ammPoolAddr).feeBps()
   
   // 检查 Settlement 费率
   Settlement(settlementAddr).feeBps()
   ```

3. **前端界面**：
   - 刷新提案列表，状态应变为「✅ 已执行」
   - 检查相关合约的状态是否已更新

### 2.8 注意事项

- **Timelock 延迟**：默认延迟为 2 天，可通过 `setTimelockDelay` 调整（仅 owner）
- **冷却期**：同一提案执行后 7 天内不能再次创建相同提案
- **执行权限**：任何人都可以执行已通过的提案（无需特殊权限）
- **Gas 费用**：执行提案需要支付 gas 费用，确保账户有足够的 ETH

### 2.9 故障排查

#### 提案无法执行

1. **检查投票状态**：
   - 确认投票期已结束
   - 确认赞成票数 > 活跃集/2

2. **检查 Timelock**：
   - 确认当前时间 >= `executableAt`
   - 如果未到时间，需要等待

3. **检查执行状态**：
   - 确认提案尚未执行（`executed == false`）

#### 执行失败

1. **检查目标合约**：
   - 确认目标合约地址正确
   - 确认调用数据正确

2. **检查权限**：
   - 确认目标合约允许 Governance 调用（已设置 `setGovernance`）

3. **检查 Gas**：
   - 确认账户有足够的 ETH 支付 gas

---

## 三、完整流程示例

### 3.1 添加流动性并测试 Swap

```powershell
# 1. 添加流动性
.\scripts\add-liquidity.ps1 -Token0Amount 1000000000000000000000 -Token1Amount 1000000000000000000000

# 2. 在前端测试 Swap
# 打开前端应用，进入「Swap」标签页
# 输入交换数量，执行 Swap
```

### 3.2 创建并执行治理提案

```powershell
# 1. 生成活跃集 Merkle Root（使用 merkletool）
# 见 node/scripts/governance-merkletool-example.md

# 2. 在前端创建提案
# 打开前端应用，进入「治理」标签页
# 填写提案信息（目标、调用数据、Merkle Root、活跃集数量）
# 点击「创建提案」

# 3. 投票
# 使用活跃集中的地址投票（需要提供 Merkle Proof）

# 4. 等待投票期结束和 Timelock 延迟

# 5. 执行提案
# 前端界面点击「立即执行」，或使用脚本：
.\scripts\execute-proposal.ps1 -ProposalId 0
```

---

## 四、相关文档

- [治理部署与提案执行指南](./治理部署与提案执行指南.md)
- [治理闭环-Sepolia操作清单](./治理闭环-Sepolia操作清单.md)
- [API-接口说明](./API-接口说明.md)（Governance 合约接口）

---

*本文档说明如何为 AMM 池添加流动性和执行治理提案，完成完整的治理闭环验证。*
