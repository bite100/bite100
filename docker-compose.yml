# P2P 项目 - 完整部署（节点 + 前端）
# 用法: docker compose up

services:
  # 撮合节点
  match-node:
    build:
      context: ./node
      dockerfile: Dockerfile
    ports:
      - "4001:4001"
      - "8080:8080"
    environment:
      - NODE_TYPE=match
      - API_LISTEN=:8080
    volumes:
      - ./node/config.yaml:/app/config.yaml
      - match-data:/app/data
    command: ["-config", "/app/config.yaml"]
    networks:
      - p2p-network

  # 存储节点
  storage-node:
    build:
      context: ./node
      dockerfile: Dockerfile
    ports:
      - "4002:4001"
      - "8081:8080"
    environment:
      - NODE_TYPE=storage
      - API_LISTEN=:8080
    volumes:
      - ./node/config.yaml:/app/config.yaml
      - storage-data:/app/data
    command: ["-config", "/app/config.yaml", "-port", "4001"]
    networks:
      - p2p-network
    depends_on:
      - match-node

  # 中继节点
  relay-node:
    build:
      context: ./node
      dockerfile: Dockerfile
    ports:
      - "4003:4001"
    environment:
      - NODE_TYPE=relay
    volumes:
      - ./node/config.yaml:/app/config.yaml
      - relay-data:/app/data
    command: ["-config", "/app/config.yaml", "-port", "4001"]
    networks:
      - p2p-network
    depends_on:
      - match-node

  # 前端
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "5173:80"
    environment:
      - VITE_P2P_WS_URL=ws://match-node:8080/ws
      - VITE_P2P_API_URL=http://match-node:8080
    networks:
      - p2p-network
    depends_on:
      - match-node

volumes:
  match-data:
  storage-data:
  relay-data:

networks:
  p2p-network:
    driver: bridge
