# 功能增加、改进与待实现清单

> 合并自原「功能增加与改进总结」与「待实现功能清单」。  
> 基于 [优化与改进清单](./优化与改进清单.md)、[项目分析与借鉴](./项目分析与借鉴.md)、[概念设计文档](./概念设计文档.md)、[规划与路线图](./规划与路线图.md)。  
> 修改时保留更改前的说明，便于分析。**文档从「可增加的功能」开始，便于优先排期待做项。**

---

## 一、可「增加」的功能（新能力，待做）

| 类别 | 功能 | 优先级 | 难度 | 说明 | 状态 |
|------|------|--------|------|------|------|
| **前端/体验** | 价格参考集成 | 🔴 高 | 低 | CoinGecko 市场价、P2P 价 vs 市场价，突出零滑点（< 1 天） | ✅ 已完成 |
| **前端/体验** | 手续费透明化 | 🔴 高 | 低 | 预计手续费、Gas 估算、分成去向（< 1 天） | ✅ 已完成 |
| **前端/体验** | 公开数据展示 | 🔴 高 | 低～中 | 流动性池、奖励池、交易记录（访客可见）（1-2 天） | ✅ 已完成 |
| **前端/体验** | 贡献分/奖励领取界面 | 🔴 高 | 低 | UnifiedRewardClaim，手机友好（1 天） | ✅ 已完成 |
| **前端/体验** | PWA 完善 | 🟡 中 | 中 | Manifest、Service Worker、离线缓存与更新 | ✅ 已完成 |
| **前端/体验** | 自动添加网络 | 🟡 中 | 低 | `wallet_addEthereumChain`，一键添加链 | ✅ 已完成 |
| **节点/P2P** | 订单簿持久化 | 🔴 高 | 中 | 重启后从本地存储恢复 open/partial 订单到撮合引擎；match 节点启用存储；见 4.2 | ✅ 已完成 |
| **节点/P2P** | Spam 防护 | 🔴 高 | 高 | 订单签名验证✅、API 下单速率限制✅（每 IP/分钟可配）；信誉机制、黑名单待做 | 部分完成 |
| **节点/P2P** | Tor 可选（隐私层） | 🟡 中 | 中 | 节点/用户可选 Tor，不记录 IP（借鉴 Bisq/Haveno） | 待做 |
| **节点/P2P** | 高性能订单簿优化 | 🟡 中 | 中 | 内存订单簿 + 增量 Gossip、Epoch 撮合、批量结算（借鉴 dYdX/Hyperliquid） | 待做 |
| **合约/治理** | 手续费分成提案 | 🟡 中 | 高 | Governance 提案设置分成比例与对象，FeeDistributor 按提案分配 | 待做 |
| **合约/激励** | 上线奖励 + 防 Sybil | 🟡 中 | 中 | NodeRewards 已落库；绑定 1–3 节点/钱包、snapshot → allocatePoints → claim | 待做 |
| **运维** | 性能监控 | 🟡 中 | 中 | Prometheus + Grafana，TPS、延迟 | 待做 |
| **运维** | TVL 追踪 | 🟡 中 | 低 | DefiLlama / Dune / 自建脚本（见 [TVL追踪建议](./TVL追踪建议.md)） | 待做 |
| **多链** | Arbitrum/Base/Optimism 等 | 🟡 中 | 中 | 链配置 + 合约部署 + 前端构建 | 待做 |
| **长期** | 多签托管可选 | 🟢 低 | 高 | 2/2 或 2/3 多签，争议仲裁（借鉴 Bisq） | 待做 |
| **长期** | 原子交换（跨链） | 🟢 低 | 高 | 跨链交易对、HTLC 或链上原子交换 | 待做 |
| **长期** | P2P 网格增强 | 🟢 低 | 中 | 中继发现、多跳路由（借鉴 Tatanka） | 待做 |

---

## 二、可「优化」的方向（在现有基础上做得更好）

| 类别 | 方向 | 优先级 | 说明 |
|------|------|--------|------|
| **手机端** | 钱包连接稳定性 | 🔴 高 | wagmi + RainbowKit，deep link/QR fallback，连接成功率 90%+ |
| **手机端** | 错误提示与加载状态 | 🔴 高 | 连接/交易失败时的明确提示与重试引导 |
| **P2P/撮合** | GossipSub 延迟 | 🟡 中 | 调参、本地缓存 |
| **P2P/撮合** | 订单簿一致性 | 🔴 高 | 多节点同步、定期校验、冲突解决 |
| **P2P/撮合** | 撮合确定性 | 🔴 高 | 确定性撮合算法、多节点结果一致（含 Phase 3 方案 C） |
| **链上/Relayer** | 多 Relayer 去中心化 | 🟡 中 | 多 relayer 注册、轮询或声誉选择，Governance 可切换 |
| **链上** | Gas 优化 | 🔴 高 | 合约优化、EIP-1559、批量结算 |
| **部署** | Docker Compose 生产级 | 🟡 中 | 已提供 docker-compose.prod.yml + .env.example；可细化 healthcheck、多节点模板 |
| **部署** | 已放弃电脑端 | — | 以 PWA/浏览器为主，不再维护桌面安装包 |
| **部署** | VPS 一键 + systemd + cron | 🟡 中 | 自动更新（git pull + compose up） |
| **开发体验** | 链配置结构 | 🟡 中 | 统一 chains 配置、RPC 轮询、链切换体验 |
| **开发体验** | 测试覆盖 | 🔴 高 | 单元测试、集成测试、主网前审计与验证 |

---

## 三、可「改进」的痛点与体验

| 类别 | 改进点 | 优先级 | 说明 |
|------|--------|--------|------|
| **安全** | 订单签名验证 | ✅ 已完成 | 节点与前端均验证 EIP-712，拒绝无效订单（见下方 4.1） |
| **安全** | Replay 防护 | ✅ 已完成 | 节点 API 与撮合/存储路径统一拒绝已过期订单（expiresAt < now）；见 4.2 |
| **安全** | Relayer 防滥用 | 🔴 高 | 白名单✅、单笔 gas 报销上限✅（Settlement：`isRelayer`、`maxGasReimbursePerTrade`）；费用回收待做 |
| **激励** | 贡献分按周期锁定价值 | ✅ 已定 | 每周期「每贡献分价值」锁定，以后领按发放时价值算（见 [贡献奖励接口 §3.3](./贡献奖励接口.md)） |
| **激励** | 统一领取入口 | 🔴 高 | 开发者积分 + 节点奖励 + 手续费分成一口径 claim |
| **防 Sybil** | 绑定限制 + 声誉 | 🟡 中 | 1 钱包最多 1–3 节点、声誉分、延迟/拓扑检测、治理挑战 |
| **文档/运维** | 生产部署文档 | 🟡 中 | 已补充 docker-compose.prod、.env.example、TVL 与 snapshot 脚本 |
| **桌面版** | 已放弃电脑端 | — | 以 PWA/浏览器为主，不再维护 Electron 桌面版 |

---

## 四、已完成项速览（对照实现状态）

以下为文档/规划中曾列出的项，当前实现状态供排期与遗漏检查用。

### 4.1 体验与稳定性

| 项 | 说明 | 状态 |
|----|------|------|
| 流动性补充 | Sepolia AMM 池补充流动性，便于真实 Swap 与演示 | ✅ 已完成（脚本 + 文档） |
| 流动性贡献分 | 节点注入流动性可获得贡献分 | ✅ 已完成（合约扩展 + 文档） |
| 治理执行验证 | 投票期结束后执行已通过提案，Governance → Settlement/AMMPool 完整链路 | ✅ 已完成（前端 + 脚本 + 文档） |
| 错误与加载统一 | 统一前端错误提示、加载态，移动端重试/提示 | ✅ 已完成 |
| 价格参考集成 | useTokenPrice/usePairMarketPrice、OrderForm/OrderBookSection 市场参考价、零滑点文案 | ✅ 已完成 |
| 手续费透明化 | useGasEstimate、FeeDisplay（平台 0.01%、Gas relayer 代付、分成去向） | ✅ 已完成 |
| 公开数据展示 | LiquidityPoolInfo、RewardPoolInfo，数据 tab + 未连接时展示，公开 RPC | ✅ 已完成 |
| 贡献分/奖励领取界面 | UnifiedRewardClaim，大按钮、按周期 TKA/TKB 领取，贡献 tab 顶部 | ✅ 已完成 |
| PWA 完善 | manifest 补充 scope/categories，sw.js 网络优先+离线回退，main.tsx 注册 | ✅ 已完成 |
| 自动添加网络 | AddNetworkButton，wallet_addEthereumChain 一键添加当前/默认链，连接前可用 | ✅ 已完成 |
| 订单签名验证（EIP-712） | 前端 orderVerification 与 orderSigning/节点一致；OrderForm/OrderBookSection 提交前验签；节点 API 强制要求签名并验签 | ✅ 已完成 |

### 4.2 节点与数据

| 项 | 说明 | 状态 |
|----|------|------|
| 运行节点必须输入领奖地址 | 领奖地址必填（可通过 `-reward-wallet`、环境变量 `REWARD_WALLET` 或配置文件 `reward_wallet` 设置），未设置则拒绝启动；API `/api/node` 返回 `rewardWallet`；Windows 提供图形界面输入地址启动 | ✅ 已完成 |
| 节点自动更新并自动重启（Windows） | `node/update-and-restart.ps1` 与 `自动更新.bat`：git pull + go build，停止当前节点后在新窗口自动启动（领奖地址从「记住地址」或 REWARD_WALLET 读取）；GUI 提供「检查更新」；可加入计划任务 | ✅ 已完成 |
| Docker 无人值守自动更新运行 | `scripts/docker/auto-update-and-restart.sh`（Linux/cron）与 `auto-update-and-restart.ps1`（Windows 计划任务）：拉代码、docker compose build、up -d --force-recreate；见 [scripts/docker/README.md](../scripts/docker/README.md) | ✅ 已完成 |
| Replay/过期防护 | 节点 API 拒收已过期订单（400）；存储 PersistOrderNew、撮合 AddOrder、OnNewOrder 入口统一跳过或拒收过期订单（storage.OrderExpired） | ✅ 已完成 |
| 订单簿持久化 | match/relay 节点启用存储；启动时从 store.ListOrdersOpenByPair 恢复 open/partial 订单到撮合引擎（跳过已过期），重启后订单簿本地恢复 | ✅ 已完成 |
| API 下单速率限制（Spam 防护） | api.rate_limit_orders_per_minute 每 IP 每分钟下单上限；超限返回 429；支持 X-Forwarded-For/X-Real-IP | ✅ 已完成 |
| 贡献分可在其他地方兑换 | 贡献分与奖励在链上（ContributorReward），用户可在本前端或任意连接同一合约的 dApp/钱包/脚本中领取（同一钱包签名即可）；见 [贡献奖励接口 §7](./贡献奖励接口.md#7-在其他地方兑换第三方领取) | ✅ 已支持（链上设计，已文档化） |
| 节点发现优化 | Bootstrap 与 DHT，多区域/多运营商连通性 | ✅ 已完成 |
| 订单簿入口 | 前端「订单簿」入口，可只读展示节点同步的订单簿快照 | ✅ 已完成 |
| 分片按交易对（方案 B） | 按 pair 分片，不同交易对由不同撮合节点负责 | ✅ 已完成 |
| 多节点共识（方案 C） | 多撮合节点 BFT 共识、Leader 选举、订单簿同步 | ✅ 已完成 |
| 批量结算 | Trade 批量打包一次提交省 Gas | ✅ 已完成 |
| 默克尔证明 | 一批 Trade 默克尔树、根上链 | ✅ 已完成 |

### 4.3 治理与扩展

| 项 | 说明 | 状态 |
|----|------|------|
| 准入/信誉 | 无需准入但按信誉分分配奖励 | ✅ 已完成 |
| Timelock | 提案通过后可设延迟便于紧急取消 | ✅ 已完成 |
| 提案类型扩展 | 多步骤、条件执行等 | ✅ 已完成 |
| 目标链选择与多链部署 | Base、Arbitrum、Polygon、Optimism 部署脚本与配置 | ✅ 已完成 |
| 前端链切换 | 链切换组件 + Hook | ✅ 已完成 |
| 跨链桥接 | LayerZero OApp 合约 + 前端界面 | ✅ 已完成 |
| DAO 扩展 | 提案元数据、取消机制、委托投票、投票权重 | ✅ 已完成 |
| 公开 API / SDK / 示例 / 合规说明 | 第三方接入 | ✅ 已完成 |
| 主网试运行指南 | 主网部署指南 + 检查清单 + 测试报告模板 | ✅ 已完成 |

---

## 五、明确不做或长期待做

### 5.1 不做（与概念设计一致，供对照）

| 项 | 说明 |
|----|------|
| 治理代币发行 | 不发行项目治理代币（见 [不发行代币说明](./不发行代币说明.md)） |
| 代币质押 | 不发行代币，无需质押 |
| 节点入网质押 | 节点入网无任何条件；不作恶/防 Sybil 靠信誉与绑定限制 |

### 5.2 Phase 4 长期待做

| 项 | 说明 | 状态 |
|----|------|------|
| iOS 原生 App | 在 PWA 基础上开发 iOS 原生应用 | ⏳ 待做 |
| Android 原生 App | 在 PWA 基础上开发 Android 原生应用 | ⏳ 待做 |
| React Native / Flutter | 跨平台移动端（替代原生方案） | ⏳ 待做 |

---

## 六、建议排期（从「可增加」高优先级起步）

### 立即可做（1 周内，高优先级）

- 价格参考集成（CoinGecko）
- 手续费透明化（费用 + 分成展示）
- 公开数据展示（流动性池、奖励池、交易记录）
- 贡献分手动领取界面
- 手机端钱包连接优化（wagmi + RainbowKit）

### 近期（2–4 周，高～中优先级）

- 订单簿持久化 + 订单签名验证
- Spam 防护（签名 + 限流）
- 安全加固（Replay、relayer 防滥用）
- 上线奖励流程（NodeRewards 部署 + snapshot 脚本 + 绑定与领取）
- 性能监控（Prometheus + Grafana）

### 中期（1–2 月）

- Epoch 撮合 + 批量结算（降 gas）
- 多 Relayer、Governance 分成提案
- 多链扩展（Arbitrum/Base 等）
- PWA 完善、贡献分自动领取（Chainlink Keeper）
- Tor 可选、高性能订单簿优化

### 长期（3–6 月+）

- 多签托管、原子交换、P2P 网格增强
- 桌面版清理或弱化
- Phase 4：原生 App / RN/Flutter（若立项）

---

## 七、相关文档索引

| 文档 | 用途 |
|------|------|
| [优化与改进清单](./优化与改进清单.md) | 详细问题表、实现建议、技术选型 |
| [项目分析与借鉴](./项目分析与借鉴.md) | 对标 DEX、Tor/订单簿/防 Sybil、部署与奖励设计 |
| [主网上线与优化总览](./主网上线与优化总览.md) | 项目现状、部署、Relayer、激励、防 Sybil、checklist |
| [实现建议-PR汇总](./实现建议-PR汇总.md) | 生产 compose、NodeRewards、snapshot、TVL 的 PR 要点 |
| [快速优化实现指南](./快速优化实现指南.md) | 价格参考、钱包、手续费透明化的具体实现步骤 |
| [公开数据展示实现指南](./公开数据展示实现指南.md) | 流动性池、奖励池、交易记录组件与接口 |
| [贡献分领取机制实现指南](./贡献分领取机制实现指南.md) | 手动/自动领取、统一 claim 设计 |
| [上线奖励分发机制实现指南](./上线奖励分发机制实现指南.md) | 绑定钱包、snapshot、Merkle、NodeRewards 流程 |
| [规划与路线图](./规划与路线图.md) | 阶段对照、已完成项、近期优先级 |

---

**变更说明**：本文档由原「功能增加与改进总结」与「待实现功能清单」合并而成。**从「可增加的功能（新能力，待做）」开始**，便于优先排期；随后为可优化、可改进、已完成项速览、不做/长期待做、排期与索引。具体实现细节以 [优化与改进清单](./优化与改进清单.md) 为准；完成某项后请同步更新 [规划与路线图](./规划与路线图.md) 与对应 Phase 文档。  
**2025-02 更新**：第一章表格增加「状态」列；价格参考集成、手续费透明化、公开数据展示、贡献分/奖励领取界面、PWA 完善、自动添加网络已标为 ✅ 已完成，并列入第四章 4.1 已完成项速览。
