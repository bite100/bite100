
# 功能优化计划

> 对项目的每个功能模块进行系统性优化，分步骤执行

## 优化原则

1. **用户体验优先**：优化用户可见的功能和交互
2. **性能优化**：提升响应速度和资源利用效率
3. **代码质量**：改进错误处理、类型安全、代码可维护性
4. **安全性**：加强输入验证、防攻击、权限控制

## 优化步骤（按优先级）

### 第一阶段：前端核心功能优化（用户直接体验）

#### 步骤 1：钱包连接优化
**文件**：`frontend/src/components/StandardConnect.tsx`, `frontend/src/services/standardConnect.ts`, `frontend/src/services/walletDeepLink.ts`

**优化点**：
- [x] 连接状态持久化（localStorage）
- [x] 连接失败时的详细错误提示（已增强：区分错误码、提供具体建议）
- [x] 多钱包支持优化（检测更多钱包类型）
- [x] 移动端深链接优化（避免 404）
- [x] 连接超时处理优化（30秒超时，详细错误信息）

**预计时间**：2-3 小时

#### 步骤 2：订单簿性能优化
**文件**：`frontend/src/OrderBookSection.tsx`, `frontend/src/components/VirtualList.tsx`, `frontend/src/services/wsClient.ts`

**优化点**：
- [x] 虚拟滚动（处理大量订单）：`VirtualList` 组件 + 买卖盘各 100 条、固定行高 28px、面板高度 220px
- [x] WebSocket 增量更新：OrderBookSection 订阅 `orderbook_update`，按 pair 更新 bids/asks，`normalizeOrder` 兼容节点字段
- [x] WebSocket 重连机制优化：重连延迟增加 ±20% 随机 jitter，订阅回调改为传完整 `WSMessage`（含 pair）
- [x] 订单簿数据缓存策略（沿用现有 dataCache，未改）
- [x] 价格变化动画优化（已实现：价格变化时显示绿色/红色闪烁动画，持续0.6秒）

**预计时间**：4-5 小时

#### 步骤 3：交易表单优化
**文件**：`frontend/src/components/OrderForm.tsx`, `frontend/src/OrderBookSection.tsx`, `frontend/src/hooks/useGasEstimate.ts`

**优化点**：
- [x] 输入验证增强（金额、价格范围：价格上限1000000，数量上限1000000000，实时验证）
- [x] Gas 估算优化（缓存、错误处理，已集成 useGasEstimate hook）
- [x] 交易状态实时反馈（pending、success、failed 状态显示，成功/失败动画）
- [x] 滑点保护提示（价格影响计算，超过5%警告，超过2%提示）
- [x] 余额不足提示优化（实时获取并显示余额，下单前检查余额）

**预计时间**：3-4 小时

#### 步骤 4：治理界面优化
**文件**：`frontend/src/GovernanceSection.tsx`, `frontend/src/services/governanceUtils.ts`

**优化点**：
- [x] 提案列表分页（每页10条，支持上一页/下一页导航）
- [x] 投票状态实时更新（每30秒自动刷新，可开启/关闭自动刷新）
- [x] 提案详情展示优化（显示投票权重、状态颜色标识）
- [x] 投票权重显示（显示赞成/反对的权重数值）
- [x] 提案创建表单验证（merkleRoot格式验证、活跃集人数范围验证、手续费范围验证）

**预计时间**：3-4 小时

#### 步骤 5：PWA/移动端优化
**文件**：`frontend/public/sw.js`, `frontend/public/manifest.webmanifest`, `frontend/src/components/ServiceWorkerUpdate.tsx`

**优化点**：
- [x] Service Worker 缓存策略优化（静态资源缓存优先，API网络优先，分层缓存策略）
- [x] 离线支持增强（离线页面fallback，API请求5分钟缓存，静态资源长期缓存）
- [x] 更新提示优化（滑动动画，24小时内忽略功能，立即刷新/稍后选项）
- [x] 移动端触控优化（最小触控区域44px，touch-action优化，tap-highlight优化）
- [x] 安装提示优化（manifest配置完善，shortcuts快捷方式）

**预计时间**：2-3 小时

---

### 第二阶段：合约优化（Gas 和安全性）

#### 步骤 6：Settlement 合约优化
**文件**：`contracts/src/Settlement.sol`

**优化点**：
- [x] Gas 优化（批量结算：直接调用内部函数避免外部调用开销）
- [x] 事件优化（减少 gas：为事件参数添加indexed，优化事件结构）
- [x] 输入验证增强（添加地址和金额边界检查，防止溢出）
- [x] 重入攻击防护（添加ReentrancyGuard，所有外部函数使用nonReentrant修饰符）
- [x] Relayer 限流优化（添加时间窗口内的调用次数限制，防止滥用）

**预计时间**：4-5 小时

#### 步骤 7：AMMPool 合约优化
**文件**：`contracts/src/AMMPool.sol`, `contracts/src/AMMPoolWithLiquidityReward.sol`

**优化点**：
- [x] 滑点保护优化（添加maxPriceImpactBps配置，swap时检查价格影响）
- [x] 价格影响计算优化（实现_calculatePriceImpact函数，添加getPriceImpact查询接口）
- [x] 流动性事件优化（Swap事件添加priceImpactBps参数）
- [x] 精度损失防护（添加MIN_LIQUIDITY常量，防止移除所有流动性，优化计算精度）
- [x] 闪电贷防护（添加ReentrancyGuard，检查最小流动性要求）

**预计时间**：3-4 小时

#### 步骤 8：Governance 合约优化
**文件**：`contracts/src/Governance.sol`, `contracts/src/GovernanceExtended.sol`

**优化点**：
- [x] 提案执行 gas 优化（使用位运算替代除法，优化冷却期检查逻辑）
- [x] 投票权重计算优化（实现_getVoteWeight函数，缓存投票权重到voteWeights映射）
- [x] Merkle proof 验证优化（保持现有高效验证，添加权重缓存）
- [x] 提案冷却期优化（优化时间窗口计算，避免不必要的存储读取）
- [x] 委托投票优化（添加delegates映射和setDelegate函数，支持委托投票）

**预计时间**：3-4 小时

---

### 第三阶段：节点优化（性能和稳定性）

#### 步骤 9：撮合引擎优化
**文件**：`node/internal/match/engine.go`, `node/internal/match/signature.go`

**优化点**：
- [x] 撮合算法优化（时间复杂度）- 使用插入排序替代完整排序，O(n)插入而非O(n log n)
- [x] 订单簿内存管理优化 - 限制订单簿大小，预分配切片容量，优化删除操作
- [x] 并发安全优化 - 已使用RWMutex，添加签名验证缓存锁
- [x] 订单验证优化 - 实现签名验证缓存，避免重复验证
- [x] 撮合性能监控 - 添加订单处理数、订单簿大小、签名缓存命中率等指标

**预计时间**：5-6 小时

#### 步骤 10：订单簿同步优化
**文件**：`node/internal/match/orderbook_sync.go`, `node/internal/match/consensus.go`

**优化点**：
- [x] 同步效率优化（增量同步）- 已实现增量同步逻辑，仅发送元数据
- [x] 冲突处理优化 - 添加冲突计数和检测机制
- [x] Leader 选举优化 - 基于term和节点列表的确定性选举，避免频繁切换
- [x] 同步状态监控 - 添加同步延迟、冲突次数、网络分区状态监控
- [x] 网络分区处理 - 检测冲突次数过多时标记网络分区

**预计时间**：4-5 小时

#### 步骤 11：API 服务优化
**文件**：`node/internal/api/server.go`, `node/internal/api/websocket.go`

**优化点**：
- [x] 限流优化（更精确的限流策略）- 实现令牌桶算法，更精确的限流控制
- [x] 响应缓存（Redis 或内存缓存）- 实现内存响应缓存，5秒TTL，自动清理过期缓存
- [x] 错误处理优化 - 添加panic恢复机制，防止服务崩溃
- [x] WebSocket 连接管理优化 - 添加最大连接数限制、消息队列管理、健康检查机制
- [x] API 响应时间监控 - 记录每个API路径的响应时间，保留最近100条记录

**预计时间**：3-4 小时

#### 步骤 12：存储优化
**文件**：`node/internal/storage/orders.go`, `node/internal/storage/retention.go`

**优化点**：
- [x] 数据清理优化（批量删除）- 实现批量删除（每批1000条），避免长时间锁定数据库
- [x] 索引优化（数据库查询）- 添加复合索引（pair+status, trader+pair），优化查询性能
- [x] 批量操作优化 - 预分配切片容量，使用LIMIT优化查询
- [x] 存储空间监控 - 记录清理前后的数据库大小，计算释放空间
- [x] 数据备份优化 - 添加SQLite性能优化参数（WAL、缓存、内存映射等），定期执行VACUUM

**预计时间**：3-4 小时

---

### 第四阶段：跨链和安全优化

#### 步骤 13：跨链桥接优化
**文件**：`contracts/src/CrossChainBridge.sol`, `frontend/src/components/CrossChainBridge.tsx`

**优化点**：
- [x] 费用估算优化 - 构建实际payload进行费用估算，显示费用信息
- [x] 状态查询优化 - 添加getBridgeStatus函数，支持查询请求状态、时间戳和重试次数
- [x] 错误处理优化 - 使用try-catch处理转账失败，更新状态为Failed
- [x] 跨链消息重试机制 - 实现retryBridge函数，支持重试失败的请求，配置最大重试次数和延迟
- [x] 跨链状态监控 - 添加BridgeStatus枚举和状态映射，监听状态更新事件，定期查询状态

**预计时间**：3-4 小时

#### 步骤 14：安全优化
**文件**：多个文件

**优化点**：
- [x] 订单签名验证增强 - 实现verifyOrderSignature函数，使用EIP-712标准验证订单签名，确保订单未被篡改
- [x] 防重放攻击（nonce 机制） - 创建OrderNonceManager合约，管理用户nonce，防止订单重放，检查nonce必须递增
- [x] Relayer 限流和信誉机制 - 添加RelayerReputation结构体，记录信誉分数和违规次数，成功交易加分，违规扣分，设置最小信誉阈值
- [x] 输入验证增强（所有用户输入） - 在settleTrade中验证所有参数（地址非零、金额非零、防止溢出、时间戳有效性），跨链桥接中验证时间戳过期
- [x] 权限控制优化 - 已使用onlyOwner和onlyOwnerOrGovernance修饰符，添加relayer信誉检查

**预计时间**：4-5 小时

---

## 执行顺序建议

1. **先做前端优化**（步骤 1-5）：用户直接体验，影响最大
2. **再做合约优化**（步骤 6-8）：Gas 节省，安全性提升
3. **然后节点优化**（步骤 9-12）：性能和稳定性
4. **最后跨链和安全**（步骤 13-14）：完善功能

## 优化进度跟踪

- [x] 步骤 1：钱包连接优化 ✅
- [x] 步骤 2：订单簿性能优化 ✅
- [x] 步骤 3：交易表单优化 ✅
- [x] 步骤 4：治理界面优化 ✅
- [x] 步骤 5：PWA/移动端优化 ✅
- [x] 步骤 6：Settlement 合约优化 ✅
- [x] 步骤 7：AMMPool 合约优化 ✅
- [x] 步骤 8：Governance 合约优化 ✅
- [x] 步骤 9：撮合引擎优化 ✅
- [x] 步骤 10：订单簿同步优化 ✅
- [x] 步骤 11：API 服务优化 ✅
- [x] 步骤 12：存储优化 ✅
- [x] 步骤 13：跨链桥接优化 ✅
- [x] 步骤 14：安全优化 ✅

## 注意事项

1. **每次优化后测试**：确保功能正常，无回归问题
2. **保持向后兼容**：尽量不破坏现有接口
3. **文档更新**：重要变更需更新相关文档
4. **代码审查**：优化后的代码需要审查
5. **性能测试**：关键优化需要性能测试验证

---

**最后更新**：2026-02-10
