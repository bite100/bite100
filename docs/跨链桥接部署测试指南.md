# 跨链桥接部署测试指南

> 版本：v1.0  
> 更新日期：2025-02-08

---

## 一、前置准备

### 1.1 安装依赖

**安装 LayerZero OApp EVM**：

```powershell
cd contracts
.\scripts\install-layerzero.ps1
```

或手动安装：

```bash
cd contracts
forge install LayerZero-Labs/oapp-evm --no-commit
```

**验证安装**：

```bash
forge build
```

### 1.2 环境变量配置

在 `contracts` 目录创建或编辑 `.env` 文件：

```bash
# 私钥（用于部署）
PRIVATE_KEY=0x你的私钥

# RPC URLs（测试网）
SEPOLIA_RPC_URL=https://ethereum-sepolia.publicnode.com
BASE_SEPOLIA_RPC_URL=https://sepolia.base.org
ARBITRUM_SEPOLIA_RPC_URL=https://sepolia-rollup.arbitrum.io/rpc
```

---

## 二、部署桥接合约

### 2.1 部署到 Sepolia

```powershell
cd contracts
.\scripts\deploy-crosschain-bridge.ps1 -Chain sepolia
```

### 2.2 部署到 Base Sepolia

```powershell
.\scripts\deploy-crosschain-bridge.ps1 -Chain base_sepolia
```

### 2.3 部署到 Arbitrum Sepolia

```powershell
.\scripts\deploy-crosschain-bridge.ps1 -Chain arbitrum_sepolia
```

### 2.4 记录合约地址

部署成功后，记录输出的合约地址，例如：

```
CrossChainBridge deployed at: 0x1234...
```

---

## 三、配置代币映射

### 3.1 配置示例

假设：
- **Sepolia** 桥接合约：`0xSepoliaBridge`
- **Base Sepolia** 桥接合约：`0xBaseBridge`
- **Sepolia** 代币：`0xSepoliaToken`
- **Base Sepolia** 代币：`0xBaseToken`

**LayerZero EID（Endpoint ID）映射**：
- Sepolia: 40161
- Base Sepolia: 40245
- Arbitrum Sepolia: 40231

**在 Sepolia 上配置**：

```powershell
.\scripts\configure-bridge-tokens.ps1 `
    -BridgeAddress 0xSepoliaBridge `
    -Chain sepolia `
    -Token 0xSepoliaToken `
    -DstChainId 40245 `
    -DstToken 0xBaseToken
```

**在 Base Sepolia 上配置**：

```powershell
.\scripts\configure-bridge-tokens.ps1 `
    -BridgeAddress 0xBaseBridge `
    -Chain base_sepolia `
    -Token 0xBaseToken `
    -DstChainId 40161 `
    -DstToken 0xSepoliaToken
```

### 3.2 配置多个代币

对每个需要桥接的代币重复上述步骤。

---

## 四、更新前端配置

### 4.1 更新链配置

编辑 `frontend/src/config/chains.ts`：

```typescript
const SEPOLIA: ChainConfig = {
  // ...
  contracts: {
    // ...
    crossChainBridge: '0xSepoliaBridge', // 添加桥接合约地址
  },
}

const BASE_SEPOLIA: ChainConfig = {
  // ...
  contracts: {
    // ...
    crossChainBridge: '0xBaseBridge',
  },
}
```

### 4.2 更新组件

`CrossChainBridge.tsx` 会自动读取链配置中的桥接合约地址。

---

## 五、测试跨链转移

### 5.1 准备测试代币

确保在源链和目标链都有测试代币：
- Sepolia: 使用已有的测试代币或部署新的
- Base Sepolia: 部署对应的测试代币

### 5.2 前端测试

1. **打开前端应用**
2. **切换到"跨链桥"标签页**
3. **选择源链和目标链**
4. **输入代币地址和数量**
5. **点击"发起跨链转移"**
6. **等待确认**（通常需要 5-15 分钟）

### 5.3 验证结果

**在源链**：
- 检查代币余额是否减少
- 检查桥接合约余额是否增加

**在目标链**：
- 检查用户代币余额是否增加
- 检查桥接合约事件

### 5.4 使用区块浏览器

**Sepolia Etherscan**：
```
https://sepolia.etherscan.io/address/0xSepoliaBridge
```

**Base Sepolia Basescan**：
```
https://sepolia.basescan.org/address/0xBaseBridge
```

查看：
- 合约部署交易
- 桥接转移交易
- 事件日志

---

## 六、常见问题

### Q1: 部署失败，提示找不到 LayerZero 依赖

**A**: 运行 `.\scripts\install-layerzero.ps1` 安装依赖。

### Q2: 编译错误，提示找不到 OApp

**A**: 检查 `foundry.toml` 中的 remappings 是否正确：

```toml
remappings = [
    "@layerzerolabs/oapp-evm/=lib/oapp-evm/",
    "@openzeppelin/contracts/=lib/openzeppelin-contracts/contracts/"
]
```

### Q3: 桥接转移失败

**A**: 检查：
1. 代币映射是否配置正确
2. 代币是否已添加到支持列表
3. 用户是否已授权代币
4. 是否有足够的 Gas 费用

### Q4: 如何查询转移状态？

**A**: 
1. 使用 LayerZero 扫描器：https://layerzeroscan.com/
2. 查看合约事件：`BridgeInitiated` 和 `BridgeCompleted`
3. 检查目标链的用户余额

### Q5: 费用如何计算？

**A**: LayerZero 费用包括：
- 源链 Gas 费用
- 跨链消息传递费用
- 目标链 Gas 费用（由用户支付或通过 Gas Service）

---

## 七、单元测试

运行测试：

```bash
cd contracts
forge test --match-contract CrossChainBridgeTest -vvv
```

**注意**：由于需要 LayerZero Endpoint，部分测试可能需要 mock 或 fork 测试。

---

## 八、下一步

1. ✅ 部署到主网（Base、Arbitrum）
2. ✅ 配置主网代币映射
3. ✅ 集成到生产环境
4. ✅ 监控桥接活动
5. ✅ 优化 Gas 费用

---

## 九、相关文档

- [跨链桥接实现指南](./跨链桥接实现指南.md)
- [跨链功能设计](./跨链功能设计.md)
- [LayerZero 官方文档](https://docs.layerzero.network/v2)

---

*本文档说明如何部署和测试跨链桥接功能。*
