# 主网试运行指南

> 版本：v1.0  
> 更新日期：2025-02-08

---

## 一、概述

本文档提供主网试运行的完整流程，包括部署前检查、部署步骤、功能验证和监控。主网试运行旨在验证前端和治理在主网环境下的表现。

---

## 二、部署前检查清单

### 2.1 测试网验证 ✅

在部署主网前，确保以下功能在测试网（Sepolia）已完整验证：

- [ ] **基础功能**
  - [ ] 资产存提（Vault deposit/withdraw）
  - [ ] AMM Swap
  - [ ] 添加流动性
  - [ ] 订单簿查看和下单

- [ ] **治理功能**
  - [ ] 创建提案
  - [ ] 投票（含活跃集验证）
  - [ ] 提案执行
  - [ ] 多步骤提案执行
  - [ ] 提案取消

- [ ] **贡献奖励**
  - [ ] 贡献证明提交
  - [ ] 奖励领取
  - [ ] 贡献看板显示

- [ ] **跨链功能**（如已实现）
  - [ ] 链切换
  - [ ] 跨链桥接

### 2.2 资金准备

- [ ] **部署资金**：准备 0.05-0.1 ETH（视 Gas 价格）
- [ ] **测试资金**：准备少量 USDC/USDT 用于测试（如使用 USDC/USDT 池）
- [ ] **Gas 费用**：确认钱包有足够 ETH 支付交易费用

### 2.3 环境配置

- [ ] **RPC 节点**：配置主网 RPC（推荐使用 Alchemy/Infura，备用公开 RPC）
- [ ] **私钥安全**：确认私钥安全存储，未提交到版本库
- [ ] **环境变量**：检查 `.env` 文件配置正确

### 2.4 代币选择

选择主网真实 ERC20 代币对：

| 组合 | TOKEN0 | TOKEN1 | 说明 |
|------|--------|--------|------|
| **USDC/USDT** | `0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48` | `0xdAC17F958D2ee523a2206206994597C13D831ec7` | 稳定币对，流动性好 |
| **WETH/USDC** | `0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2` | `0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48` | ETH 稳定币对 |
| **WETH/USDT** | `0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2` | `0xdAC17F958D2ee523a2206206994597C13D831ec7` | ETH 稳定币对 |

**验证代币地址**：
- 在 [Etherscan](https://etherscan.io) 确认代币地址正确
- 检查代币合约是否为官方版本（避免仿盘）

---

## 三、部署步骤

### 3.1 环境变量配置

在 `contracts` 目录创建或编辑 `.env`：

```bash
# 必填
PRIVATE_KEY=0x你的主网部署私钥

# 可选
MAINNET_RPC_URL=https://ethereum.publicnode.com
TOKEN0_ADDRESS=0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48  # USDC
TOKEN1_ADDRESS=0xdAC17F958D2ee523a2206206994597C13D831ec7  # USDT
FEE_RECIPIENT=0x...  # 可选，默认部署者 100%
```

### 3.2 执行部署

```powershell
cd contracts

# 设置代币地址
$env:TOKEN0_ADDRESS = "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48"   # USDC
$env:TOKEN1_ADDRESS = "0xdAC17F958D2ee523a2206206994597C13D831ec7"   # USDT

# 执行部署
.\scripts\deploy-mainnet.ps1
```

部署脚本会：
1. 提示确认（输入 `YES`）
2. 部署所有合约
3. 输出合约地址

### 3.3 记录合约地址

部署成功后，记录所有合约地址：

```
Vault: 0x...
FeeDistributor: 0x...
Settlement: 0x...
AMMPool: 0x...
ContributorReward: 0x...
Governance: 0x...
TokenRegistry: 0x...
ChainConfig: 0x...
```

---

## 四、前端配置

### 4.1 更新合约地址

编辑 `frontend/src/config/chains.ts`，更新 `MAINNET` 配置：

```typescript
const MAINNET: ChainConfig = {
  chainId: 1,
  name: 'Ethereum',
  rpcUrl: 'https://ethereum.publicnode.com',
  blockExplorer: 'https://etherscan.io',
  nativeCurrency: {
    name: 'ETH',
    symbol: 'ETH',
    decimals: 18,
  },
  contracts: {
    vault: '0x...',              // 从部署输出复制
    settlement: '0x...',
    token0: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',  // USDC
    token1: '0xdAC17F958D2ee523a2206206994597C13D831ec7',  // USDT
    ammPool: '0x...',
    contributorReward: '0x...',
    governance: '0x...',
    tokenRegistry: '0x...',
    chainConfig: '0x...',
  },
}
```

### 4.2 构建主网版本

```bash
cd frontend
npm run build:mainnet
```

或使用环境变量：

```bash
cross-env VITE_NETWORK=mainnet npm run build
```

### 4.3 部署前端

将构建的 `dist/` 目录部署到：
- Vercel
- Netlify
- GitHub Pages
- 或其他静态托管服务

---

## 五、部署后验证

### 5.1 合约验证（可选）

在 Etherscan 验证合约源码：

```powershell
# 在 .env 中设置 ETHERSCAN_API_KEY
forge script script/Deploy.s.sol:Deploy --sig "runMainnetFull()" --rpc-url $rpc --broadcast --verify
```

### 5.2 区块浏览器检查

访问 [Etherscan](https://etherscan.io)，检查：

- [ ] 所有合约已部署
- [ ] 合约交互正常（Vault.setSettlement、Governance 绑定等）
- [ ] 无异常交易

### 5.3 前端连接测试

- [ ] 打开前端应用
- [ ] 连接 MetaMask，切换到 Ethereum 主网
- [ ] 验证合约地址显示正确
- [ ] 检查各功能模块加载正常

---

## 六、功能测试流程

### 6.1 基础功能测试

#### 6.1.1 资产存提

1. **存入资产**：
   - [ ] 选择代币（USDC/USDT）
   - [ ] 输入数量
   - [ ] 授权代币
   - [ ] 确认存入
   - [ ] 验证余额更新

2. **提取资产**：
   - [ ] 输入提取数量
   - [ ] 确认提取
   - [ ] 验证余额更新

#### 6.1.2 AMM Swap

1. **添加流动性**：
   - [ ] 输入 Token0 和 Token1 数量
   - [ ] 授权代币
   - [ ] 添加流动性
   - [ ] 验证池子储备更新

2. **执行 Swap**：
   - [ ] 选择交换方向
   - [ ] 输入数量
   - [ ] 查看预估输出
   - [ ] 执行 Swap
   - [ ] 验证余额变化

#### 6.1.3 订单簿

- [ ] 查看订单簿
- [ ] 下单（如已实现）
- [ ] 撤单（如已实现）
- [ ] 查看成交历史

### 6.2 治理功能测试

#### 6.2.1 创建提案

1. **准备提案数据**：
   - [ ] 确定目标合约和调用数据
   - [ ] 准备活跃集 Merkle 树
   - [ ] 计算活跃集大小

2. **创建提案**：
   - [ ] 在前端填写提案信息
   - [ ] 上传 Merkle 证明
   - [ ] 提交提案
   - [ ] 验证提案 ID 和状态

#### 6.2.2 投票

1. **投票准备**：
   - [ ] 确认账户在活跃集中
   - [ ] 生成 Merkle 证明

2. **执行投票**：
   - [ ] 选择支持/反对
   - [ ] 提交投票
   - [ ] 验证投票计数更新

#### 6.2.3 提案执行

1. **等待投票期结束**：
   - [ ] 检查投票状态
   - [ ] 确认提案通过

2. **执行提案**：
   - [ ] 点击"执行"按钮
   - [ ] 确认交易
   - [ ] 验证执行结果

### 6.3 贡献奖励测试

- [ ] 查看贡献看板
- [ ] 检查贡献分数
- [ ] 领取奖励（如有）
- [ ] 验证奖励到账

### 6.4 跨链功能测试（如已实现）

- [ ] 切换链（Base、Arbitrum 等）
- [ ] 跨链桥接（如已部署）

---

## 七、监控与日志

### 7.1 合约监控

**Etherscan 监控**：
- 设置合约地址监控
- 关注异常交易
- 监控 Gas 使用情况

**事件监控**：
- `TradeSettled`：交易结算
- `ProposalCreated`：提案创建
- `Voted`：投票事件
- `ProposalExecuted`：提案执行

### 7.2 前端监控

- [ ] 错误日志收集（如 Sentry）
- [ ] 用户行为分析
- [ ] 性能监控

### 7.3 节点监控（如运行节点）

- [ ] 节点连接状态
- [ ] 订单同步状态
- [ ] 贡献指标统计

---

## 八、回滚计划

### 8.1 紧急情况处理

如果发现严重问题：

1. **暂停前端**：
   - 更新前端，显示维护公告
   - 或临时下线前端

2. **合约暂停**（如实现）：
   - 通过治理暂停关键功能
   - 或使用紧急暂停机制

3. **通知用户**：
   - 通过官方渠道通知
   - 说明问题和处理计划

### 8.2 数据备份

- [ ] 备份合约地址和配置
- [ ] 备份交易记录
- [ ] 备份治理提案数据

---

## 九、测试报告模板

完成试运行后，填写测试报告：

### 9.1 部署信息

- **部署时间**：YYYY-MM-DD HH:MM
- **部署网络**：Ethereum Mainnet (Chain ID: 1)
- **Gas 费用**：XXX ETH
- **合约地址**：（见部署输出）

### 9.2 功能测试结果

| 功能模块 | 测试项 | 结果 | 备注 |
|---------|--------|------|------|
| 资产存提 | 存入 | ✅/❌ | |
| | 提取 | ✅/❌ | |
| AMM | 添加流动性 | ✅/❌ | |
| | Swap | ✅/❌ | |
| 治理 | 创建提案 | ✅/❌ | |
| | 投票 | ✅/❌ | |
| | 执行提案 | ✅/❌ | |
| 订单簿 | 查看 | ✅/❌ | |
| | 下单 | ✅/❌ | |

### 9.3 问题记录

- **问题 1**：描述
  - 影响：高/中/低
  - 状态：已解决/待解决
  - 解决方案：

### 9.4 性能指标

- **Gas 费用**：平均 XXX gwei
- **交易确认时间**：平均 XXX 秒
- **前端加载时间**：XXX 秒

---

## 十、后续步骤

### 10.1 优化建议

根据试运行结果，提出优化建议：

- [ ] Gas 优化
- [ ] 用户体验改进
- [ ] 功能增强
- [ ] 安全性提升

### 10.2 文档更新

- [ ] 更新部署文档
- [ ] 更新用户指南
- [ ] 记录已知问题

---

## 十一、相关文档

- [主网部署指南](./主网部署指南.md)
- [部署与使用说明](./部署与使用说明.md)
- [治理部署与提案执行指南](./治理部署与提案执行指南.md)
- [API-接口说明](./API-接口说明.md)

---

*本文档提供主网试运行的完整流程，帮助验证系统在主网环境下的表现。*
