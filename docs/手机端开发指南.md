# 手机端开发指南

> 依据 [概念设计文档](./概念设计文档.md)、[技术架构说明](./技术架构说明.md)、[规划与路线图](./规划与路线图.md) 整理。  
> 关联：[部署与使用说明 §3.4](./部署与使用说明.md#34-链下订单簿节点-api手机端缓存与-p2p-多节点)、[API-接口说明](./API-接口说明.md)

---

## 一、文档中的定位

| 来源 | 说明 |
|------|------|
| **概念设计** | 未来支持手机端（iOS / Android）；与「仅 Web 端」对比，列为创新点。 |
| **技术架构** | 应用层包含「Web DApp \| 移动端 \| CLI \| SDK」；移动端技术栈为 **React Native / Flutter**，用途为「手机端交易（未来支持）」；首期以 Web 为主，后续提供 iOS/Android 客户端。 |
| **规划与路线图** | **Phase 4** 包含手机端；在现有 **PWA 基础上**，视需求做 **iOS/Android 原生** 或 **React Native/Flutter**。当前已完成：PWA、viewport/安全区、触控区域、localStorage 持久化、短期 RPC 缓存、**订单簿本地缓存**与 **P2P 多节点连接**。 |

结论：**当前推荐** 使用现有 Web 前端的 **PWA 形态** 在手机浏览器或「添加到主屏幕」使用；**Phase 4** 再视需求做 **原生 App** 或 **React Native / Flutter** 跨平台开发。

---

## 二、方案一：PWA 手机端（当前推荐）

### 2.1 已具备能力

- **移动端适配**：viewport、安全区（viewport-fit=cover）、触控区域、主题色与 standalone 显示。
- **本地持久化**：localStorage（代币选择、Swap 方向等）；链上只读数据短期内存缓存（余额、储备、Swap 预览）。
- **链下订单簿**：  
  - **本地缓存**：订单簿、最近成交、我的订单约 **5 分钟** 缓存，弱网/离线先展示缓存并标注「部分为缓存数据」。  
  - **P2P 多节点**：`VITE_NODE_API_URL` 支持**逗号分隔**多个节点 URL，前端按顺序尝试连接，适合手机端/弱网自动切换。

### 2.2 使用方式

1. **部署前端**：与 Web 一致，构建后部署到 HTTPS 域名（PWA 要求 HTTPS）。  
   ```bash
   cd frontend && npm run build
   ```
2. **手机访问**：在 Safari（iOS）或 Chrome（Android）打开站点 URL。
3. **添加到主屏幕**：  
   - **iOS**：Safari 菜单 →「添加到主屏幕」→ 之后从主屏幕打开，以 standalone 运行。  
   - **Android**：Chrome 菜单 →「安装应用」或「添加到主屏幕」。
4. **配置节点**（链下订单簿）：  
   - 单节点：`VITE_NODE_API_URL=https://your-node:8080`  
   - 多节点（P2P）：`VITE_NODE_API_URL=https://node1:8080,https://node2:8080`  
   构建时注入；多节点时界面会显示「P2P 多节点（N 个）」与当前连接节点。

### 2.3 配置与构建

- 网络/合约：与 Web 相同，见 [部署与使用说明 §3](./部署与使用说明.md#三前端配置与运行)。  
- 环境变量：`VITE_NETWORK`（sepolia/mainnet/polygon）、`VITE_NODE_API_URL`（单或多节点）、`VITE_WC_PROJECT_ID`（可选，用于启用 WalletConnect）。  
- 钱包：依赖设备浏览器内的钱包扩展（如 MetaMask/Rabby/Phantom EVM/OKX 等），或通过 **WalletConnect** 从外部浏览器自动拉起钱包 App。前端已接入 **Wagmi + RainbowKit**（`WagmiProvider` + `RainbowKitProvider` + `ConnectButton`），连接弹窗自动支持 deep link、QR 扫码、多钱包选择，手机端连接成功率更高。

---

## 三、方案二：原生 / 跨平台 App（Phase 4）

文档规划：在 PWA 基础上，**视需求**做 **iOS/Android 原生** 或 **React Native / Flutter**。

### 3.1 技术选型（与文档一致）

| 方案 | 技术 | 说明 |
|------|------|------|
| 跨平台 | **React Native** | 与现有 React 前端共享逻辑与类型；ethers/合约调用可抽成共用层。 |
| 跨平台 | **Flutter** | 独立 UI；需用 Dart 封装链上/节点 API 或通过 FFI/通道调用现有 TS/JS 逻辑。 |
| 原生 | **iOS (Swift)** / **Android (Kotlin)** | 最大控制力与性能；需自行实现合约调用、节点 API、缓存与多节点逻辑。 |

**建议**：若团队以 React/TypeScript 为主，优先 **React Native**，便于复用 `frontend/src` 中的 config、ABI、utils、nodeClient、dataCache 等；若以移动端原生或 Flutter 为主，可选用 Flutter 或原生，接口与数据格式与下节一致即可。

### 3.2 与现有前端的复用

无论采用哪种方案，**接口与数据格式**与当前 Web 一致即可：

| 内容 | 位置/说明 |
|------|-----------|
| **链配置与合约地址** | `frontend/src/config.ts`：CHAIN_ID、RPC_URL、各合约地址、ABI（VAULT_ABI、AMM_ABI、GOVERNANCE_ABI、CONTRIBUTOR_REWARD_ABI 等）。 |
| **节点 API** | 与节点 HTTP API 一致：[API-接口说明](./API-接口说明.md) 与节点 `api.listen`；**GET** `/api/orderbook`、`/api/trades`、`/api/orders`、`/api/node`；**POST** `/api/order`、`/api/order/cancel`。 |
| **多节点连接** | 与前端一致：配置多个节点 URL，依次尝试直至成功；实现可参考 `frontend/src/nodeClient.ts`（tryNodes、nodeGet、nodePost）。 |
| **本地缓存** | 订单簿/成交/我的订单：key 按 pair、account 区分，TTL 约 5 分钟；逻辑可参考 `frontend/src/dataCache.ts`。 |
| **错误与提示** | 用户可读错误（拒绝签名、网络异常、余额不足等）可参考 `frontend/src/utils.ts` 的 formatError 规则。 |

**React Native 复用方式示例**：

- 将 `frontend/src` 中与 UI 无关的模块抽到共享包（如 `shared/` 或 npm 私有包）：`config`、`utils`（formatError、formatTokenAmount、shortAddress 等）、`dataCache`、`nodeClient`、以及合约 ABI/地址。  
- RN 项目依赖该包，页面用 RN 组件调用同一套 config/nodeClient/dataCache。  
- 钱包：使用 **WalletConnect** 或各链官方 SDK（ethers/viem 等），与 Web 的 EIP-1193 在「签名与发交易」上等价。

### 3.3 数据与连接要点

- **链上**：RPC（与 config 一致）、合约地址与 ABI、签名与发送交易（钱包或 WalletConnect）。  
- **链下订单簿**：  
  - 通过 **节点 HTTP API** 获取订单簿、成交、我的订单；下单/撤单走 POST。  
  - **多节点**：多个 baseUrl 依次 try，第一个成功即用该节点。  
  - **缓存**：先读本地缓存（若有且未过期）再请求；请求成功后写回缓存，弱网/离线时展示缓存并标注。  
- **历史成交同步**（可选）：若需超过节点保留期的数据，可按 [Phase2-设计文档](./Phase2-设计文档.md) 与 [节点部署](./节点部署.md) 中说明，向电脑端节点发起 **SyncTrades** 协议（当前为 Go 节点 libp2p 协议）；手机端若为 RN/Flutter，可仅用 HTTP API 获取节点已暴露的最近数据，或后续再接 libp2p 客户端。

### 3.4 目录与工程建议

- **独立仓库或 monorepo**：  
  - 若 RN：可 `packages/web`（现有 frontend）、`packages/mobile`（RN），共享 `packages/shared`（config、utils、nodeClient、dataCache、ABI）。  
  - 若 Flutter/原生：单独 app 工程，通过文档与 OpenAPI/示例对接节点 API 与链上接口；或通过 FFI/通道调用一份 TypeScript 编译产物。  
- **环境与构建**：  
  - 开发/测试网：NODE_API_URL 指向测试节点列表；CHAIN_ID 为 Sepolia。  
  - 生产：主网 RPC 与合约地址；NODE_API_URL 为生产多节点列表。  
- **文档**：保持与 [API-接口说明](./API-接口说明.md)、[部署与使用说明 §3.4](./部署与使用说明.md#34-链下订单簿节点-api手机端缓存与-p2p-多节点) 一致，便于多端对齐。

---

## 四、接口与文档索引

| 文档 | 用途 |
|------|------|
| [部署与使用说明 §3.4](./部署与使用说明.md#34-链下订单簿节点-api手机端缓存与-p2p-多节点) | 节点 API 配置、手机端缓存、P2P 多节点 |
| [API-接口说明](./API-接口说明.md) | 链配置、合约 ABI、Settlement/AMMPool/Governance 等 |
| [技术架构说明 §5](./技术架构说明.md#五应用层) | 客户端类型、用户流程、Phase 3 链下订单簿流程 |
| [节点部署](./节点部署.md) | 节点运行与 api.listen |
| [节点发现与Bootstrap](./节点发现与Bootstrap.md) | 多节点/多区域部署，便于配置多节点 URL |

---

*手机端开发以当时文档与代码为准；Phase 4 原生/RN/Flutter 落地时再同步更新本指南与规划与路线图。*
