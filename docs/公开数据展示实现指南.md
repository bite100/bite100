# å…¬å¼€æ•°æ®å±•ç¤ºå®ç°æŒ‡å—

> æµåŠ¨æ€§æ± ä½™é¢ã€å¥–åŠ±æ± ä½™é¢ã€äº¤æ˜“è®°å½• - æ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ°çš„é€æ˜æ•°æ®

---

## ä¸€ã€æ ¸å¿ƒåŸåˆ™

**DeFi é€æ˜æ€§**ï¼šæ‰€æœ‰æ•°æ®éƒ½æ¥è‡ªé“¾ä¸ŠæŸ¥è¯¢ï¼Œå…¬å¼€é€æ˜ï¼Œä»»ä½•äººé€šè¿‡æµè§ˆå™¨éƒ½èƒ½æŸ¥çœ‹ï¼Œæ— éœ€è¿æ¥é’±åŒ…ã€‚

**å®ç°æ–¹å¼**ï¼š
- ä½¿ç”¨ `wagmi` çš„ `useContractRead`ï¼ˆæ— éœ€ç­¾åï¼‰
- ä½¿ç”¨ `ethers.js` çš„ `provider` æŸ¥è¯¢ï¼ˆpublic view å‡½æ•°ï¼‰
- å®æ—¶åˆ·æ–°ï¼ˆ10-30 ç§’ï¼‰
- æ‰‹æœºç«¯å‹å¥½ï¼ˆå¡ç‰‡å¸ƒå±€ã€è§¦æ§å‹å¥½ï¼‰

---

## äºŒã€æµåŠ¨æ€§æ± ä½™é¢ï¼ˆLiquidity Pool Balanceï¼‰

### 2.1 æ•°æ®æ¥æº

**åˆçº¦**ï¼šAMMPoolï¼ˆåœ°å€ `0x8d392e6b270238c3a05dDB719795eE31ad7c72AF`ï¼‰

**æŸ¥è¯¢å‡½æ•°**ï¼š
- `getReserves()` - è¿”å› `[reserve0, reserve1]`
- `reserve0()` / `reserve1()` - åˆ†åˆ«æŸ¥è¯¢
- `totalSupply()` - LP token æ€»é‡
- `balanceOf(address)` - æ± å­ä½™é¢

### 2.2 å®ç°ä»£ç 

åˆ›å»º `frontend/src/components/LiquidityPoolInfo.tsx`ï¼š

```typescript
import { useEffect, useState } from 'react'
import { Contract } from 'ethers'
import { getProvider } from '../utils'
import { AMM_POOL_ADDRESS, AMM_ABI } from '../config'
import { useTokenPrice } from '../hooks/useTokenPrice'

interface Reserves {
  reserve0: bigint
  reserve1: bigint
  totalSupply: bigint
}

export function LiquidityPoolInfo() {
  const [reserves, setReserves] = useState<Reserves | null>(null)
  const [loading, setLoading] = useState(true)
  const [tvl, setTvl] = useState<number>(0)

  // è·å–ä»£å¸ä»·æ ¼ï¼ˆç”¨äºè®¡ç®— TVLï¼‰
  const { price: tokenAPrice } = useTokenPrice('your-tka-coingecko-id')
  const { price: tokenBPrice } = useTokenPrice('your-tkb-coingecko-id')

  useEffect(() => {
    const fetchReserves = async () => {
      try {
        const provider = getProvider()
        if (!provider) {
          // å³ä½¿æ²¡æœ‰é’±åŒ…ï¼Œä¹Ÿå¯ä»¥ç”¨å…¬å…± RPC
          const { BrowserProvider } = await import('ethers')
          const publicProvider = new BrowserProvider(
            window.ethereum || { request: async () => null }
          )
          const contract = new Contract(AMM_POOL_ADDRESS, AMM_ABI, await publicProvider.getSigner())
          
          const [reserve0, reserve1, totalSupply] = await Promise.all([
            contract.reserve0(),
            contract.reserve1(),
            contract.totalSupply(),
          ])

          setReserves({
            reserve0,
            reserve1,
            totalSupply,
          })

          // è®¡ç®— TVLï¼ˆæ€»ä»·å€¼é”å®šï¼‰
          if (tokenAPrice && tokenBPrice) {
            const tvl0 = Number(reserve0) / 1e18 * tokenAPrice.usd
            const tvl1 = Number(reserve1) / 1e18 * tokenBPrice.usd
            setTvl(tvl0 + tvl1)
          }
        } else {
          const contract = new Contract(AMM_POOL_ADDRESS, AMM_ABI, provider)
          const [reserve0, reserve1, totalSupply] = await Promise.all([
            contract.reserve0(),
            contract.reserve1(),
            contract.totalSupply(),
          ])

          setReserves({
            reserve0,
            reserve1,
            totalSupply,
          })

          if (tokenAPrice && tokenBPrice) {
            const tvl0 = Number(reserve0) / 1e18 * tokenAPrice.usd
            const tvl1 = Number(reserve1) / 1e18 * tokenBPrice.usd
            setTvl(tvl0 + tvl1)
          }
        }
      } catch (err) {
        console.error('Failed to fetch reserves:', err)
      } finally {
        setLoading(false)
      }
    }

    fetchReserves()
    const interval = setInterval(fetchReserves, 10000) // 10 ç§’åˆ·æ–°
    return () => clearInterval(interval)
  }, [tokenAPrice, tokenBPrice])

  if (loading) {
    return (
      <div className="card">
        <div className="skeleton">åŠ è½½ä¸­...</div>
      </div>
    )
  }

  if (!reserves) {
    return <div className="card">æ— æ³•åŠ è½½æ•°æ®</div>
      </div>
  }

  return (
    <div className="card">
      <h3 className="text-lg font-bold mb-3">æµåŠ¨æ€§æ± ä½™é¢</h3>
      
      <div className="space-y-2">
        <div className="flex justify-between">
          <span className="text-gray-600">Token A (TKA):</span>
          <span className="font-medium">
            {(Number(reserves.reserve0) / 1e18).toLocaleString(undefined, {
              maximumFractionDigits: 2,
            })}{' '}
            TKA
          </span>
        </div>
        
        <div className="flex justify-between">
          <span className="text-gray-600">Token B (TKB):</span>
          <span className="font-medium">
            {(Number(reserves.reserve1) / 1e18).toLocaleString(undefined, {
              maximumFractionDigits: 2,
            })}{' '}
            TKB
          </span>
        </div>

        {tvl > 0 && (
          <div className="flex justify-between pt-2 border-t">
            <span className="text-gray-600">æ€»ä»·å€¼é”å®š (TVL):</span>
            <span className="font-bold text-green-600">
              ${tvl.toLocaleString(undefined, { maximumFractionDigits: 2 })}
            </span>
          </div>
        )}
      </div>

      <p className="text-xs text-gray-500 mt-3">
        ğŸ“Š å…¬å¼€æ•°æ®ï¼Œä»»ä½•äººå¯è§ Â· æ¯ 10 ç§’è‡ªåŠ¨åˆ·æ–°
      </p>
    </div>
  )
}
```

### 2.3 ä¼˜åŒ–å»ºè®®

- âœ… å®æ—¶åˆ·æ–°ï¼ˆ10 ç§’ï¼‰
- âœ… æ ¼å¼åŒ–æ•°å­—ï¼ˆ`toLocaleString`ï¼‰
- âœ… æ˜¾ç¤º TVLï¼ˆç”¨ CoinGecko API è½¬ USDï¼‰
- âœ… æ‰‹æœºç«¯å¡ç‰‡å¸ƒå±€
- âœ… Loading skeleton

---

## ä¸‰ã€å¥–åŠ±æ± ä½™é¢ï¼ˆReward Pool / FeeDistributor Balanceï¼‰

### 3.1 æ•°æ®æ¥æº

**åˆçº¦**ï¼šFeeDistributorï¼ˆåœ°å€ `0xeF4BFB58541270De18Af9216EB0Cd8EC07a2547F`ï¼‰

**æŸ¥è¯¢å‡½æ•°**ï¼š
- `balanceOf(address token)` - æŸ¥è¯¢æŒ‡å®šä»£å¸ä½™é¢
- ç›´æ¥æŸ¥åˆçº¦ ETH ä½™é¢ï¼š`provider.getBalance(address)`
- `IERC20.balanceOf(address(this))` - æŸ¥è¯¢ ERC20 ä»£å¸ä½™é¢

### 3.2 å®ç°ä»£ç 

åˆ›å»º `frontend/src/components/RewardPoolInfo.tsx`ï¼š

```typescript
import { useEffect, useState } from 'react'
import { Contract } from 'ethers'
import { getProvider } from '../utils'
import { FEE_DISTRIBUTOR_ADDRESS, FEE_DISTRIBUTOR_ABI, TOKEN0_ADDRESS, TOKEN1_ADDRESS, ERC20_ABI } from '../config'

interface RewardPoolBalance {
  eth: bigint
  tokenA: bigint
  tokenB: bigint
}

export function RewardPoolInfo() {
  const [balance, setBalance] = useState<RewardPoolBalance | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    const fetchBalance = async () => {
      try {
        const provider = getProvider()
        if (!provider) return

        const feeDistributor = new Contract(
          FEE_DISTRIBUTOR_ADDRESS,
          FEE_DISTRIBUTOR_ABI,
          provider
        )

        // æŸ¥è¯¢ ETH ä½™é¢
        const ethBalance = await provider.getBalance(FEE_DISTRIBUTOR_ADDRESS)

        // æŸ¥è¯¢ä»£å¸ä½™é¢
        const tokenA = new Contract(TOKEN0_ADDRESS, ERC20_ABI, provider)
        const tokenB = new Contract(TOKEN1_ADDRESS, ERC20_ABI, provider)

        const [tokenABalance, tokenBBalance] = await Promise.all([
          tokenA.balanceOf(FEE_DISTRIBUTOR_ADDRESS),
          tokenB.balanceOf(FEE_DISTRIBUTOR_ADDRESS),
        ])

        setBalance({
          eth: ethBalance,
          tokenA: tokenABalance,
          tokenB: tokenBBalance,
        })
      } catch (err) {
        console.error('Failed to fetch reward pool balance:', err)
      } finally {
        setLoading(false)
      }
    }

    fetchBalance()
    const interval = setInterval(fetchBalance, 30000) // 30 ç§’åˆ·æ–°
    return () => clearInterval(interval)
  }, [])

  if (loading) {
    return (
      <div className="card">
        <div className="skeleton">åŠ è½½ä¸­...</div>
      </div>
    )
  }

  if (!balance) {
    return <div className="card">æ— æ³•åŠ è½½æ•°æ®</div>
  }

  return (
    <div className="card">
      <h3 className="text-lg font-bold mb-3">å¥–åŠ±æ± ä½™é¢</h3>
      
      <div className="space-y-2">
        <div className="flex justify-between">
          <span className="text-gray-600">ETH:</span>
          <span className="font-medium">
            {(Number(balance.eth) / 1e18).toFixed(6)} ETH
          </span>
        </div>
        
        <div className="flex justify-between">
          <span className="text-gray-600">Token A:</span>
          <span className="font-medium">
            {(Number(balance.tokenA) / 1e18).toFixed(2)} TKA
          </span>
        </div>

        <div className="flex justify-between">
          <span className="text-gray-600">Token B:</span>
          <span className="font-medium">
            {(Number(balance.tokenB) / 1e18).toFixed(2)} TKB
          </span>
        </div>
      </div>

      <p className="text-xs text-gray-500 mt-3">
        ğŸ’° å¾…åˆ†å‘å¥–åŠ± Â· å…¬å¼€æ•°æ®ï¼Œä»»ä½•äººå¯è§
      </p>
    </div>
  )
}
```

### 3.3 ä¼˜åŒ–å»ºè®®

- âœ… æ˜¾ç¤º"å·²åˆ†é…æ¯”ä¾‹"ï¼ˆä» Governance ææ¡ˆè®°å½•æŸ¥è¯¢ï¼‰
- âœ… è¿æ¥é’±åŒ…åæ˜¾ç¤º"æˆ‘çš„å¯é¢†å¥–åŠ±"ï¼ˆè°ƒç”¨ `claimable` å‡½æ•°ï¼‰
- âœ… æ˜¾ç¤ºåˆ†é…è§„åˆ™ï¼ˆGovernance å¯æ²»ç†ï¼‰

---

## å››ã€äº¤æ˜“è®°å½•ï¼ˆTrade Historyï¼‰

### 4.1 æ•°æ®æ¥æº

**é“¾ä¸Šäº‹ä»¶æ—¥å¿—**ï¼š
- Settlement åˆçº¦çš„ `TradeSettled` äº‹ä»¶
- AMMPool çš„ `Swap` äº‹ä»¶
- Vault çš„ `Deposit`ã€`Withdraw` äº‹ä»¶

### 4.2 å®ç°ä»£ç 

åˆ›å»º `frontend/src/components/TradeHistory.tsx`ï¼š

```typescript
import { useEffect, useState } from 'react'
import { Contract, EventLog } from 'ethers'
import { getProvider } from '../utils'
import { SETTLEMENT_ADDRESS, SETTLEMENT_ABI } from '../config'
import { shortAddress } from '../utils'

interface Trade {
  blockNumber: number
  timestamp: number
  maker: string
  taker: string
  amount: bigint
  token: string
  txHash: string
}

export function TradeHistory({ limit = 10, filterByAddress }: { limit?: number; filterByAddress?: string }) {
  const [trades, setTrades] = useState<Trade[]>([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    const fetchTrades = async () => {
      try {
        const provider = getProvider()
        if (!provider) return

        const settlement = new Contract(SETTLEMENT_ADDRESS, SETTLEMENT_ABI, provider)

        // æŸ¥è¯¢æœ€è¿‘çš„ TradeSettled äº‹ä»¶
        const currentBlock = await provider.getBlockNumber()
        const fromBlock = Math.max(0, currentBlock - 10000) // æœ€è¿‘ 10000 ä¸ªåŒºå—

        const events = await settlement.queryFilter(
          settlement.filters.TradeSettled(),
          fromBlock,
          'latest'
        )

        const tradeList: Trade[] = []
        for (const event of events.slice(-limit).reverse()) {
          const log = event as EventLog
          const block = await provider.getBlock(log.blockNumber)
          
          // å¦‚æœæŒ‡å®šäº†åœ°å€è¿‡æ»¤ï¼Œåªæ˜¾ç¤ºç›¸å…³äº¤æ˜“
          if (filterByAddress) {
            const maker = log.args.maker?.toLowerCase()
            const taker = log.args.taker?.toLowerCase()
            const filter = filterByAddress.toLowerCase()
            if (maker !== filter && taker !== filter) continue
          }

          tradeList.push({
            blockNumber: log.blockNumber,
            timestamp: block?.timestamp || 0,
            maker: log.args.maker,
            taker: log.args.taker,
            amount: log.args.amount || 0n,
            token: log.args.token || '',
            txHash: log.transactionHash,
          })
        }

        setTrades(tradeList)
      } catch (err) {
        console.error('Failed to fetch trades:', err)
      } finally {
        setLoading(false)
      }
    }

    fetchTrades()
    const interval = setInterval(fetchTrades, 30000) // 30 ç§’åˆ·æ–°
    return () => clearInterval(interval)
  }, [limit, filterByAddress])

  if (loading) {
    return (
      <div className="card">
        <div className="skeleton">åŠ è½½äº¤æ˜“è®°å½•...</div>
      </div>
    )
  }

  return (
    <div className="card">
      <h3 className="text-lg font-bold mb-3">
        {filterByAddress ? 'æˆ‘çš„äº¤æ˜“è®°å½•' : 'æœ€è¿‘äº¤æ˜“è®°å½•ï¼ˆå…¬å¼€ï¼‰'}
      </h3>
      
      {trades.length === 0 ? (
        <p className="text-gray-500 text-sm">æš‚æ— äº¤æ˜“è®°å½•</p>
      ) : (
        <div className="space-y-2">
          {trades.map((trade, i) => (
            <div
              key={i}
              className="border-b pb-2 last:border-b-0 text-sm"
            >
              <div className="flex justify-between items-start">
                <div className="flex-1">
                  <div className="flex items-center gap-2">
                    <span className="text-gray-600">
                      {shortAddress(trade.maker)}
                    </span>
                    <span>â†’</span>
                    <span className="text-gray-600">
                      {shortAddress(trade.taker)}
                    </span>
                  </div>
                  <div className="text-xs text-gray-500 mt-1">
                    {new Date(trade.timestamp * 1000).toLocaleString()}
                  </div>
                </div>
                <div className="text-right">
                  <div className="font-medium">
                    {(Number(trade.amount) / 1e18).toFixed(4)} {trade.token}
                  </div>
                  <a
                    href={`https://sepolia.etherscan.io/tx/${trade.txHash}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-xs text-blue-600 hover:underline"
                  >
                    æŸ¥çœ‹
                  </a>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      <p className="text-xs text-gray-500 mt-3">
        ğŸ“Š å…¬å¼€æ•°æ®ï¼Œä»»ä½•äººå¯è§ Â· æ¯ 30 ç§’è‡ªåŠ¨åˆ·æ–°
      </p>
    </div>
  )
}
```

### 4.3 ä¼˜åŒ–å»ºè®®

- âœ… åˆ†é¡µ / æ— é™æ»šåŠ¨ï¼ˆç”¨ react-query + fromBlock å‚æ•°ï¼‰
- âœ… è¿‡æ»¤ï¼šåªæ˜¾ç¤ºè‡ªå·±åœ°å€çš„äº¤æ˜“ï¼ˆè¿æ¥é’±åŒ…åï¼‰
- âœ… å®æ—¶æ›´æ–°ï¼šç”¨ `useContractEvent` ç›‘å¬æ–°äº‹ä»¶
- âœ… æ‰‹æœºé€‚é…ï¼šå¡ç‰‡å¼ + æ¨ªå‘æ»šåŠ¨æ—¶é—´æˆ³
- âœ… é“¾æ¥åˆ°åŒºå—æµè§ˆå™¨ï¼ˆEtherscanï¼‰

---

## äº”ã€Dashboard é¡µé¢æ•´åˆ

åˆ›å»º `frontend/src/components/Dashboard.tsx`ï¼š

```typescript
import { LiquidityPoolInfo } from './LiquidityPoolInfo'
import { RewardPoolInfo } from './RewardPoolInfo'
import { TradeHistory } from './TradeHistory'
import { useAccount } from 'wagmi' // æˆ–ä½¿ç”¨ä½ çš„é’±åŒ…è¿æ¥é€»è¾‘

export function Dashboard() {
  const { address } = useAccount() // å¦‚æœä½¿ç”¨ wagmi

  return (
    <div className="space-y-4">
      <h2 className="text-2xl font-bold">æ•°æ®æ¦‚è§ˆ</h2>
      
      {/* æµåŠ¨æ€§æ±  */}
      <LiquidityPoolInfo />
      
      {/* å¥–åŠ±æ±  */}
      <RewardPoolInfo />
      
      {/* äº¤æ˜“è®°å½• */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <TradeHistory limit={10} />
        {address && (
          <TradeHistory limit={10} filterByAddress={address} />
        )}
      </div>
    </div>
  )
}
```

---

## å…­ã€å®ç°å»ºè®®

### 6.1 å¸ƒå±€å»ºè®®

**é¦–é¡µæˆ– Dashboard**ï¼š
- æµåŠ¨æ€§æ± ä¿¡æ¯ï¼ˆé¡¶éƒ¨ï¼‰
- å¥–åŠ±æ± ä½™é¢ï¼ˆä¸­é—´ï¼‰
- æœ€è¿‘äº¤æ˜“è®°å½•ï¼ˆåº•éƒ¨ï¼‰

**æœªè¿æ¥é’±åŒ…æ—¶**ï¼š
- æ˜¾ç¤º"å…¬å¼€æ•°æ®"
- æç¤º"è¿æ¥é’±åŒ…åå¯æŸ¥çœ‹ä¸ªäººæ•°æ®"

**è¿æ¥é’±åŒ…å**ï¼š
- åŠ "æˆ‘çš„äº¤æ˜“" tab
- æ˜¾ç¤º"æˆ‘çš„å¯é¢†å¥–åŠ±"

### 6.2 æ‰‹æœºç«¯ä¼˜åŒ–

- âœ… å¡ç‰‡å¸ƒå±€
- âœ… è§¦æ§å‹å¥½ï¼ˆæŒ‰é’® â‰¥48pxï¼‰
- âœ… Loading skeleton
- âœ… æ¨ªå‘æ»šåŠ¨ï¼ˆæ—¶é—´æˆ³ç­‰é•¿æ–‡æœ¬ï¼‰

### 6.3 æ€§èƒ½ä¼˜åŒ–

- âœ… ä½¿ç”¨ `wagmi` çš„ `useContractRead`ï¼ˆè‡ªåŠ¨ç¼“å­˜ï¼‰
- âœ… åˆç†è®¾ç½®åˆ·æ–°é—´éš”ï¼ˆ10-30 ç§’ï¼‰
- âœ… åˆ†é¡µåŠ è½½ï¼ˆé¿å…ä¸€æ¬¡åŠ è½½å¤ªå¤šæ•°æ®ï¼‰

---

## ä¸ƒã€ç›¸å…³æ–‡æ¡£

- [å¿«é€Ÿä¼˜åŒ–å®ç°æŒ‡å—](./å¿«é€Ÿä¼˜åŒ–å®ç°æŒ‡å—.md)
- [ä¼˜åŒ–ä¸æ”¹è¿›æ¸…å•](./ä¼˜åŒ–ä¸æ”¹è¿›æ¸…å•.md)
- [API-æ¥å£è¯´æ˜](./API-æ¥å£è¯´æ˜.md)

---

*æœ¬æ–‡æ¡£æä¾›å…¬å¼€æ•°æ®å±•ç¤ºçš„å®Œæ•´å®ç°æ–¹æ¡ˆï¼Œç¡®ä¿æ‰€æœ‰ç”¨æˆ·éƒ½èƒ½çœ‹åˆ°é€æ˜ã€å®æ—¶çš„é“¾ä¸Šæ•°æ®ã€‚*
