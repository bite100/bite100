# 主网部署指南

本文档说明如何将 比特100 部署到 **Ethereum 主网**（chainId 1）。主网使用真实 ETH 和代币，请务必在测试网充分验证后再部署。**若需更低 gas 成本，可部署到 Polygon 主网**，见 [Polygon 部署指南](./Polygon部署指南.md)。

---

## 一、部署前准备

### 1.1 资金与 Gas

- **主网 Gas**：部署约需 0.02–0.05 ETH（视 gas 价格波动）
- **RPC**：建议使用自有 RPC（如 Alchemy、Infura）以提升稳定性；公开 RPC 可用 `https://ethereum.publicnode.com`
- **私钥**：`contracts/.env` 中 `PRIVATE_KEY` 需有充足 ETH

### 1.2 代币选择

主网 AMM 池需两个真实 ERC20 地址。常见组合：

| 组合 | TOKEN0 | TOKEN1 |
|------|--------|--------|
| USDC/USDT | `0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48` | `0xdAC17F958D2ee523a2206206994597C13D831ec7` |
| WETH/USDC | `0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2` | `0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48` |
| WETH/USDT | `0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2` | `0xdAC17F958D2ee523a2206206994597C13D831ec7` |

部署前可在 [Etherscan](https://etherscan.io) 确认地址正确。

### 1.3 环境变量

在 `contracts` 目录下编辑 `.env`：

```bash
PRIVATE_KEY=0x你的主网部署私钥
MAINNET_RPC_URL=https://ethereum.publicnode.com   # 可选，默认为此
FEE_RECIPIENT=0x...   # 可选，默认部署者 100%
```

---

## 二、一键部署

### 2.1 执行部署脚本

```powershell
cd contracts

# 设置 AMM 池的两代币地址（必填）
$env:TOKEN0_ADDRESS = "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48"   # USDC
$env:TOKEN1_ADDRESS = "0xdAC17F958D2ee523a2206206994597C13D831ec7"   # USDT

.\scripts\deploy-mainnet.ps1
```

脚本会提示输入 `YES` 确认。部署成功后终端会输出各合约地址。

### 2.2 部署内容

一次部署将创建：

- Vault、FeeDistributor、Settlement
- AMMPool（使用你指定的 TOKEN0/TOKEN1）
- ContributorReward、Governance
- TokenRegistry、ChainConfig

并完成：Vault 绑定 Settlement、FeeDistributor 设置接收方、Governance 绑定各目标合约。

---

## 三、前端配置

### 3.1 填入主网合约地址

编辑 `frontend/src/config.ts`，在 `MAINNET` 对象中填入部署输出的地址：

```typescript
const MAINNET = {
  VAULT: '0x...',
  SETTLEMENT: '0x...',
  TOKEN0: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',  // 与部署时一致
  TOKEN1: '0xdAC17F958D2ee523a2206206994597C13D831ec7',
  AMM_POOL: '0x...',
  CONTRIBUTOR_REWARD: '0x...',
  GOVERNANCE: '0x...',
  TOKEN_REGISTRY: '0x...',
  CHAIN_CONFIG: '0x...',
}
```

### 3.2 构建主网版本

```bash
cd frontend
npm run build:mainnet
```

生成的 `dist/` 仅连接主网，可部署到 Vercel、Netlify 等。

### 3.3 本地调试主网

```bash
# 开发模式连接主网（慎用，避免误操作）
cross-env VITE_NETWORK=mainnet npm run dev
```

---

## 四、部署后操作

### 4.1 添加流动性

主网 AMM 池初始为空，需有人添加流动性后才能 Swap：

- 前端：连接主网 → 切换到主网 → 在「添加流动性」中填入数量并操作
- 或使用 cast：对 TOKEN0/TOKEN1 先 `approve` AMM 池，再调用 `addLiquidity(amount0, amount1)`

### 4.2 验证合约（7.1，可选）

使用 `contracts/scripts/verify-contracts.ps1` 批量验证：

```powershell
cd contracts
$env:ETHERSCAN_API_KEY = "从 etherscan.io 获取的 API Key"
.\scripts\verify-contracts.ps1
```

脚本会验证 Vault、FeeDistributor、Settlement。或部署时添加 `--verify`：

```powershell
forge script script/Deploy.s.sol:Deploy --sig "runMainnetFull()" --rpc-url $rpc --broadcast --verify
```

### 4.3 治理

- 活跃集、merkletool、创建提案、投票、执行流程与 Sepolia 相同
- 详见 [治理部署与提案执行指南](./治理部署与提案执行指南.md)

---

## 五、安全与注意事项

1. **私钥**：切勿将 `.env` 提交到版本库；生产环境优先使用 HSM 或 KMS
2. **测试**：主网部署前务必在 Sepolia 完整跑通流程
3. **审计**：生产环境建议对合约进行安全审计
4. **Gas**：部署前查看主网 gas 价格，避免高峰期部署
5. **代币**：确认 TOKEN0/TOKEN1 为官方合约，避免仿盘

---

## 六、常见问题

**Q：部署失败，提示 gas 不足？**  
A：检查部署钱包 ETH 余额，主网部署约需 0.02–0.05 ETH。

**Q：AMM 池添加流动性失败？**  
A：确保已对 AMM 池地址 `approve` 足够额度，且代币余额充足。

**Q：前端如何切换主网/测试网？**  
A： build 时通过 `VITE_NETWORK=mainnet` 决定；运行时不可切换，需分别构建两个版本。
